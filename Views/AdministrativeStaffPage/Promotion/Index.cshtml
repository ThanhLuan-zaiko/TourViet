@{
    ViewData["Title"] = "Quản lý Khuyến mãi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model TourViet.ViewModels.PromotionDashboardViewModel

<style>
    .promotion-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .promotion-card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .promotion-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 12px;
        padding: 1.5rem;
        color: white;
        margin-bottom: 1rem;
    }
    
    .stats-card-2 {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .stats-card-3 {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .stats-card-4 {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .badge-custom {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .btn-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-gradient:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .search-box {
        border-radius: 25px;
        border: 2px solid #e0e7ff;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
    }
    
    .search-box:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .table-modern thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .table-modern thead th {
        border: none;
        padding: 1rem;
        font-weight: 600;
    }
    
    .table-modern tbody tr {
        transition: all 0.3s ease;
    }
    
    .table-modern tbody tr:hover {
        background-color: #f8f9ff;
        transform: scale(1.01);
    }
    
    .action-btn {
        border-radius: 8px;
        padding: 0.4rem 1rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
</style>

<div class="container-fluid">
    <!-- Header Section -->
    <div class="promotion-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">
                    <i class="bi bi-percent-fill me-2"></i>
                    Quản lý Chương trình Khuyến mãi
                </h1>
                <p class="mb-0 opacity-75">Tạo và quản lý các chương trình khuyến mãi, giảm giá cho tours</p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <a asp-action="Create" asp-controller="Promotion" class="btn btn-light btn-lg">
                    <i class="fas fa-plus-circle me-2"></i>Tạo khuyến mãi mới
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1">@Model.TotalPromotions</h3>
                        <p class="mb-0 opacity-75">Tổng chương trình</p>
                    </div>
                    <i class="bi bi-clipboard-data" style="font-size: 3rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1">@Model.ActivePromotions</h3>
                        <p class="mb-0 opacity-75">Đang hoạt động</p>
                    </div>
                    <i class="bi bi-check-circle-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1">@Model.TotalRedemptions</h3>
                        <p class="mb-0 opacity-75">Tổng lượt sử dụng</p>
                    </div>
                    <i class="bi bi-graph-up-arrow" style="font-size: 3rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1">@Model.TotalDiscountAmount.ToString("N0") VND</h3>
                        <p class="mb-0 opacity-75">Tổng giảm giá</p>
                    </div>
                    <i class="bi bi-cash-coin" style="font-size: 3rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Promotions -->
    @if (Model.TopPromotions.Any())
    {
        <div class="card promotion-card mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0 text-primary">
                    <i class="bi bi-trophy-fill me-2"></i>Top 5 Khuyến mãi hiệu quả nhất
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Tên chương trình</th>
                                <th class="text-center">Lượt sử dụng</th>
                                <th class="text-end">Tổng giảm giá</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var promo in Model.TopPromotions)
                            {
                                <tr>
                                    <td>
                                        <a asp-action="Edit" asp-route-id="@promo.PromotionID" class="text-decoration-none fw-bold">
                                            @promo.Name
                                        </a>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">@promo.RedemptionCount</span>
                                    </td>
                                    <td class="text-end text-success fw-bold">
                                        @promo.TotalDiscount.ToString("N0") @promo.Currency
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Promotions List -->
    <!-- Main Content Card -->
    <div class="promotion-card card mb-4">
        <div class="card-body p-4">
            <!-- Success Message -->
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            
            <!-- Search and Filter -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3 mb-md-0">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-primary"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control border-start-0 search-box" 
                               placeholder="Tìm kiếm theo tên, loại chương trình..." />
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex justify-content-md-end gap-2">
                        <select id="entriesPerPage" class="form-select" style="width: auto;">
                            <option value="10">10 mục</option>
                            <option value="25" selected>25 mục</option>
                            <option value="50">50 mục</option>
                            <option value="100">100 mục</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-modern table-hover" id="promotionsTable">
                    <thead>
                        <tr>
                            <th><i class="bi bi-tag-fill me-2"></i>Tên chương trình</th>
                            <th><i class="bi bi-tags-fill me-2"></i>Loại</th>
                            <th><i class="bi bi-calendar-event me-2"></i>Bắt đầu</th>
                            <th><i class="bi bi-calendar-x me-2"></i>Kết thúc</th>
                            <th><i class="bi bi-activity me-2"></i>Trạng thái</th>
                            <th><i class="bi bi-star-fill me-2"></i>Ưu tiên</th>
                            <th><i class="bi bi-clock-history me-2"></i>Ngày tạo</th>
                            <th><i class="bi bi-gear-fill me-2"></i>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Promotions.Any())
                        {
                            @foreach (var promotion in Model.Promotions)
                            {
                                <tr>
                                    <td>
                                        <strong class="text-dark">@promotion.Name</strong>
                                        @if (!string.IsNullOrEmpty(promotion.Description))
                                        {
                                            <br/><small class="text-muted">@(promotion.Description.Length > 50 ? promotion.Description.Substring(0, 50) + "..." : promotion.Description)</small>
                                        }
                                    </td>
                                    <td>
                                        @if (promotion.PromotionType == "Coupon")
                                        {
                                            <span class="badge bg-primary badge-custom"><i class="bi bi-ticket-perforated me-1"></i>Coupon</span>
                                        }
                                        else if (promotion.PromotionType == "Automatic")
                                        {
                                            <span class="badge bg-success badge-custom"><i class="bi bi-lightning-fill me-1"></i>Tự động</span>
                                        }
                                        else if (promotion.PromotionType == "FlashSale")
                                        {
                                            <span class="badge bg-danger badge-custom"><i class="bi bi-fire me-1"></i>Flash Sale</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary badge-custom">@promotion.PromotionType</span>
                                        }
                                    </td>
                                    <td>
                                        @if (promotion.StartAt.HasValue)
                                        {
                                            <span>@promotion.StartAt.Value.ToString("dd/MM/yyyy")</span>
                                            <br/><small class="text-muted">@promotion.StartAt.Value.ToString("HH:mm")</small>
                                        }
                                        else
                                        {
                                            <span class="text-muted"><i class="bi bi-infinity me-1"></i>Không giới hạn</span>
                                        }
                                    </td>
                                    <td>
                                        @if (promotion.EndAt.HasValue)
                                        {
                                            <span>@promotion.EndAt.Value.ToString("dd/MM/yyyy")</span>
                                            <br/><small class="text-muted">@promotion.EndAt.Value.ToString("HH:mm")</small>
                                        }
                                        else
                                        {
                                            <span class="text-muted"><i class="bi bi-infinity me-1"></i>Không giới hạn</span>
                                        }
                                    </td>
                                    <td>
                                        @if (promotion.IsActive)
                                        {
                                            var now = DateTime.UtcNow;
                                            var isActive = (!promotion.StartAt.HasValue || promotion.StartAt.Value <= now) && 
                                                           (!promotion.EndAt.HasValue || promotion.EndAt.Value >= now);
                                            @if (isActive)
                                            {
                                                <span class="badge bg-success badge-custom">
                                                    <i class="bi bi-check-circle-fill me-1"></i>Hoạt động
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning text-dark badge-custom">
                                                    <i class="bi bi-clock-fill me-1"></i>Chưa bắt đầu/Hết hạn
                                                </span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary badge-custom">
                                                <i class="bi bi-pause-circle-fill me-1"></i>Tạm ngừng
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-info text-dark badge-custom">
                                            <i class="bi bi-sort-numeric-down me-1"></i>@promotion.Priority
                                        </span>
                                    </td>
                                    <td>
                                        <span>@promotion.CreatedAt.ToString("dd/MM/yyyy")</span>
                                        <br/><small class="text-muted">@promotion.CreatedAt.ToString("HH:mm")</small>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-2">
                                            <a asp-action="Edit" asp-controller="Promotion" asp-route-id="@promotion.PromotionID" 
                                               class="btn btn-sm btn-primary action-btn">
                                                <i class="bi bi-pencil-square me-1"></i>Sửa
                                            </a>
                                            <button type="button" class="btn btn-sm btn-danger action-btn delete-promotion-btn" 
                                                    data-promotion-id="@promotion.PromotionID" data-promotion-name="@promotion.Name">
                                                <i class="bi bi-trash3 me-1"></i>Xóa
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <i class="bi bi-inbox" style="font-size: 4rem; color: #ddd;"></i>
                                    <p class="text-muted mt-3">Chưa có chương trình khuyến mãi nào</p>
                                    <a asp-action="Create" asp-controller="Promotion" class="btn btn-gradient mt-2">
                                        <i class="bi bi-plus-circle me-2"></i>Tạo chương trình đầu tiên
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Xác nhận xóa
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="mb-0">Bạn có chắc chắn muốn xóa chương trình khuyến mãi <strong class="text-danger" id="promotionNameToDelete"></strong> không?</p>
                <p class="text-muted small mt-2 mb-0">Hành động này không thể hoàn tác.</p>
                <input type="hidden" id="promotionIdToDelete" />
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Hủy
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bi bi-trash3 me-1"></i>Xóa chương trình
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-hide success alerts after 5 seconds
        setTimeout(function() {
            var alert = document.querySelector('.alert');
            if (alert) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
        
        // Simple table search and pagination without DataTables
        document.addEventListener('DOMContentLoaded', function() {
            const table = document.getElementById('promotionsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const searchInput = document.getElementById('searchInput');
            const entriesSelect = document.getElementById('entriesPerPage');
            
            let currentPage = 1;
            let rowsPerPage = 25;
            let filteredRows = rows;
            
            // Search functionality
            searchInput.addEventListener('keyup', function() {
                const searchTerm = this.value.toLowerCase();
                filteredRows = rows.filter(row => {
                    const text = row.textContent.toLowerCase();
                    const matches = text.includes(searchTerm);
                    row.style.display = matches ? '' : 'none';
                    return matches;
                });
                currentPage = 1;
                updatePagination();
            });
            
            // Entries per page
            entriesSelect.addEventListener('change', function() {
                rowsPerPage = parseInt(this.value);
                currentPage = 1;
                updatePagination();
            });
            
            function updatePagination() {
                const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;
                
                rows.forEach(row => row.style.display = 'none');
                filteredRows.slice(start, end).forEach(row => row.style.display = '');
            }
            
            // Initial pagination
            updatePagination();
            
            // Handle delete button click
            document.querySelectorAll('.delete-promotion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const promotionId = this.getAttribute('data-promotion-id');
                    const promotionName = this.getAttribute('data-promotion-name');
                    
                    document.getElementById('promotionIdToDelete').value = promotionId;
                    document.getElementById('promotionNameToDelete').textContent = promotionName;
                    
                    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    modal.show();
                });
            });
            
            // Handle delete confirmation with AJAX
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                const promotionId = document.getElementById('promotionIdToDelete').value;
                if(promotionId) {
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    
                    fetch('@Url.Action("DeleteConfirmed", "Promotion")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'id': promotionId,
                            '__RequestVerificationToken': token
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.success) {
                            // Remove old alerts
                            document.querySelectorAll('.alert').forEach(el => el.remove());
                            
                            // Add success message
                            const cardBody = document.querySelector('.promotion-card .card-body');
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-success alert-dismissible fade show';
                            alertDiv.setAttribute('role', 'alert');
                            alertDiv.innerHTML = `
                                <i class="bi bi-check-circle-fill me-2"></i>
                                ${data.message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            `;
                            cardBody.insertBefore(alertDiv, cardBody.firstChild);
                            
                            // Hide modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                            modal.hide();
                            
                            // Reload page to update stats
                            setTimeout(function() {
                                location.reload();
                            }, 1500);
                        } else {
                            alert(data.message || 'Có lỗi xảy ra khi xóa chương trình khuyến mãi.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra khi xóa chương trình khuyến mãi.');
                    });
                }
            });
        });
    </script>
}
