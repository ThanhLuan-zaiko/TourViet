@{
    ViewData["Title"] = "Ch·ªânh s·ª≠a Khuy·∫øn m√£i";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model TourViet.Models.Promotion

<style>
    .edit-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 15px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3);
    }
    
    .form-card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    
    .section-title {
        color: #f5576c;
        font-weight: 600;
        border-bottom: 2px solid #ffe0ec;
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;  
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-label {
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e5e7eb;
        padding: 0.65rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #f5576c;
        box-shadow: 0 0 0 3px rgba(245, 87, 108, 0.1);
    }
    
    .btn-gradient {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        padding: 0.75rem 2rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-gradient:hover {
        background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
    }
    
    .info-badge {
        background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%);
        border-left: 4px solid #6366f1;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .nav-tabs .nav-link {
        color: #6c757d;
        font-weight: 500;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 1rem 1.5rem;
    }

    .nav-tabs .nav-link.active {
        color: #f5576c;
        border-bottom: 3px solid #f5576c;
        background: none;
    }

    .nav-tabs .nav-link:hover {
        border-color: transparent;
        color: #f5576c;
    }
    
    .tab-content {
        padding-top: 2rem;
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="edit-header">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="h2 mb-2">
                    <i class="bi bi-pencil-square me-2"></i>
                    Ch·ªânh s·ª≠a Ch∆∞∆°ng tr√¨nh Khuy·∫øn m√£i
                </h1>
                <p class="mb-0 opacity-75">C·∫≠p nh·∫≠t th√¥ng tin v√† qu·∫£n l√Ω quy t·∫Øc, ƒë·ªëi t∆∞·ª£ng √°p d·ª•ng</p>
            </div>
            <a asp-action="Index" asp-controller="Promotion" class="btn btn-light">
                <i class="bi bi-arrow-left me-2"></i>Quay l·∫°i
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="form-card card">
        <div class="card-header bg-white border-bottom-0 pt-4 px-4">
            <ul class="nav nav-tabs" id="promotionTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">
                        <i class="bi bi-info-circle me-2"></i>Th√¥ng tin chung
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" type="button" role="tab" aria-controls="rules" aria-selected="false">
                        <i class="bi bi-list-check me-2"></i>Quy t·∫Øc gi·∫£m gi√°
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="targets-tab" data-bs-toggle="tab" data-bs-target="#targets" type="button" role="tab" aria-controls="targets" aria-selected="false">
                        <i class="bi bi-bullseye me-2"></i>ƒê·ªëi t∆∞·ª£ng √°p d·ª•ng
                    </button>
                </li>
                @if (Model.PromotionType == "Coupon")
                {
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="coupons-tab" data-bs-toggle="tab" data-bs-target="#coupons" type="button" role="tab" aria-controls="coupons" aria-selected="false">
                            <i class="bi bi-ticket-perforated me-2"></i>M√£ gi·∫£m gi√°
                        </button>
                    </li>
                }
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">
                        <i class="bi bi-clock-history me-2"></i>L·ªãch s·ª≠ s·ª≠ d·ª•ng
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="card-body p-4">
            <div class="tab-content" id="promotionTabsContent">
                
                <!-- Tab 1: General Info -->
                <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                    <form asp-action="Edit" asp-controller="Promotion" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="PromotionID" />
                        <input type="hidden" asp-for="CreatedAt" />
                        
                        <!-- Info Badge -->
                        <div class="info-badge mb-4">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-info-circle-fill text-primary me-2" style="font-size: 1.25rem;"></i>
                                <div>
                                    <strong>Ch∆∞∆°ng tr√¨nh ƒë∆∞·ª£c t·∫°o:</strong> @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                    @if (Model.UpdatedAt.HasValue)
                                    {
                                        <br /><strong>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:</strong> @Model.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <!-- Basic Information Section -->
                        <div class="section-title">
                            <i class="bi bi-info-circle-fill"></i>
                            <span>Th√¥ng tin c∆° b·∫£n</span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Name" class="form-label">
                                    <i class="bi bi-tag me-1 text-primary"></i>
                                    T√™n ch∆∞∆°ng tr√¨nh <span class="text-danger">*</span>
                                </label>
                                <input asp-for="Name" class="form-control" placeholder="Nh·∫≠p t√™n ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i" required />
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="Slug" class="form-label">
                                    <i class="bi bi-link-45deg me-1 text-primary"></i>
                                    Slug (URL th√¢n thi·ªán)
                                </label>
                                <input asp-for="Slug" class="form-control" placeholder="T·ª± ƒë·ªông t·∫°o n·∫øu ƒë·ªÉ tr·ªëng" />
                                <span asp-validation-for="Slug" class="text-danger"></span>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-info-circle me-1"></i>
                                    ƒê·ªÉ tr·ªëng ƒë·ªÉ t·ª± ƒë·ªông t·∫°o t·ª´ t√™n ch∆∞∆°ng tr√¨nh
                                </small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="PromotionType" class="form-label">
                                    <i class="bi bi-tags me-1 text-primary"></i>
                                    Lo·∫°i khuy·∫øn m√£i <span class="text-danger">*</span>
                                </label>
                                <select asp-for="PromotionType" class="form-select" required>
                                    <option value="">-- Ch·ªçn lo·∫°i khuy·∫øn m√£i --</option>
                                    <option value="Coupon">üé´ M√£ gi·∫£m gi√° (Coupon)</option>
                                    <option value="Automatic">‚ö° T·ª± ƒë·ªông √°p d·ª•ng</option>
                                    <option value="FlashSale">üî• Flash Sale</option>
                                </select>
                                <span asp-validation-for="PromotionType" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="Priority" class="form-label">
                                    <i class="bi bi-sort-numeric-down me-1 text-primary"></i>
                                    ƒê·ªô ∆∞u ti√™n
                                </label>
                                <input asp-for="Priority" type="number" class="form-control" min="1" max="1000" />
                                <span asp-validation-for="Priority" class="text-danger"></span>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-info-circle me-1"></i>
                                    S·ªë nh·ªè = ∆∞u ti√™n cao h∆°n (1-1000)
                                </small>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label asp-for="Description" class="form-label">
                                <i class="bi bi-file-text me-1 text-primary"></i>
                                M√¥ t·∫£ chi ti·∫øt
                            </label>
                            <textarea asp-for="Description" class="form-control" rows="4" 
                                      placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>
                        
                        <!-- Time Configuration Section -->
                        <div class="section-title mt-4">
                            <i class="bi bi-calendar-range-fill"></i>
                            <span>C·∫•u h√¨nh th·ªùi gian</span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="StartAt" class="form-label">
                                    <i class="bi bi-calendar-event me-1 text-success"></i>
                                    Ng√†y b·∫Øt ƒë·∫ßu
                                </label>
                                <input asp-for="StartAt" type="datetime-local" class="form-control" />
                                <span asp-validation-for="StartAt" class="text-danger"></span>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-info-circle me-1"></i>
                                    ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng gi·ªõi h·∫°n th·ªùi gian b·∫Øt ƒë·∫ßu
                                </small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="EndAt" class="form-label">
                                    <i class="bi bi-calendar-x me-1 text-danger"></i>
                                    Ng√†y k·∫øt th√∫c
                                </label>
                                <input asp-for="EndAt" type="datetime-local" class="form-control" />
                                <span asp-validation-for="EndAt" class="text-danger"></span>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-info-circle me-1"></i>
                                    ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng gi·ªõi h·∫°n th·ªùi gian k·∫øt th√∫c
                                </small>
                            </div>
                        </div>
                        
                        <!-- Usage Limits Section -->
                        <div class="section-title mt-4">
                            <i class="bi bi-graph-up-arrow"></i>
                            <span>Gi·ªõi h·∫°n s·ª≠ d·ª•ng</span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="MaxGlobalUses" class="form-label">
                                    <i class="bi bi-globe me-1 text-primary"></i>
                                    S·ªë l·∫ßn s·ª≠ d·ª•ng t·ªëi ƒëa (To√†n c·ª•c)
                                </label>
                                <input asp-for="MaxGlobalUses" type="number" class="form-control" min="0" placeholder="Kh√¥ng gi·ªõi h·∫°n" />
                                <span asp-validation-for="MaxGlobalUses" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label asp-for="MaxUsesPerUser" class="form-label">
                                    <i class="bi bi-person me-1 text-primary"></i>
                                    S·ªë l·∫ßn s·ª≠ d·ª•ng/ng∆∞·ªùi
                                </label>
                                <input asp-for="MaxUsesPerUser" type="number" class="form-control" min="0" placeholder="Kh√¥ng gi·ªõi h·∫°n" />
                                <span asp-validation-for="MaxUsesPerUser" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label asp-for="MinSeats" class="form-label">
                                    <i class="bi bi-people me-1 text-primary"></i>
                                    S·ªë gh·∫ø t·ªëi thi·ªÉu
                                </label>
                                <input asp-for="MinSeats" type="number" class="form-control" min="0" placeholder="Kh√¥ng y√™u c·∫ßu" />
                                <span asp-validation-for="MinSeats" class="text-danger"></span>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="MinTotalAmount" class="form-label">
                                    <i class="bi bi-cash-coin me-1 text-success"></i>
                                    Gi√° tr·ªã ƒë∆°n h√†ng t·ªëi thi·ªÉu (VND)
                                </label>
                                <input asp-for="MinTotalAmount" type="number" step="0.01" class="form-control" min="0" placeholder="Kh√¥ng y√™u c·∫ßu" />
                                <span asp-validation-for="MinTotalAmount" class="text-danger"></span>
                            </div>
                        </div>
                        
                        <!-- Settings Section -->
                        <div class="section-title mt-4">
                            <i class="bi bi-gear-fill"></i>
                            <span>C√†i ƒë·∫∑t</span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input asp-for="IsActive" class="form-check-input" type="checkbox" role="switch" style="width: 3em; height: 1.5em;" />
                                    <label asp-for="IsActive" class="form-check-label ms-2">
                                        <i class="bi bi-toggle-on text-success me-1"></i>
                                        K√≠ch ho·∫°t ch∆∞∆°ng tr√¨nh
                                    </label>
                                </div>
                                <small class="text-muted d-block mt-1 ms-5">
                                    Ch∆∞∆°ng tr√¨nh s·∫Ω ho·∫°t ƒë·ªông trong kho·∫£ng th·ªùi gian ƒë√£ ƒë·ªãnh
                                </small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input asp-for="AllowStack" class="form-check-input" type="checkbox" role="switch" style="width: 3em; height: 1.5em;" />
                                    <label asp-for="AllowStack" class="form-check-label ms-2">
                                        <i class="bi bi-layers text-info me-1"></i>
                                        Cho ph√©p c·ªông d·ªìn khuy·∫øn m√£i
                                    </label>
                                </div>
                                <small class="text-muted d-block mt-1 ms-5">
                                    Cho ph√©p s·ª≠ d·ª•ng c√πng l√∫c v·ªõi c√°c khuy·∫øn m√£i kh√°c
                                </small>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="mt-5 pt-4 border-top">
                            <div class="d-flex gap-3">
                                <button type="submit" class="btn btn-gradient btn-lg">
                                    <i class="bi bi-check-circle me-2"></i>C·∫≠p nh·∫≠t ch∆∞∆°ng tr√¨nh
                                </button>
                                <a asp-action="Index" asp-controller="Promotion" class="btn btn-outline-secondary btn-lg">
                                    <i class="bi bi-x-circle me-2"></i>H·ªßy b·ªè
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Tab 2: Rules -->
                <div class="tab-pane fade" id="rules" role="tabpanel" aria-labelledby="rules-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="text-primary mb-0">Danh s√°ch quy t·∫Øc gi·∫£m gi√°</h5>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                            <i class="bi bi-plus-circle me-1"></i>Th√™m quy t·∫Øc
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Lo·∫°i quy t·∫Øc</th>
                                    <th>Gi√° tr·ªã</th>
                                    <th>ƒêi·ªÅu ki·ªán</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.PromotionRules != null && Model.PromotionRules.Any())
                                {
                                    foreach (var rule in Model.PromotionRules)
                                    {
                                        <tr>
                                            <td>
                                                @if (rule.RuleType == "Percent") { <span class="badge bg-info">Ph·∫ßn trƒÉm (%)</span> }
                                                else if (rule.RuleType == "Fixed") { <span class="badge bg-success">S·ªë ti·ªÅn c·ªë ƒë·ªãnh</span> }
                                                else { <span class="badge bg-secondary">@rule.RuleType</span> }
                                            </td>
                                            <td>
                                                @if (rule.RuleType == "Percent") { <strong>@rule.Value.ToString("0")%</strong> }
                                                else { <strong>@rule.Value.ToString("N0") VND</strong> }
                                            </td>
                                            <td>@(rule.Conditions ?? "Kh√¥ng c√≥")</td>
                                            <td>
                                                <button class="btn btn-danger btn-sm delete-rule-btn" data-id="@rule.RuleID">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">Ch∆∞a c√≥ quy t·∫Øc n√†o ƒë∆∞·ª£c thi·∫øt l·∫≠p</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tab 3: Targets -->
                <div class="tab-pane fade" id="targets" role="tabpanel" aria-labelledby="targets-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="text-primary mb-0">ƒê·ªëi t∆∞·ª£ng √°p d·ª•ng</h5>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTargetModal">
                            <i class="bi bi-plus-circle me-1"></i>Th√™m ƒë·ªëi t∆∞·ª£ng
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Lo·∫°i ƒë·ªëi t∆∞·ª£ng</th>
                                    <th>ID ƒê·ªëi t∆∞·ª£ng (N·∫øu c√≥)</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.PromotionTargets != null && Model.PromotionTargets.Any())
                                {
                                    foreach (var target in Model.PromotionTargets)
                                    {
                                        <tr>
                                            <td>
                                                @if (target.TargetType == "All") { <span class="badge bg-success">T·∫•t c·∫£ Tours</span> }
                                                else if (target.TargetType == "Tour") { <span class="badge bg-primary">Tour c·ª• th·ªÉ</span> }
                                                else if (target.TargetType == "Category") { <span class="badge bg-info">Danh m·ª•c</span> }
                                                else { <span class="badge bg-secondary">@target.TargetType</span> }
                                            </td>
                                            <td>@(target.TargetID.HasValue ? target.TargetID.ToString() : "N/A")</td>
                                            <td>
                                                <button class="btn btn-danger btn-sm delete-target-btn" data-id="@target.PromotionTargetID">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">Ch∆∞a c√≥ ƒë·ªëi t∆∞·ª£ng √°p d·ª•ng n√†o (M·∫∑c ƒë·ªãnh √°p d·ª•ng cho t·∫•t c·∫£ n·∫øu tr·ªëng)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tab 4: Coupons (Conditional) -->
                @if (Model.PromotionType == "Coupon")
                {
                    <div class="tab-pane fade" id="coupons" role="tabpanel" aria-labelledby="coupons-tab">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="text-primary mb-0">Qu·∫£n l√Ω M√£ gi·∫£m gi√°</h5>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#generateCouponsModal">
                                <i class="bi bi-magic me-1"></i>Sinh m√£ t·ª± ƒë·ªông
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>M√£ Coupon</th>
                                        <th>Tr·∫°ng th√°i</th>
                                        <th>ƒê√£ d√πng</th>
                                        <th>H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.Coupons != null && Model.Coupons.Any())
                                    {
                                        foreach (var coupon in Model.Coupons.Take(50)) // Limit display
                                        {
                                            <tr>
                                                <td><code class="fs-6">@coupon.Code</code></td>
                                                <td>
                                                    @if (coupon.IsActive) { <span class="badge bg-success">Ho·∫°t ƒë·ªông</span> }
                                                    else { <span class="badge bg-secondary">V√¥ hi·ªáu</span> }
                                                </td>
                                                <td>@coupon.UsageCount</td>
                                                <td>
                                                    <button class="btn btn-danger btn-sm delete-coupon-btn" data-id="@coupon.CouponID">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                        @if (Model.Coupons.Count > 50)
                                        {
                                            <tr>
                                                <td colspan="4" class="text-center text-muted">... v√† @(Model.Coupons.Count - 50) m√£ kh√°c ...</td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">Ch∆∞a c√≥ m√£ gi·∫£m gi√° n√†o ƒë∆∞·ª£c t·∫°o</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
                
                <!-- Tab 5: History -->
                <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="text-primary mb-0">L·ªãch s·ª≠ s·ª≠ d·ª•ng khuy·∫øn m√£i</h5>
                    </div>
                    
                    <!-- Filter Panel -->
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-search me-1"></i>T√¨m ki·∫øm</label>
                                    <input type="text" id="historySearch" class="form-control" placeholder="T√¨m theo t√™n, email ng∆∞·ªùi d√πng...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><i class="bi bi-filter me-1"></i>Tr·∫°ng th√°i</label>
                                    <select id="historyStatusFilter" class="form-select">
                                        <option value="">T·∫•t c·∫£</option>
                                        <option value="Applied">Th√†nh c√¥ng</option>
                                        <option value="Voided">ƒê√£ h·ªßy</option>
                                        <option value="Expired">H·∫øt h·∫°n</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><i class="bi bi-sort-down me-1"></i>S·∫Øp x·∫øp</label>
                                    <select id="historySortFilter" class="form-select">
                                        <option value="desc">M·ªõi nh·∫•t</option>
                                        <option value="asc">C≈© nh·∫•t</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Ng∆∞·ªùi d√πng</th>
                                    <th>Th·ªùi gian</th>
                                    <th>S·ªë ti·ªÅn gi·∫£m</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Ghi ch√∫</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.PromotionRedemptions != null && Model.PromotionRedemptions.Any())
                                {
                                    foreach (var redemption in Model.PromotionRedemptions.OrderByDescending(r => r.AppliedAt).Take(50))
                                    {
                                        <tr>
                                            <td>
                                                @if (redemption.User != null)
                                                {
                                                    <div class="d-flex align-items-center">
                                                        <div class="ms-2">
                                                            <div class="fw-bold">@redemption.User.FullName</div>
                                                            <div class="small text-muted">@redemption.User.Email</div>
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Kh√°ch v√£ng lai</span>
                                                }
                                            </td>
                                            <td>@redemption.AppliedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td class="text-success fw-bold">-@redemption.DiscountAmount.ToString("N0") @redemption.Currency</td>
                                            <td>
                                                @if (redemption.Status == "Applied") { <span class="badge bg-success">Th√†nh c√¥ng</span> }
                                                else if (redemption.Status == "Voided") { <span class="badge bg-danger">ƒê√£ h·ªßy</span> }
                                                else { <span class="badge bg-secondary">@redemption.Status</span> }
                                            </td>
                                            <td>@redemption.Notes</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">Ch∆∞a c√≥ l∆∞·ª£t s·ª≠ d·ª•ng n√†o</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>

<!-- Modals -->

<!-- Add Rule Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Th√™m quy t·∫Øc gi·∫£m gi√°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addRuleForm">
                    <input type="hidden" name="promotionId" value="@Model.PromotionID" />
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i quy t·∫Øc</label>
                        <select name="ruleType" class="form-select" required>
                            <option value="Percent">Ph·∫ßn trƒÉm (%)</option>
                            <option value="Fixed">S·ªë ti·ªÅn c·ªë ƒë·ªãnh (VND)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gi√° tr·ªã</label>
                        <input type="number" name="value" class="form-control" required min="0" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ƒêi·ªÅu ki·ªán (T√πy ch·ªçn)</label>
                        <input type="text" name="conditions" class="form-control" placeholder="JSON conditions e.g. {min: 2}" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="saveRuleBtn">L∆∞u quy t·∫Øc</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Target Modal -->
<div class="modal fade" id="addTargetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Th√™m ƒë·ªëi t∆∞·ª£ng √°p d·ª•ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTargetForm">
                    <input type="hidden" name="promotionId" value="@Model.PromotionID" />
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i ƒë·ªëi t∆∞·ª£ng</label>
                        <select name="targetType" class="form-select" required id="targetTypeSelect">
                            <option value="All">T·∫•t c·∫£ Tours</option>
                            <option value="Tour">Tour c·ª• th·ªÉ</option>
                            <option value="Category">Danh m·ª•c Tour</option>
                        </select>
                    </div>
                    <div class="mb-3" id="targetIdGroup" style="display:none;">
                        <label class="form-label">ID ƒê·ªëi t∆∞·ª£ng</label>
                        <input type="text" name="targetId" class="form-control" placeholder="Nh·∫≠p ID Tour ho·∫∑c Category" />
                        <small class="text-muted">Nh·∫≠p GUID c·ªßa Tour ho·∫∑c Category</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="saveTargetBtn">L∆∞u ƒë·ªëi t∆∞·ª£ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Coupons Modal -->
<div class="modal fade" id="generateCouponsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sinh m√£ gi·∫£m gi√° t·ª± ƒë·ªông</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="generateCouponsForm">
                    <input type="hidden" name="promotionId" value="@Model.PromotionID" />
                    <div class="mb-3">
                        <label class="form-label">S·ªë l∆∞·ª£ng m√£</label>
                        <input type="number" name="quantity" class="form-control" value="10" min="1" max="1000" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ti·ªÅn t·ªë (Prefix)</label>
                        <input type="text" name="prefix" class="form-control" placeholder="VD: SALE2024" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ƒê·ªô d√†i m√£ ng·∫´u nhi√™n</label>
                        <input type="number" name="length" class="form-control" value="8" min="4" max="20" required />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="generateCouponsBtn">Sinh m√£</button>
            </div>
        </div>
    </div>
</div>

<!-- Result Notification Modal -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0" id="resultModalHeader">
                <h5 class="modal-title text-white" id="resultModalTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div id="resultModalIcon" class="mb-3" style="font-size: 3.5rem;"></div>
                <p id="resultModalMessage" class="mb-0 fs-5"></p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // DateTime Local Formatting
            var startAtInput = document.querySelector('input[name="StartAt"]');
            var endAtInput = document.querySelector('input[name="EndAt"]');
            
            function formatDateTimeLocal(date) {
                var year = date.getFullYear();
                var month = String(date.getMonth() + 1).padStart(2, '0');
                var day = String(date.getDate()).padStart(2, '0');
                var hours = String(date.getHours()).padStart(2, '0');
                var minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            if (startAtInput && startAtInput.value) {
                var startDate = new Date(startAtInput.value);
                startAtInput.value = formatDateTimeLocal(startDate);
            }
            
            if (endAtInput && endAtInput.value) {
                var endDate = new Date(endAtInput.value);
                endAtInput.value = formatDateTimeLocal(endDate);
            }

            // Helper function to show result modal
            function showResultModal(type, title, message) {
                const modal = $('#resultModal');
                const header = $('#resultModalHeader');
                const titleElem = $('#resultModalTitle');
                const iconElem = $('#resultModalIcon');
                const messageElem = $('#resultModalMessage');
                
                if (type === 'success') {
                    header.css('background', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
                    iconElem.html('‚úÖ');
                } else {
                    header.css('background', 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)');
                    iconElem.html('‚ùå');
                }
                
                titleElem.text(title);
                messageElem.text(message);
                modal.modal('show');
            }
            
            // Helper function to show confirm modal
            function showConfirmModal(title, message, type, onConfirm) {
                // Create modal HTML dynamically
                const modalId = 'confirmModal' + Date.now();
                const headerBg = type === 'danger' 
                    ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)' 
                    : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                const icon = type === 'danger' ? '‚ö†Ô∏è' : '‚ùì';
                
                const modalHtml = `
                    <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-0 shadow-lg">
                                <div class="modal-header border-0" style="background: ${headerBg};">
                                    <h5 class="modal-title text-white">${icon} ${title}</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body p-4">
                                    <p class="mb-0">${message}</p>
                                </div>
                                <div class="modal-footer border-0">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-circle me-1"></i>H·ªßy
                                    </button>
                                    <button type="button" class="btn btn-${type === 'danger' ? 'danger' : 'primary'}" id="${modalId}ConfirmBtn">
                                        <i class="bi bi-check-circle me-1"></i>X√°c nh·∫≠n
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Append to body
                $('body').append(modalHtml);
                
                // Show modal
                const $modal = $('#' + modalId);
                $modal.modal('show');
                
                // Handle confirm
                $('#' + modalId + 'ConfirmBtn').click(function() {
                    $modal.modal('hide');
                    if (onConfirm) onConfirm();
                });
                
                // Remove from DOM when hidden
                $modal.on('hidden.bs.modal', function() {
                    $modal.remove();
                });
            }

            // Target Type Change Handler
            $('#targetTypeSelect').change(function() {
                if ($(this).val() === 'All') {
                    $('#targetIdGroup').hide();
                } else {
                    $('#targetIdGroup').show();
                }
            });

            // AJAX Handlers
            var token = $('input[name="__RequestVerificationToken"]').val();

            // Add Rule
            $('#saveRuleBtn').click(function() {
                var formData = new FormData(document.getElementById('addRuleForm'));
                formData.append('__RequestVerificationToken', token);

                fetch('@Url.Action("AddRule", "Promotion")', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    $('#addRuleModal').modal('hide');
                    
                    if (data.success) {
                        showResultModal('success', 'Th√†nh c√¥ng!', data.message);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showResultModal('error', 'L·ªói!', data.message);
                    }
                });
            });

            // Delete Rule
            $('.delete-rule-btn').click(function() {
                const ruleId = $(this).data('id');
                
                // Show confirmation modal
                showConfirmModal(
                    'X√≥a quy t·∫Øc?',
                    'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a quy t·∫Øc gi·∫£m gi√° n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.',
                    'danger',
                    function() {
                        var formData = new FormData();
                        formData.append('id', ruleId);
                        formData.append('__RequestVerificationToken', token);

                        fetch('@Url.Action("DeleteRule", "Promotion")', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showResultModal('success', 'ƒê√£ x√≥a!', data.message);
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                showResultModal('error', 'L·ªói!', data.message);
                            }
                        });
                    }
                );
            });

            // Add Target
            $('#saveTargetBtn').click(function() {
                var formData = new FormData(document.getElementById('addTargetForm'));
                formData.append('__RequestVerificationToken', token);

                fetch('@Url.Action("AddTarget", "Promotion")', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    $('#addTargetModal').modal('hide');
                    
                    if (data.success) {
                        showResultModal('success', 'Th√†nh c√¥ng!', data.message);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showResultModal('error', 'L·ªói!', data.message);
                    }
                });
            });

            // Delete Target
            $('.delete-target-btn').click(function() {
                const targetId = $(this).data('id');
                
                // Show confirmation modal
                showConfirmModal(
                    'X√≥a ƒë·ªëi t∆∞·ª£ng?',
                    'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë·ªëi t∆∞·ª£ng √°p d·ª•ng n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.',
                    'danger',
                    function() {
                        var formData = new FormData();
                        formData.append('id', targetId);
                        formData.append('__RequestVerificationToken', token);

                        fetch('@Url.Action("DeleteTarget", "Promotion")', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showResultModal('success', 'ƒê√£ x√≥a!', data.message);
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                showResultModal('error', 'L·ªói!', data.message);
                            }
                        });
                    }
                );
            });

            // Generate Coupons
            $('#generateCouponsBtn').click(function() {
                var formData = new FormData(document.getElementById('generateCouponsForm'));
                formData.append('__RequestVerificationToken', token);

                fetch('@Url.Action("GenerateCoupons", "Promotion")', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Close the generate modal
                    $('#generateCouponsModal').modal('hide');
                    
                    // Show result modal
                    if (data.success) {
                        showResultModal('success', 'Sinh m√£ th√†nh c√¥ng!', data.message);
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showResultModal('error', 'L·ªói sinh m√£', data.message);
                    }
                });
            });

            // Delete Coupon
            $('.delete-coupon-btn').click(function() {
                const couponId = $(this).data('id');
                
                // Show confirmation modal
                showConfirmModal(
                    'X√≥a m√£ gi·∫£m gi√°?',
                    'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√£ gi·∫£m gi√° n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.',
                    'danger',
                    function() {
                        var formData = new FormData();
                        formData.append('id', couponId);
                        formData.append('__RequestVerificationToken', token);

                        fetch('@Url.Action("DeleteCoupon", "Promotion")', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showResultModal('success', 'ƒê√£ x√≥a!', data.message);
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                showResultModal('error', 'L·ªói!', data.message);
                            }
                        });
                    }
                );
            });
            
            // Export Coupons
            $('#exportCouponsBtn').click(function() {
                window.location.href = '@Url.Action("ExportCoupons", "Promotion")?promotionId=@Model.PromotionID';
            });
            
            // History Tab Filtering
            function filterHistory() {
                const searchTerm = $('#historySearch').val().toLowerCase();
                const statusFilter = $('#historyStatusFilter').val();
                const sortOrder = $('#historySortFilter').val();
                
                let rows = $('#history table tbody tr').toArray();
                
                // Filter
                rows.forEach(row => {
                    const $row = $(row);
                    const text = $row.text().toLowerCase();
                    const status = $row.find('td:eq(3)').text().trim();
                    
                    let showRow = true;
                    
                    // Search filter
                    if (searchTerm && !text.includes(searchTerm)) {
                        showRow = false;
                    }
                    
                    // Status filter
                    if (statusFilter && !status.includes(statusFilter === 'Applied' ? 'Th√†nh c√¥ng' : statusFilter === 'Voided' ? 'ƒê√£ h·ªßy' : 'H·∫øt h·∫°n')) {
                        showRow = false;
                    }
                    
                    $row.toggle(showRow);
                });
                
                // Sort
                rows = rows.filter(r => $(r).is(':visible'));
                rows.sort((a, b) => {
                    const dateA = $(a).find('td:eq(1)').text();
                    const dateB = $(b).find('td:eq(1)').text();
                    return sortOrder === 'desc' ? dateB.localeCompare(dateA) : dateA.localeCompare(dateB);
                });
                
                $('#history table tbody').append(rows);
            }
            
            $('#historySearch, #historyStatusFilter, #historySortFilter').on('change keyup', filterHistory);
        });
    </script>
}
