@model TourViet.Models.Tour

@{
    ViewData["Title"] = Model.TourName;
    var mainImage = Model.TourImages?.OrderBy(i => i.SortOrder).FirstOrDefault()?.Url ?? "/images/default-tour.jpg";
    var totalDays = Model.Itineraries?.Count ?? 0;
    var averageRating = Model.Reviews?.Any() == true ? Model.Reviews.Average(r => r.Rating) : 0;
    var reviewCount = Model.Reviews?.Count ?? 0;
    var minPrice = Model.TourPrices?.Any() == true ? Model.TourPrices.Min(p => p.Amount) : 0;
}

<!-- Hero Section -->
<div class="position-relative hero-section">
    <img src="@mainImage" class="hero-image w-100 object-fit-cover" alt="@Model.TourName">
    <div class="hero-overlay"></div>
    <div class="hero-content">
        <div class="container">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb breadcrumb-light mb-0">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index" class="text-white">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a href="#" class="text-white">Tours</a></li>
                    <li class="breadcrumb-item text-white opacity-75">@Model.Category?.CategoryName</li>
                </ol>
            </nav>

            <!-- Category Badge -->
            <span class="badge bg-primary bg-gradient mb-3 px-3 py-2 rounded-pill fs-6" 
                  @if (!string.IsNullOrEmpty(Model.Category?.Description))
                  {
                      <text>data-bs-toggle="tooltip" data-bs-placement="bottom" title="@Model.Category.Description"</text>
                  }>
                <i class="bi bi-tag-fill me-1"></i>@Model.Category?.CategoryName
            </span>

            <!-- Tour Title -->
            <h1 class="display-3 fw-bold text-white mb-3">@Model.TourName</h1>

            <!-- Quick Info -->
            <div class="d-flex flex-wrap align-items-center gap-3 text-white mb-3">
                <span class="d-flex align-items-center">
                    <i class="bi bi-geo-alt-fill me-2 text-warning"></i>
                    @Model.Location?.LocationName
                    @if (Model.Location?.Country != null)
                    {
                        <span class="ms-1">, @Model.Location.Country.CountryName</span>
                    }
                </span>

                @if (totalDays > 0)
                {
                    <span class="d-flex align-items-center">
                        <i class="bi bi-calendar-range me-2 text-info"></i>
                        @totalDays ngày @(totalDays - 1) đêm
                    </span>
                }

                @if (reviewCount > 0)
                {
                    <span class="d-flex align-items-center">
                        @for (int i = 1; i <= 5; i++)
                        {
                            <i class="bi bi-star-fill @(i <= averageRating ? "text-warning" : "text-white opacity-25")"></i>
                        }
                        <a href="#reviews" id="heroReviewLink" class="text-white text-decoration-none hover-opacity">
                            <span class="ms-2">(@reviewCount đánh giá)</span>
                        </a>
                    </span>
                }
                else
                {
                    <a href="#reviews" id="heroReviewLink" class="text-white text-decoration-none hover-opacity d-flex align-items-center">
                        <i class="bi bi-star me-2"></i>
                        <span>Viết đánh giá đầu tiên</span>
                    </a>
                }
            </div>

            <!-- Price Badge -->
            @if (minPrice > 0)
            {
                <div class="price-badge">
                    <span class="text-white-50 small">Từ</span>
                    <span class="display-6 fw-bold text-white ms-2">@minPrice.ToString("N0") VND</span>
                </div>
            }
        </div>
    </div>
</div>

<!-- Quick Stats Cards -->
<div class="container py-4">
    <div class="row g-4 mb-5">
        <!-- Duration Card -->
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body text-center p-4">
                    <div class="icon-box bg-primary bg-opacity-10 text-primary rounded-circle mx-auto mb-3">
                        <i class="bi bi-calendar-range fs-2"></i>
                    </div>
                    <h6 class="text-muted small mb-1">Thời gian</h6>
                    <h4 class="fw-bold mb-0">@totalDays ngày @(totalDays - 1) đêm</h4>
                </div>
            </div>
        </div>

        <!-- Group Size Card -->
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body text-center p-4">
                    <div class="icon-box bg-success bg-opacity-10 text-success rounded-circle mx-auto mb-3">
                        <i class="bi bi-people fs-2"></i>
                    </div>
                    <h6 class="text-muted small mb-1">Quy mô nhóm</h6>
                    @if (Model.TourInstances?.Any() == true)
                    {
                        var maxCapacity = Model.TourInstances.Max(ti => ti.Capacity);
                        <h4 class="fw-bold mb-0">Tối đa @maxCapacity người</h4>
                    }
                    else
                    {
                        <h4 class="fw-bold mb-0">Liên hệ</h4>
                    }
                </div>
            </div>
        </div>

        <!-- Guide Card -->
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body text-center p-4">
                    <div class="icon-box bg-info bg-opacity-10 text-info rounded-circle mx-auto mb-3">
                        <i class="bi bi-person-badge fs-2"></i>
                    </div>
                    <h6 class="text-muted small mb-1">Hướng dẫn viên</h6>
                    @if (Model.DefaultGuide != null)
                    {
                        <h5 class="fw-bold mb-1">@Model.DefaultGuide.FullName</h5>
                        @if (!string.IsNullOrEmpty(Model.DefaultGuide.Phone))
                        {
                            <small class="text-muted">
                                <i class="bi bi-telephone me-1"></i>@Model.DefaultGuide.Phone
                            </small>
                        }
                    }
                    else
                    {
                        <h4 class="fw-bold mb-0">Sẽ thông báo</h4>
                    }
                </div>
            </div>
        </div>

        <!-- Location Card -->
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body text-center p-4">
                    <div class="icon-box bg-warning bg-opacity-10 text-warning rounded-circle mx-auto mb-3">
                        <i class="bi bi-geo-alt fs-2"></i>
                    </div>
                    <h6 class="text-muted small mb-1">Điểm đến</h6>
                    <h5 class="fw-bold mb-0">@Model.Location?.LocationName</h5>
                    @if (Model.Location?.City != null)
                    {
                        <small class="text-muted">@Model.Location.City, @Model.Location.Country?.CountryName</small>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row g-5">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs nav-fill mb-4" id="tourTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                        <i class="bi bi-info-circle me-2"></i>Tổng quan
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="itinerary-tab" data-bs-toggle="tab" data-bs-target="#itinerary" type="button" role="tab">
                        <i class="bi bi-list-check me-2"></i>Lịch trình
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="departures-tab" data-bs-toggle="tab" data-bs-target="#departures" type="button" role="tab">
                        <i class="bi bi-calendar-event me-2"></i>Ngày khởi hành
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
                        <i class="bi bi-star me-2"></i>Đánh giá<span id="reviewCountBadge" class="badge bg-primary ms-1">@reviewCount</span>
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="tourTabContent">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-4">
                            <h3 class="fw-bold mb-4">Giới thiệu</h3>
                            <p class="lead text-muted mb-4">@Model.ShortDescription</p>
                            <div class="tour-description">
                                @Html.Raw(Model.Description?.Replace("\n", "<br>"))
                            </div>
                        </div>
                    </div>

                    <!-- Location Details -->
                    @if (Model.Location != null)
                    {
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body p-4">
                                <h3 class="fw-bold mb-4">
                                    <i class="bi bi-geo-alt-fill text-danger me-2"></i>Thông tin địa điểm
                                </h3>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-start">
                                            <i class="bi bi-pin-map text-primary me-3 mt-1"></i>
                                            <div>
                                                <h6 class="mb-1">Địa điểm</h6>
                                                <p class="text-muted mb-0">@Model.Location.LocationName</p>
                                            </div>
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(Model.Location.City))
                                    {
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-start">
                                                <i class="bi bi-building text-primary me-3 mt-1"></i>
                                                <div>
                                                    <h6 class="mb-1">Thành phố</h6>
                                                    <p class="text-muted mb-0">@Model.Location.City</p>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    @if (Model.Location.Country != null)
                                    {
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-start">
                                                <i class="bi bi-flag text-primary me-3 mt-1"></i>
                                                <div>
                                                    <h6 class="mb-1">Quốc gia</h6>
                                                    <p class="text-muted mb-0">
                                                        @Model.Location.Country.CountryName
                                                        @if (!string.IsNullOrEmpty(Model.Location.Country.ISO2))
                                                        {
                                                            <span class="badge bg-secondary ms-1">@Model.Location.Country.ISO2</span>
                                                        }
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(Model.Location.Address))
                                    {
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-start">
                                                <i class="bi bi-signpost text-primary me-3 mt-1"></i>
                                                <div>
                                                    <h6 class="mb-1">Địa chỉ</h6>
                                                    <p class="text-muted mb-0">@Model.Location.Address</p>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                                @if (!string.IsNullOrEmpty(Model.Location.Description))
                                {
                                    <div class="mt-4 pt-3 border-top">
                                        <p class="text-muted mb-0">@Model.Location.Description</p>
                                    </div>
                                }
                                
                                <!-- Google Maps Embed -->
                                @if (Model.Location.Latitude.HasValue && Model.Location.Longitude.HasValue)
                                {
                                    <div class="mt-4 pt-3 border-top">
                                        <h5 class="fw-bold mb-3">
                                            <i class="bi bi-map-fill text-primary me-2"></i>Xem trên bản đồ
                                        </h5>
                                        <div class="ratio ratio-16x9 rounded-3 overflow-hidden shadow-sm mb-3">
                                            <iframe 
                                                src="https://www.google.com/maps?q=@Model.Location.Latitude,@Model.Location.Longitude&hl=vi&z=14&output=embed"
                                                style="border:0;" 
                                                allowfullscreen="" 
                                                loading="lazy" 
                                                referrerpolicy="no-referrer-when-downgrade">
                                            </iframe>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <a href="https://www.google.com/maps?q=@Model.Location.Latitude,@Model.Location.Longitude" 
                                               target="_blank" 
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-geo-alt me-1"></i>Mở trong Google Maps
                                            </a>
                                            <a href="https://www.google.com/maps/dir/?api=1&destination=@Model.Location.Latitude,@Model.Location.Longitude" 
                                               target="_blank" 
                                               class="btn btn-outline-success btn-sm">
                                                <i class="bi bi-signpost-2 me-1"></i>Chỉ đường
                                            </a>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Image Gallery Carousel -->
                    @if (Model.TourImages != null && Model.TourImages.Count > 1)
                    {
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <h3 class="fw-bold mb-4">
                                    <i class="bi bi-images text-primary me-2"></i>Thư viện ảnh
                                </h3>
                                <div id="tourImageCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel">
                                    <!-- Indicators -->
                                    <div class="carousel-indicators">
                                        @{
                                            var imageIndex = 0;
                                            foreach (var img in Model.TourImages.OrderBy(i => i.SortOrder).Skip(1))
                                            {
                                                <button type="button" data-bs-target="#tourImageCarousel" data-bs-slide-to="@imageIndex" class="@(imageIndex == 0 ? "active" : "")" aria-label="Slide @(imageIndex + 1)"></button>
                                                imageIndex++;
                                            }
                                        }
                                    </div>

                                    <!-- Slides -->
                                    <div class="carousel-inner rounded-3">
                                        @{
                                            var slideIndex = 0;
                                            foreach (var img in Model.TourImages.OrderBy(i => i.SortOrder).Skip(1))
                                            {
                                                <div class="carousel-item @(slideIndex == 0 ? "active" : "")">
                                                    <img src="@img.Url" class="d-block w-100 carousel-image" alt="@(img.AltText ?? $"Tour image {slideIndex + 1}")">
                                                    @if (img.IsPrimary)
                                                    {
                                                        <div class="position-absolute top-0 end-0 m-3">
                                                            <span class="badge bg-warning text-dark">
                                                                <i class="bi bi-star-fill me-1"></i>Ảnh chính
                                                            </span>
                                                        </div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(img.AltText))
                                                    {
                                                        <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-75 rounded-3 p-2">
                                                            <p class="mb-0">@img.AltText</p>
                                                        </div>
                                                    }
                                                </div>
                                                slideIndex++;
                                            }
                                        }
                                    </div>

                                    <!-- Controls -->
                                    <button class="carousel-control-prev" type="button" data-bs-target="#tourImageCarousel" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Previous</span>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#tourImageCarousel" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Next</span>
                                    </button>
                                </div>

                                <!-- Thumbnail Navigation -->
                                <div class="row g-2 mt-3">
                                    @{
                                        var thumbIndex = 0;
                                        foreach (var img in Model.TourImages.OrderBy(i => i.SortOrder).Skip(1))
                                        {
                                            <div class="col-2">
                                                <img src="@img.Url" 
                                                     class="img-thumbnail carousel-thumbnail @(thumbIndex == 0 ? "active" : "")" 
                                                     data-bs-target="#tourImageCarousel" 
                                                     data-bs-slide-to="@thumbIndex"
                                                     alt="Thumbnail @(thumbIndex + 1)"
                                                     style="cursor: pointer; height: 60px; object-fit: cover;">
                                            </div>
                                            thumbIndex++;
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Itinerary Tab -->
                <div class="tab-pane fade" id="itinerary" role="tabpanel">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            <h3 class="fw-bold mb-4">
                                <i class="bi bi-map text-primary me-2"></i>Lịch trình chi tiết
                            </h3>
                            @if (Model.Itineraries != null && Model.Itineraries.Any())
                            {
                                <div class="timeline">
                                    @foreach (var item in Model.Itineraries.OrderBy(i => i.DayIndex))
                                    {
                                        <div class="timeline-item">
                                            <div class="timeline-marker">
                                                <div class="timeline-badge bg-primary">
                                                    @item.DayIndex
                                                </div>
                                            </div>
                                            <div class="timeline-content">
                                                <h5 class="fw-bold text-primary mb-2">
                                                    Ngày @item.DayIndex: @item.Title
                                                </h5>
                                                <p class="text-muted mb-0">@item.Description</p>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5 text-muted">
                                    <i class="bi bi-calendar-x fs-1 mb-3 d-block"></i>
                                    <p>Lịch trình chi tiết đang được cập nhật</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Departures Tab -->
                <div class="tab-pane fade" id="departures" role="tabpanel">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            <h3 class="fw-bold mb-4">
                                <i class="bi bi-calendar-check text-primary me-2"></i>Các ngày khởi hành
                            </h3>
                            @if (Model.TourInstances != null && Model.TourInstances.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Ngày bắt đầu</th>
                                                <th>Ngày kết thúc</th>
                                                <th>Thời gian</th>
                                                <th>Hướng dẫn viên</th>
                                                <th>Trạng thái</th>
                                                <th>Chỗ trống</th>
                                                <th>Giá từ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var instance in Model.TourInstances.OrderBy(i => i.StartDate))
                                            {
                                                var seatsAvailable = instance.Capacity - instance.SeatsBooked - instance.SeatsHeld;
                                                var duration = (instance.EndDate - instance.StartDate).Days + 1;
                                                <tr>
                                                    <td>@instance.StartDate.ToString("dd/MM/yyyy")</td>
                                                    <td>@instance.EndDate.ToString("dd/MM/yyyy")</td>
                                                    <td>@duration ngày</td>
                                                    <td>@(instance.Guide?.FullName ?? "Chưa phân công")</td>
                                                    <td>
                                                        @if (instance.Status == "Open" && seatsAvailable > 0)
                                                        {
                                                            <span class="badge bg-success">Còn chỗ</span>
                                                        }
                                                        else if (seatsAvailable <= 0)
                                                        {
                                                            <span class="badge bg-danger">Hết chỗ</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">@instance.Status</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (seatsAvailable > 0)
                                                        {
                                                            <span class="text-success fw-bold">@seatsAvailable/@instance.Capacity</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-danger">0/@instance.Capacity</span>
                                                        }
                                                    </td>
                                                    <td class="fw-bold text-primary">@instance.PriceBase.ToString("N0") VND</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pricing Details -->
                                <div class="mt-4 pt-4 border-top">
                                    <h5 class="fw-bold mb-3">Chi tiết giá</h5>
                                    @if (Model.TourPrices != null && Model.TourPrices.Any())
                                    {
                                        <div class="row g-3">
                                            @foreach (var price in Model.TourPrices.OrderBy(p => p.Amount))
                                            {
                                                <div class="col-md-4">
                                                    <div class="card bg-light border-0">
                                                        <div class="card-body text-center">
                                                            <h6 class="text-muted mb-2">@price.PriceType</h6>
                                                            <h4 class="text-primary fw-bold mb-0">@price.Amount.ToString("N0") @price.Currency</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5 text-muted">
                                    <i class="bi bi-calendar-x fs-1 mb-3 d-block"></i>
                                    <p>Hiện chưa có lịch khởi hành. Vui lòng liên hệ để biết thêm thông tin.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Reviews Tab -->
                <div class="tab-pane fade" id="reviews" role="tabpanel">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            <!-- Reviews Header with Stats -->
                            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center mb-4 pb-4 border-bottom">
                                <!-- Rating Summary - Full width on mobile, sidebar on desktop -->
                                <div class="text-center mb-4 mb-md-0 me-md-5 pe-md-5 border-md-end w-100 w-md-auto">
                                    <h2 class="display-4 fw-bold mb-2 text-primary" id="averageRatingDisplay">@averageRating.ToString("0.0")</h2>
                                    <div class="mb-2 fs-5" id="averageStarsDisplay">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="bi bi-star-fill @(i <= averageRating ? "text-warning" : "text-muted opacity-25")"></i>
                                        }
                                    </div>
                                    <div class="text-muted fw-medium"><span id="reviewCountDisplay">@reviewCount</span> đánh giá</div>
                                </div>
                                
                                <!-- Review Input Section - Full width on mobile and desktop -->
                                <div class="flex-grow-1 w-100">
                                    <!-- Review Input Section (YouTube Style) -->
                                    <div class="review-input-section">
                                        <!-- Loading State -->
                                        <div id="reviewAuthLoading" class="text-center py-3">
                                            <div class="spinner-border text-primary spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>

                                        <!-- Unauthenticated State -->
                                        <div id="reviewLoginPrompt" class="d-none">
                                            <div class="d-flex align-items-center gap-3 p-3 bg-light rounded-3 border-0">
                                                <div class="avatar-circle bg-secondary bg-opacity-10 text-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                    <i class="bi bi-person-fill"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <span class="text-muted">Đăng nhập để chia sẻ trải nghiệm của bạn.</span>
                                                </div>
                                                <button class="btn btn-outline-primary rounded-pill px-4 fw-medium" data-bs-toggle="modal" data-bs-target="#loginModal">
                                                    Đăng nhập
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Authenticated State (Form) -->
                                        <div id="reviewFormContainer" class="d-none">
                                            <div class="d-flex gap-3">
                                                <!-- User Avatar -->
                                                <div class="flex-shrink-0">
                                                    <div class="avatar-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 40px; height: 40px;">
                                                        <span id="currentUserInitial" class="fw-bold">U</span>
                                                    </div>
                                                </div>
                                                
                                                <!-- Input Area -->
                                                <div class="flex-grow-1">
                                                    <form id="reviewSubmissionForm">
                                                        <input type="hidden" id="editReviewId" value="">
                                                        
                                                        <!-- Star Rating (Always visible) -->
                                                        <div class="mb-3">
                                                            <div class="star-rating-selector d-flex align-items-center flex-wrap gap-2">
                                                                <span class="text-muted small fw-medium">Đánh giá:</span>
                                                                <div class="rating-group">
                                                                    <input type="radio" name="rating" id="star5" value="5" checked />
                                                                    <label for="star5" title="5 sao"><i class="bi bi-star-fill"></i></label>
                                                                    <input type="radio" name="rating" id="star4" value="4" />
                                                                    <label for="star4" title="4 sao"><i class="bi bi-star-fill"></i></label>
                                                                    <input type="radio" name="rating" id="star3" value="3" />
                                                                    <label for="star3" title="3 sao"><i class="bi bi-star-fill"></i></label>
                                                                    <input type="radio" name="rating" id="star2" value="2" />
                                                                    <label for="star2" title="2 sao"><i class="bi bi-star-fill"></i></label>
                                                                    <input type="radio" name="rating" id="star1" value="1" />
                                                                    <label for="star1" title="1 sao"><i class="bi bi-star-fill"></i></label>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Comment Input -->
                                                        <div class="mb-3">
                                                            <textarea class="form-control border rounded-3 shadow-sm" 
                                                                      placeholder="Chia sẻ cảm nghĩ của bạn..." 
                                                                      id="reviewComment" 
                                                                      rows="3"
                                                                      style="resize: none;"
                                                                      oninput="document.getElementById('reviewActions').classList.remove('d-none');"></textarea>
                                                        </div>

                                                        <!-- Actions -->
                                                        <div id="reviewActions" class="d-flex justify-content-between align-items-center d-none">
                                                            <div id="reviewFormAlert" class="alert alert-danger py-1 px-2 mb-0 d-none small"></div>
                                                            <div class="d-flex gap-2 ms-auto">
                                                                <button type="button" class="btn btn-text rounded-pill px-3" id="btnCancelReview">Hủy</button>
                                                                <button type="submit" class="btn btn-primary rounded-pill px-4" id="btnSubmitReview">
                                                                    <span id="btnSubmitReviewText">Gửi</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reviews Header -->
                            <div class="d-flex align-items-center justify-content-between mb-4">
                                <h4 class="fw-bold mb-0">Đánh giá từ khách hàng</h4>
                                <div class="dropdown">
                                    <button id="sortDropdownBtn" class="btn btn-light btn-sm dropdown-toggle rounded-pill" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-sort-down me-1"></i><span id="currentSortText">Mới nhất</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                                        <li><a class="dropdown-item active" href="#" data-sort="newest">Mới nhất</a></li>
                                        <li><a class="dropdown-item" href="#" data-sort="oldest">Cũ nhất</a></li>
                                        <li><a class="dropdown-item" href="#" data-sort="highest_rating">Điểm cao nhất</a></li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Connection Status -->
                            <div id="websocketStatus" class="alert alert-info d-none" role="alert">
                                <i class="bi bi-wifi me-2"></i>Đang kết nối đến máy chủ...
                            </div>

                            <!-- Reviews List -->
                            <div id="reviewsList" class="reviews-list">
                                @if (reviewCount > 0)
                                {
                                    @foreach (var review in (Model.Reviews ?? Enumerable.Empty<TourViet.Models.Review>()).OrderByDescending(r => r.CreatedAt))
                                    {
                                        <div class="review-item p-3 mb-3 bg-light rounded" data-review-id="@review.ReviewID">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="avatar-circle bg-primary text-white me-3">
                                                    @(review.User?.FullName?.Substring(0, 1).ToUpper() ?? "U")
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0">@(review.User?.FullName ?? "Khách hàng")</h6>
                                                    <div class="small">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            <i class="bi bi-star-fill @(i <= review.Rating ? "text-warning" : "text-muted opacity-25")"></i>
                                                        }
                                                        <span class="text-muted ms-2">@review.CreatedAt.ToString("dd/MM/yyyy")</span>
                                                    </div>
                                                </div>
                                            </div>
                                            @if (!string.IsNullOrEmpty(review.Comment))
                                            {
                                                <p class="text-muted mb-0 ms-5">@review.Comment</p>
                                            }
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div id="emptyReviewsMessage" class="text-center py-5 text-muted">
                                        <i class="bi bi-chat-quote fs-1 mb-3 d-block"></i>
                                        <p>Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá tour này!</p>
                                    </div>
                                }
                            </div>

                            <!-- Load More Button -->
                            <div class="text-center mt-4 d-none" id="loadMoreContainer">
                                <button type="button" class="btn btn-outline-primary" id="btnLoadMore">
                                    <i class="bi bi-arrow-down-circle me-2"></i>Xem thêm đánh giá
                                </button>
                            </div>

                            <!-- Pagination Controls -->
                            <div id="paginationControls" class="d-flex justify-content-between align-items-center mt-4 d-none">
                                <button id="prevPageBtn" class="btn btn-outline-primary" disabled>
                                    <i class="bi bi-chevron-left me-1"></i>Trang trước
                                </button>
                                <div id="pageInfo" class="text-muted fw-medium">
                                    Trang <span id="currentPageNum">1</span> / <span id="totalPagesNum">1</span>
                                </div>
                                <button id="nextPageBtn" class="btn btn-outline-primary" disabled>
                                    Trang sau<i class="bi bi-chevron-right ms-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Sticky Sidebar -->
        <div class="col-lg-4">
            <div class="sticky-sidebar">
                <!-- Booking Card -->
                <div class="card border-0 shadow-lg mb-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4">
                            <i class="bi bi-ticket-perforated text-primary me-2"></i>Đặt tour ngay
                        </h5>

                        <!-- Price Display -->
                        <div class="price-box bg-light rounded-3 p-3 mb-4">
                            <small class="text-muted d-block mb-1">Giá từ</small>
                            @if (minPrice > 0)
                            {
                                <h2 class="text-primary fw-bold mb-0">
                                    @minPrice.ToString("N0") <small class="fs-6 text-muted">VND</small>
                                </h2>
                            }
                            else
                            {
                                <h3 class="text-primary fw-bold mb-0">Liên hệ</h3>
                            }
                        </div>

                        <!-- Tour Instance Selector -->
                        @if (Model.TourInstances != null && Model.TourInstances.Any())
                        {
                            <div class="mb-4">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-calendar-event text-primary me-2"></i>Chọn ngày khởi hành
                                </label>
                                <select class="form-select form-select-lg" id="instanceSelector" onchange="highlightBookingButton()">
                                    <option value="">-- Chọn ngày --</option>
                                    @foreach (var instance in Model.TourInstances.Where(i => i.Status == "Open" || i.Status == "SoldOut").OrderBy(i => i.StartDate))
                                    {
                                        var actualAvailable = instance.Capacity - instance.SeatsBooked;
                                        
                                        <option value="@instance.InstanceID" 
                                                data-seats-available="@instance.Capacity" 
                                                data-capacity="@instance.Capacity"
                                                data-seats-booked="@instance.SeatsBooked"
                                                data-seats-held="@instance.SeatsHeld">
                                            @instance.StartDate.ToString("dd/MM/yyyy") - 
                                            @if (actualAvailable > 0)
                                            {
                                                @($"{actualAvailable} chỗ trống")
                                            }
                                            else
                                            {
                                                @("Hết chỗ")
                                            }
                                        </option>
                                    }
                                </select>
                                <div class="form-text small text-muted mt-2">
                                    <i class="bi bi-info-circle me-1"></i>Lựa chọn của bạn sẽ được tự động điền vào form đặt tour
                                </div>
                            </div>
                        }

                        <!-- CTA Buttons -->
                        <div class="d-grid gap-3 mb-4">
                            <button id="btnBookNow" class="btn btn-primary btn-lg rounded-pill shadow-sm" type="button" onclick="checkAuthAndShowBooking()">
                                <i class="bi bi-cart-plus me-2"></i>Đặt tour ngay
                            </button>
                            <button class="btn btn-outline-primary btn-lg rounded-pill" type="button">
                                <i class="bi bi-telephone me-2"></i>Liên hệ tư vấn
                            </button>
                        </div>

                        <!-- Services -->
                        @if (Model.TourServices != null && Model.TourServices.Any())
                        {
                            <hr class="my-4">

                            <!-- Included Services -->
                            @if (Model.TourServices.Any(s => s.IsIncluded))
                            {
                                <div class="mb-4">
                                    <h6 class="fw-bold text-success mb-3">
                                        <i class="bi bi-check-circle-fill me-2"></i>Bao gồm
                                    </h6>
                                    <ul class="list-unstyled small">
                                        @foreach (var service in Model.TourServices.Where(s => s.IsIncluded).OrderBy(s => s.SortOrder))
                                        {
                                            <li class="mb-2 d-flex justify-content-between align-items-start">
                                                <span>
                                                    <i class="bi bi-check2 text-success me-2"></i>
                                                    @service.Service?.ServiceName
                                                </span>
                                                @if ((service.PriceOverride ?? service.Service?.Price ?? 0) > 0)
                                                {
                                                    <small class="text-muted">
                                                        @((service.PriceOverride ?? service.Service?.Price ?? 0).ToString("N0")) @(service.Currency ?? service.Service?.Currency)
                                                    </small>
                                                }
                                            </li>
                                        }
                                    </ul>
                                </div>
                            }

                            <!-- Optional Services (Add-ons) -->
                            @if (Model.TourServices.Any(s => !s.IsIncluded))
                            {
                                <div class="mt-4">
                                    <h6 class="fw-bold text-secondary mb-3">
                                        <i class="bi bi-plus-circle-fill me-2"></i>Dịch vụ bổ sung (Tùy chọn)
                                    </h6>
                                    <div class="vstack gap-2">
                                        @foreach (var service in Model.TourServices.Where(s => !s.IsIncluded).OrderBy(s => s.SortOrder))
                                        {
                                            var price = service.PriceOverride ?? service.Service?.Price ?? 0;
                                            <div class="form-check card border-0 bg-light p-2 rounded-3">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div class="d-flex align-items-center">
                                                        <input class="form-check-input me-3 mt-0 fs-5" type="checkbox" 
                                                               name="SelectedServices" 
                                                               value="@service.ServiceID" 
                                                               id="svc_@service.ServiceID"
                                                               data-price="@price"
                                                               onchange="highlightBookingButton()">
                                                        <label class="form-check-label fw-medium cursor-pointer" for="svc_@service.ServiceID">
                                                            @service.Service?.ServiceName
                                                        </label>
                                                    </div>
                                                    @if (price > 0)
                                                    {
                                                        <span class="badge bg-white text-dark border shadow-sm">
                                                            +@price.ToString("N0") @(service.Currency ?? service.Service?.Currency)
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    <div class="form-text small mt-2 text-muted">
                                        <i class="bi bi-info-circle me-1"></i>Tích chọn các dịch vụ bạn muốn đăng ký thêm.
                                    </div>
                                </div>
                            }
                        }

                        <!-- Tour Meta -->
                        <hr class="my-4">
                        <div class="small text-muted">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Mã tour:</span>
                                <span class="text-dark">@Model.TourID.ToString().Substring(0, 8).ToUpper()</span>
                            </div>
                            @if (!string.IsNullOrEmpty(Model.Slug))
                            {
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Slug (URL):</span>
                                    <code class="text-dark small">@Model.Slug</code>
                                </div>
                            }
                            <div class="d-flex justify-content-between mb-2">
                                <span>Ngày tạo:</span>
                                <span>@Model.CreatedAt.ToString("dd/MM/yyyy")</span>
                            </div>
                            @if (Model.UpdatedAt.HasValue)
                            {
                                <div class="d-flex justify-content-between">
                                    <span>Cập nhật:</span>
                                    <span>@Model.UpdatedAt.Value.ToString("dd/MM/yyyy")</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Contact Card -->
                <div class="card border-0 bg-primary bg-gradient text-white shadow">
                    <div class="card-body p-4 text-center">
                        <i class="bi bi-headset fs-1 mb-3 d-block"></i>
                        <h5 class="fw-bold mb-3">Cần hỗ trợ?</h5>
                        <p class="mb-3 opacity-75">Đội ngũ của chúng tôi sẵn sàng tư vấn 24/7</p>
                        <div class="d-grid gap-2">
                            <a href="tel:1900xxxx" class="btn btn-light btn-lg rounded-pill">
                                <i class="bi bi-telephone-fill me-2"></i>1900 xxxx
                            </a>
                            <a href="mailto:info@tourviet.com" class="btn btn-outline-light btn-lg rounded-pill">
                                <i class="bi bi-envelope-fill me-2"></i>Email
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Hero Section */
    .hero-section {
        height: 60vh;
        min-height: 400px;
        overflow: hidden;
    }

    .hero-image {
        height: 100%;
        object-fit: cover;
    }

    .hero-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.7) 100%);
    }

    .hero-content {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 4rem 0;
        z-index: 10;
    }

    .breadcrumb-light .breadcrumb-item + .breadcrumb-item::before {
        color: rgba(255,255,255,0.7);
    }

    /* Quick Stats Cards */
    .icon-box {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .hover-lift {
        transition: all 0.3s ease;
    }

    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1.5rem rgba(0,0,0,.15)!important;
    }

    /* Tabs */
    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 1.5rem;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
        color: var(--bs-primary);
        border-color: transparent;
    }

    .nav-tabs .nav-link.active {
        color: var(--bs-primary);
        background-color: transparent;
        border-bottom: 3px solid var(--bs-primary);
    }

    /* Timeline */
    .timeline {
        position: relative;
    }

    .timeline-item {
        position: relative;
        padding-left: 60px;
        padding-bottom: 2rem;
    }

    .timeline-item:not(:last-child)::before {
        content: '';
        position: absolute;
        left: 19px;
        top: 40px;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, var(--bs-primary) 0%, rgba(var(--bs-primary-rgb), 0.2) 100%);
    }

    .timeline-marker {
        position: absolute;
        left: 0;
        top: 0;
    }

    .timeline-badge {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        box-shadow: 0 0 0 4px rgba(var(--bs-primary-rgb), 0.1);
    }

    .timeline-content {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border-left: 3px solid var(--bs-primary);
    }

    /* Carousel */
    .carousel-image {
        height: 500px;
        object-fit: cover;
    }

    .carousel-thumbnail {
        transition: all 0.3s ease;
        opacity: 0.6;
    }

    .carousel-thumbnail:hover,
    .carousel-thumbnail.active {
        opacity: 1;
        border-color: var(--bs-primary) !important;
        border-width: 2px !important;
    }

    .carousel-fade .carousel-item {
        opacity: 0;
        transition: opacity 0.6s ease-in-out;
    }

    .carousel-fade .carousel-item.active {
        opacity: 1;
    }

    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        padding: 1rem;
    }

    /* Gallery - Legacy styles (keeping for backwards compatibility) */
    .gallery-item {
        position: relative;
        overflow: hidden;
        border-radius: 0.5rem;
    }

    .gallery-image {
        height: 200px;
        transition: transform 0.3s ease;
        cursor: pointer;
    }

    .gallery-image:hover {
        transform: scale(1.05);
    }

    /* Sticky Sidebar */
    .sticky-sidebar {
        position: sticky;
        top: 2rem;
    }

    /* Reviews */
    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
    }

    /* Star Rating Selector */
    .star-rating-selector {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .star-rating-selector input {
        display: none;
    }

    .star-rating-selector label {
        font-size: 2rem;
        color: #ddd;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .star-rating-selector label:hover,
    .star-rating-selector label:hover ~ label,
    .star-rating-selector input:checked ~ label {
        color: #ffc107;
        transform: scale(1.1);
    }

    .star-rating-selector label:hover {
        transform: scale(1.2);
    }

    /* Responsive */
    @@media (max-width: 991px) {
        .hero-content {
            padding: 2rem 0;
        }
        
        .display-3 {
            font-size: 2.5rem;
        }

        .sticky-sidebar {
            position: relative;
            top: 0;
        }
    }


    @@media (max-width: 767px) {
        .hero-section {
            height: 50vh;
            min-height: 350px;
        }

        .display-3 {
            font-size: 2rem;
        }

        .nav-tabs .nav-link {
            padding: 0.75rem;
            font-size: 0.875rem;
        }
    }

    /* Utilities */
    .object-fit-cover {
        object-fit: cover;
    }

    .price-badge {
        display: inline-block;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
</style>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true" data-bs-focus="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary bg-gradient text-white border-0">
                <h5 class="modal-title" id="loginModalLabel">
                    <i class="bi bi-lock-fill me-2"></i>Yêu cầu đăng nhập
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <i class="bi bi-person-circle text-primary mb-3" style="font-size: 4rem;"></i>
                <h6 class="fw-bold mb-3">Vui lòng đăng nhập để đặt tour</h6>
                <p class="text-muted mb-4">Bạn cần có tài khoản để thực hiện đặt tour. Nếu chưa có tài khoản, vui lòng đăng ký ngay!</p>
                <div class="d-grid gap-2">
                    <a href="/Account/Login?returnUrl=@Context.Request.Path" class="btn btn-primary btn-lg">
                        <i class="bi bi-box-arrow-in-right me-2"></i>Đăng nhập
                    </a>
                    <a href="/Account/Register" class="btn btn-outline-primary btn-lg">
                        <i class="bi bi-person-plus me-2"></i>Đăng ký tài khoản mới
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sold Out Modal -->
<div class="modal fade" id="soldOutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body p-5 text-center">
                <div class="icon-box bg-danger bg-opacity-10 text-danger rounded-circle mx-auto mb-4" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-emoji-frown fs-1"></i>
                </div>
                <h4 class="fw-bold mb-3">Rất tiếc, tour đã hết chỗ!</h4>
                <p class="text-muted mb-4">Ngày khởi hành bạn chọn đã hết chỗ trống. Vui lòng chọn ngày khác hoặc liên hệ với chúng tôi để được hỗ trợ.</p>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary btn-lg rounded-pill" data-bs-dismiss="modal">
                        <i class="bi bi-calendar-check me-2"></i>Chọn ngày khác
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg rounded-pill" data-bs-dismiss="modal">
                        <i class="bi bi-telephone me-2"></i>Liên hệ tư vấn
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pending Booking Modal -->
<div class="modal fade" id="pendingBookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body p-5 text-center">
                <div class="icon-box bg-warning bg-opacity-10 text-warning rounded-circle mx-auto mb-4" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-clock-history fs-1"></i>
                </div>
                <h4 class="fw-bold mb-3">Đơn đặt tour đang chờ xử lý</h4>
                <p class="text-muted mb-4">Bạn hiện đang có một đơn đặt tour cho chuyến đi này đang ở trạng thái chờ xác nhận. Vui lòng đợi nhân viên của chúng tôi liên hệ hoặc kiểm tra lại lịch sử đặt tour.</p>
                <div class="d-grid gap-2">
                    <a href="/Home/BookingHistory" class="btn btn-primary btn-lg rounded-pill">
                        <i class="bi bi-list-check me-2"></i>Xem lịch sử đặt tour
                    </a>
                    <button type="button" class="btn btn-outline-danger btn-lg rounded-pill" id="btnCancelPendingBooking" onclick="showCancelConfirmation()">
                        <i class="bi bi-x-circle me-2"></i>Hủy đơn đặt tour này
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg rounded-pill" data-bs-dismiss="modal">
                        <i class="bi bi-arrow-left me-2"></i>Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="cancelConfirmationModalTour" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Xác nhận hủy tour
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <p class="mb-0">Bạn có chắc chắn muốn hủy đơn đặt tour này không?</p>
                <p class="text-muted small mt-2">Hành động này không thể hoàn tác.</p>
            </div>
            <div class="modal-footer border-0 bg-light justify-content-center">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Không, giữ lại</button>
                <button type="button" class="btn btn-danger px-4" id="confirmCancelBtnTour">
                    <i class="bi bi-x-circle me-2"></i>Có, hủy ngay
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notificationModalTour" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0" id="notificationHeaderTour">
                <h5 class="modal-title text-white" id="notificationTitleTour"></h5>
            </div>
            <div class="modal-body p-4 text-center">
                <div id="notificationIconTour" class="mb-3" style="font-size: 3rem;"></div>
                <p id="notificationMessageTour" class="mb-0 fw-bold"></p>
            </div>
            <div class="modal-footer border-0 bg-light justify-content-center">
                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true" data-bs-focus="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient text-white border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative;">
                <h5 class="modal-title fw-bold" id="bookingModalLabel">
                    <i class="bi bi-ticket-perforated-fill me-2"></i>Đặt tour: @Model.TourName
                </h5>
                <button type="button" data-bs-dismiss="modal" aria-label="Close" 
                        style="position: absolute; top: 10px; right: 10px; background: #FFD700; border: 3px solid #FF0000; 
                               border-radius: 4px; width: 40px; height: 40px; display: flex; align-items: center; 
                               justify-content: center; color: #FF0000; font-size: 28px; font-weight: bold; 
                               cursor: pointer; z-index: 9999; box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#FF0000'; this.style.color='#FFFFFF'; this.style.transform='scale(1.15)';"
                        onmouseout="this.style.background='#FFD700'; this.style.color='#FF0000'; this.style.transform='scale(1)';">×</button>
            </div>
            <div class="modal-body p-4">
                <!-- Success Message (Hidden by default) -->
                <div id="bookingSuccess" class="alert alert-success alert-dismissible fade show d-none" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Đặt tour thành công!</strong>
                    <p class="mb-0 mt-2">Mã đặt tour của bạn: <strong id="bookingRefDisplay"></strong></p>
                    <p class="mb-0 small">Chúng tôi sẽ liên hệ với bạn sớm nhất để xác nhận.</p>
                </div>

                <!-- Error Message (Hidden by default) -->
                <div id="bookingError" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Đặt tour thất bại!</strong>
                    <p class="mb-0 mt-2" id="bookingErrorMessage"></p>
                </div>

                <form id="bookingForm">
                    <!-- Tour Instance Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-calendar-event text-primary me-2"></i>Chọn ngày khởi hành
                            <span class="text-danger">*</span>
                        </label>
                        @if (Model.TourInstances != null && Model.TourInstances.Any(i => i.Status == "Open"))
                        {
                            <select class="form-select form-select-lg" id="bookingInstanceId" required onchange="updatePriceCalculation()">
                                <option value="">-- Vui lòng chọn ngày --</option>
                                @foreach (var instance in Model.TourInstances.Where(i => i.Status == "Open" || i.Status == "SoldOut").OrderBy(i => i.StartDate))
                                {
                                    var actualAvailable = instance.Capacity - instance.SeatsBooked;
                                    
                                    <option value="@instance.InstanceID" 
                                            data-price="@instance.PriceBase.ToString(System.Globalization.CultureInfo.InvariantCulture)" 
                                            data-currency="@instance.Currency"
                                            data-seats-available="@instance.Capacity"
                                            data-capacity="@instance.Capacity"
                                            data-seats-booked="@instance.SeatsBooked"
                                            data-seats-held="@instance.SeatsHeld">
                                        @instance.StartDate.ToString("dd/MM/yyyy") - @instance.EndDate.ToString("dd/MM/yyyy") 
                                        (@(actualAvailable > 0 ? $"{actualAvailable} chỗ trống" : "Hết chỗ")) - @instance.PriceBase.ToString("N0") @instance.Currency
                                    </option>
                                }
                            </select>
                        }
                        else
                        {
                            <p class="text-muted">Hiện chưa có lịch khởi hành. Vui lòng liên hệ để biết thêm thông tin.</p>
                        }
                    </div>

                    <!-- Overbooking Warning (Hidden by default) -->
                    <div class="alert alert-warning d-none" id="overbookingWarning" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Lưu ý:</strong> <span id="overbookingMessage"></span>
                    </div>

                    <!-- Number of Seats -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold" for="bookingSeats">
                            <i class="bi bi-people-fill text-primary me-2"></i>Số lượng người
                            <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control form-control-lg" id="bookingSeats" 
                               min="1" value="1" required onchange="updatePriceCalculation()">
                        <div class="form-text small">
                            <i class="bi bi-info-circle me-1"></i>Chỗ trống: <strong id="seatsAvailableDisplay">Vui lòng chọn ngày khởi hành</strong>
                        </div>
                    </div>

                    <!-- Optional Services -->
                    @if (Model.TourServices != null && Model.TourServices.Any(s => !s.IsIncluded))
                    {
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-plus-circle-fill text-secondary me-2"></i>Dịch vụ bổ sung (Tùy chọn)
                            </label>
                            <div class="card border-0 bg-light p-3">
                                <div id="optionalServicesContainer" class="vstack gap-2">
                                    @foreach (var service in Model.TourServices.Where(s => !s.IsIncluded).OrderBy(s => s.SortOrder))
                                    {
                                        var price = service.PriceOverride ?? service.Service?.Price ?? 0;
                                        <div class="form-check">
                                            <input class="form-check-input booking-service-checkbox" type="checkbox" 
                                                   value="@service.ServiceID" 
                                                   id="booking_svc_@service.ServiceID"
                                                   data-price="@price.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                                                   data-currency="@(service.Currency ?? service.Service?.Currency)"
                                                   onchange="updatePriceCalculation()">
                                            <label class="form-check-label w-100 d-flex justify-content-between align-items-center" 
                                                   for="booking_svc_@service.ServiceID">
                                                <span>@service.Service?.ServiceName</span>
                                                @if (price > 0)
                                                {
                                                    <span class="badge bg-primary">
                                                        +@price.ToString("N0") @(service.Currency ?? service.Service?.Currency)/người
                                                    </span>
                                                }
                                            </label>
                                        </div>
                                    }
                                </div>
                                <small class="text-muted mt-2">
                                    <i class="bi bi-info-circle me-1"></i>Giá dịch vụ bổ sung áp dụng cho mỗi người.
                                </small>
                            </div>
                        </div>
                    }

                    @* Automatic Promotions Banner *@
                    @if (ViewBag.ApplicablePromotions != null && ((List<TourViet.Models.Promotion>)ViewBag.ApplicablePromotions).Any())
                    {
                        <div class="alert alert-success mb-4" style="border-left: 4px solid #28a745;">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-gift-fill fs-4 me-3"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">🎉 Tour này đang có khuyến mãi!</h6>
                                    @foreach (var promo in (List<TourViet.Models.Promotion>)ViewBag.ApplicablePromotions)
                                    {
                                        <div class="small">
                                            <strong>@promo.Name:</strong>
                                            @if (promo.PromotionRules.Any())
                                            {
                                                var rule = promo.PromotionRules.First();
                                                if (rule.RuleType == "Percent")
                                                {
                                                    <span class="text-danger fw-bold">Giảm @rule.Value%</span>
                                                }
                                                else if (rule.RuleType == "Fixed")
                                                {
                                                    <span class="text-danger fw-bold">Giảm @rule.Value.ToString("N0") @rule.Currency</span>
                                                }
                                            }
                                            - Tự động áp dụng khi đặt tour
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Coupon Code -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold" for="couponCode">
                            <i class="bi bi-tag-fill text-secondary me-2"></i>Mã giảm giá (Nếu có)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="couponCode" placeholder="Nhập mã giảm giá" onchange="updatePriceCalculation()">
                            <button class="btn btn-outline-secondary" type="button" onclick="updatePriceCalculation()">
                                Áp dụng
                            </button>
                        </div>
                        <div id="couponMessage" class="form-text small mt-1"></div>
                        <div class="mt-2">
                            <a asp-controller="Promotions" asp-action="Index" class="small text-decoration-none" target="_blank">
                                <i class="bi bi-ticket-perforated me-1"></i>Xem danh sách khuyến mãi →
                            </a>
                        </div>
                    </div>

                    <!-- Price Summary -->
                    <div class="card border-0 bg-gradient text-white shadow mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;">
                        <div class="card-body p-4">
                            <h6 class="fw-bold mb-3">
                                <i class="bi bi-calculator me-2"></i>Tổng chi phí
                            </h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Giá cơ bản:</span>
                                <span id="basePriceDisplay">0 VND</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Số người:</span>
                                <span id="seatsDisplay">1</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2 d-none" id="servicesRow">
                                <span>Dịch vụ bổ sung:</span>
                                <span id="servicesTotalDisplay">0 VND</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2 d-none" id="discountRow">
                                <span class="text-warning">Giảm giá:</span>
                                <span id="discountDisplay" class="text-warning">-0 VND</span>
                            </div>
                            <hr class="border-white opacity-25 my-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 fw-bold">Tổng cộng:</h5>
                                <h4 class="mb-0 fw-bold" id="grandTotalDisplay">0 VND</h4>
                            </div>
                        </div>
                    </div>

                    <!-- Special Requests -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold" for="specialRequests">
                            <i class="bi bi-chat-dots text-secondary me-2"></i>Yêu cầu đặc biệt (Tùy chọn)
                        </label>
                        <textarea class="form-control" id="specialRequests" rows="3" 
                                  placeholder="Ví dụ: Cần giường đôi, ăn chay, ..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light p-4">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Hủy
                </button>
                <button type="button" class="btn btn-primary btn-lg px-4" id="btnSubmitBooking" onclick="submitBooking()">
                    <span id="btnSubmitText">
                        <i class="bi bi-check-circle-fill me-2"></i>Xác nhận đặt tour
                    </span>
                    <span id="btnSubmitLoading" class="d-none">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Đang xử lý...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPendingBookingId = null;

    // Check authentication and show appropriate modal
    async function checkAuthAndShowBooking() {
        // Check for sold out instance
        const sidebarInstanceSelector = document.getElementById('instanceSelector');
        if (sidebarInstanceSelector && sidebarInstanceSelector.value) {
            const selectedOption = sidebarInstanceSelector.options[sidebarInstanceSelector.selectedIndex];
            const seatsAvailable = parseInt(selectedOption.getAttribute('data-seats-available') || '0');
            
            if (seatsAvailable <= 0) {
                const soldOutModal = new bootstrap.Modal(document.getElementById('soldOutModal'));
                soldOutModal.show();
                return;
            }
        }

        try {
            // Pass tourId to check for pending bookings
            const tourId = '@Model.TourID';
            const response = await fetch(`/api/booking/check-auth?tourId=${tourId}`);
            const data = await response.json();
            
            if (data.isAuthenticated) {
                if (data.hasPendingBooking) {
                    currentPendingBookingId = data.pendingBookingId;
                    // Show pending booking modal
                    const pendingModal = new bootstrap.Modal(document.getElementById('pendingBookingModal'));
                    pendingModal.show();
                    return;
                }

                // Reset form first before showing modal
                resetBookingForm();
                
                // Show booking modal with proper options
                const bookingModalEl = document.getElementById('bookingModal');
                const bookingModal = new bootstrap.Modal(bookingModalEl, {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                });
                
                // Wait for modal to be fully shown before any operations
                bookingModalEl.addEventListener('shown.bs.modal', function onModalShown() {
                    // Remove this listener after first trigger
                    bookingModalEl.removeEventListener('shown.bs.modal', onModalShown);
                    
                    // Focus management is now handled by Bootstrap
                    // Price calculation already done in resetBookingForm
                }, { once: true });
                
                bookingModal.show();
            } else {
                // Show login modal
                const loginModalEl = document.getElementById('loginModal');
                const loginModal = new bootstrap.Modal(loginModalEl, {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                });
                loginModal.show();
            }
        } catch (error) {
            console.error('Error checking authentication:', error);
            alert('Đã xảy ra lỗi. Vui lòng thử lại sau.');
        }
    }

    function showCancelConfirmation() {
        // Hide pending modal
        const pendingModalEl = document.getElementById('pendingBookingModal');
        const pendingModal = bootstrap.Modal.getInstance(pendingModalEl);
        if (pendingModal) {
            pendingModal.hide();
        }
        
        // Show confirmation modal
        const confirmModal = new bootstrap.Modal(document.getElementById('cancelConfirmationModalTour'));
        confirmModal.show();
    }

    // Handle actual cancellation when user confirms
    document.getElementById('confirmCancelBtnTour').addEventListener('click', function() {
        if (!currentPendingBookingId) return;

        // Hide confirmation modal
        const confirmModalEl = document.getElementById('cancelConfirmationModalTour');
        const confirmModal = bootstrap.Modal.getInstance(confirmModalEl);
        confirmModal.hide();

        // Call API to cancel
        fetch(`/api/booking/cancel/${currentPendingBookingId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotificationTour(true, 'Hủy đặt tour thành công. Bạn có thể đặt lại ngay bây giờ.');
                
                // When notification modal is closed, open booking modal
                const notifModalEl = document.getElementById('notificationModalTour');
                notifModalEl.addEventListener('hidden.bs.modal', function () {
                    resetBookingForm();
                    const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
                    bookingModal.show();
                }, { once: true });
            } else {
                showNotificationTour(false, data.message || 'Đã xảy ra lỗi khi hủy đặt tour.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotificationTour(false, 'Đã xảy ra lỗi kết nối.');
        });
    });

    function showNotificationTour(isSuccess, message) {
        const modal = document.getElementById('notificationModalTour');
        const header = document.getElementById('notificationHeaderTour');
        const title = document.getElementById('notificationTitleTour');
        const msg = document.getElementById('notificationMessageTour');
        const icon = document.getElementById('notificationIconTour');

        if (isSuccess) {
            header.className = 'modal-header bg-success border-0';
            title.textContent = 'Thành công';
            title.className = 'modal-title text-white';
            icon.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
            msg.textContent = message;
        } else {
            header.className = 'modal-header bg-danger border-0';
            title.textContent = 'Thất bại';
            title.className = 'modal-title text-white';
            icon.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>';
            msg.textContent = message;
        }

        // Ensure header has relative positioning for absolute close button
        header.style.position = 'relative';
        
        // FIX: Create highly visible custom close button
        // Remove any existing custom close button first
        const existingClose = header.querySelector('.modal-close-custom');
        if (existingClose) {
            existingClose.remove();
        }
        
        // Create new visible close button with explicit styles
        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'modal-close-custom';
        closeBtn.setAttribute('data-bs-dismiss', 'modal');
        closeBtn.setAttribute('aria-label', 'Close');
        closeBtn.innerHTML = '<span style="font-size: 24px; font-weight: bold; line-height: 1;">×</span>';
        
        // Use inline styles with HIGH CONTRAST colors for visibility
        closeBtn.style.position = 'absolute';
        closeBtn.style.top = '10px';
        closeBtn.style.right = '10px';
        closeBtn.style.background = '#FFD700'; // Bright yellow/gold
        closeBtn.style.border = '3px solid #FF0000'; // Red border
        closeBtn.style.borderRadius = '4px';
        closeBtn.style.width = '40px';
        closeBtn.style.height = '40px';
        closeBtn.style.display = 'flex';
        closeBtn.style.alignItems = 'center';
        closeBtn.style.justifyContent = 'center';
        closeBtn.style.color = '#FF0000'; // Red X
        closeBtn.style.fontSize = '28px';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.transition = 'all 0.2s';
        closeBtn.style.zIndex = '9999';
        closeBtn.style.opacity = '1';
        closeBtn.style.visibility = 'visible';
        closeBtn.style.padding = '0';
        closeBtn.style.margin = '0';
        closeBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
        
        // Add hover effect
        closeBtn.addEventListener('mouseenter', function() {
            this.style.background = '#FF0000'; // Red on hover
            this.style.color = '#FFFFFF'; // White X on hover
            this.style.transform = 'scale(1.15)';
        });
        closeBtn.addEventListener('mouseleave', function() {
            this.style.background = '#FFD700';
            this.style.color = '#FF0000';
            this.style.transform = 'scale(1)';
        });
        
        header.appendChild(closeBtn);
        
        // Debug: log to console to verify button was created
        console.log('Close button created:', closeBtn);

        const notifModal = new bootstrap.Modal(modal);
        notifModal.show();
    }
    
    // Legacy function for compatibility
    function cancelPendingBooking() {
        showCancelConfirmation();
    }

    // Reset booking form and sync with sidebar selections
    function resetBookingForm() {
        document.getElementById('bookingForm').reset();
        document.getElementById('bookingSuccess').classList.add('d-none');
        document.getElementById('bookingError').classList.add('d-none');
        
        // Sync tour instance from sidebar to modal
        const sidebarInstanceSelector = document.getElementById('instanceSelector');
        const modalInstanceSelector = document.getElementById('bookingInstanceId');
        if (sidebarInstanceSelector && modalInstanceSelector && sidebarInstanceSelector.value) {
            modalInstanceSelector.value = sidebarInstanceSelector.value;
        }
        
        // Sync selected services from sidebar to modal
        const sidebarServiceCheckboxes = document.querySelectorAll('input[name="SelectedServices"]:checked');
        sidebarServiceCheckboxes.forEach(sidebarCheckbox => {
            const serviceId = sidebarCheckbox.value;
            const modalCheckbox = document.getElementById('booking_svc_' + serviceId);
            if (modalCheckbox) {
                modalCheckbox.checked = true;
            }
        });
        
        // Setup two-way sync listeners (modal → sidebar)
        setupTwoWaySync();
        
        // Update price calculation with synced selections
        updatePriceCalculation();
    }
    
    // Setup two-way sync between modal and sidebar
    function setupTwoWaySync() {
        const modalInstanceSelector = document.getElementById('bookingInstanceId');
        const sidebarInstanceSelector = document.getElementById('instanceSelector');
        
        // Sync instance changes from modal to sidebar
        if (modalInstanceSelector && sidebarInstanceSelector) {
            // Remove old listener if exists
            modalInstanceSelector.removeEventListener('change', syncInstanceToSidebar);
            // Add new listener
            modalInstanceSelector.addEventListener('change', syncInstanceToSidebar);
        }
        
        // Sync service changes from modal to sidebar
        const modalServiceCheckboxes = document.querySelectorAll('.booking-service-checkbox');
        modalServiceCheckboxes.forEach(modalCheckbox => {
            // Remove old listener if exists
            modalCheckbox.removeEventListener('change', syncServiceToSidebar);
            // Add new listener
            modalCheckbox.addEventListener('change', syncServiceToSidebar);
        });
    }
    
    // Sync instance selection from modal to sidebar
    function syncInstanceToSidebar(event) {
        const modalValue = event.target.value;
        const sidebarInstanceSelector = document.getElementById('instanceSelector');
        
        if (sidebarInstanceSelector) {
            sidebarInstanceSelector.value = modalValue;
            
            // Trigger visual feedback on sidebar
            if (modalValue) {
                highlightBookingButton();
            }
        }
    }
    
    // Sync service checkbox from modal to sidebar
    function syncServiceToSidebar(event) {
        const modalCheckbox = event.target;
        const serviceId = modalCheckbox.value;
        const sidebarCheckbox = document.getElementById('svc_' + serviceId);
        
        if (sidebarCheckbox) {
            sidebarCheckbox.checked = modalCheckbox.checked;
            
            // Trigger visual feedback on sidebar
            if (modalCheckbox.checked) {
                highlightBookingButton();
            }
        }
    }

    // Update price calculation (Server-side)
    async function updatePriceCalculation() {
        try {
            const instanceSelect = document.getElementById('bookingInstanceId');
            const seatsInput = document.getElementById('bookingSeats');
            const couponInput = document.getElementById('couponCode');
            const couponMessage = document.getElementById('couponMessage');
            
            if (!instanceSelect || !seatsInput) return;
            
            const instanceId = instanceSelect.value;
            let seats = parseInt(seatsInput.value);
            if (isNaN(seats) || seats < 1) seats = 1;
            
            // Basic UI updates (seats available)
            const selectedOption = instanceSelect.options[instanceSelect.selectedIndex];
            if (instanceId && selectedOption && selectedOption.dataset) {
                const capacity = parseInt(selectedOption.dataset.capacity) || 0;
                const seatsBooked = parseInt(selectedOption.dataset.seatsBooked) || 0;
                const actualAvailable = capacity - seatsBooked;
                document.getElementById('seatsAvailableDisplay').textContent = `${actualAvailable} chỗ`;
                seatsInput.max = capacity;
                
                // VALIDATION: Check if seats exceed available
                if (seats > actualAvailable) {
                    seatsInput.classList.add('is-invalid');
                    seatsInput.setCustomValidity(`Chỉ còn ${actualAvailable} chỗ trống`);
                } else {
                    seatsInput.classList.remove('is-invalid');
                    seatsInput.setCustomValidity('');
                }
            } else {
                document.getElementById('seatsAvailableDisplay').textContent = 'Vui lòng chọn ngày khởi hành';
                return; // Stop if no instance selected
            }

            // Prepare request
            const selectedServices = [];
            document.querySelectorAll('.booking-service-checkbox:checked').forEach(checkbox => {
                selectedServices.push(checkbox.value);
            });

            const requestData = {
                instanceId: instanceId,
                seats: seats,
                selectedServiceIds: selectedServices,
                couponCode: couponInput ? couponInput.value.trim() : null
            };

            // Call API
            const response = await fetch('/api/booking/calculate-price', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (result.success && result.data) {
                const data = result.data;
                const currency = data.currency || 'VND';

                // Update displays
                document.getElementById('basePriceDisplay').textContent = `${data.basePriceTotal.toLocaleString('vi-VN')} ${currency}`;
                document.getElementById('seatsDisplay').textContent = data.seats;
                document.getElementById('servicesTotalDisplay').textContent = `${data.servicesTotal.toLocaleString('vi-VN')} ${currency}`;
                document.getElementById('grandTotalDisplay').textContent = `${data.grandTotal.toLocaleString('vi-VN')} ${currency}`;

                // Services visibility
                const servicesRow = document.getElementById('servicesRow');
                if (data.servicesTotal > 0) {
                    servicesRow.classList.remove('d-none');
                } else {
                    servicesRow.classList.add('d-none');
                }

                // Discount handling
                const discountRow = document.getElementById('discountRow');
                const discountDisplay = document.getElementById('discountDisplay');
                
                if (data.discountAmount > 0) {
                    discountRow.classList.remove('d-none');
                    discountDisplay.textContent = `-${data.discountAmount.toLocaleString('vi-VN')} ${currency}`;
                    
                    if (data.promotionMessage) {
                        couponMessage.textContent = data.promotionMessage;
                        couponMessage.className = 'form-text small mt-1 text-success fw-bold';
                    } else {
                         couponMessage.textContent = '';
                    }
                } else {
                    discountRow.classList.add('d-none');
                    if (requestData.couponCode && data.promotionMessage) {
                         couponMessage.textContent = data.promotionMessage;
                         couponMessage.className = 'form-text small mt-1 text-danger';
                    } else {
                         couponMessage.textContent = '';
                    }
                }
            }
        } catch (error) {
            console.error('Error in updatePriceCalculation:', error);
        }
    }

    // Submit booking
    async function submitBooking() {
        const form = document.getElementById('bookingForm');
        const submitBtn = document.getElementById('btnSubmitBooking');
        const submitText = document.getElementById('btnSubmitText');
        const submitLoading = document.getElementById('btnSubmitLoading');
        const successAlert = document.getElementById('bookingSuccess');
        const errorAlert = document.getElementById('bookingError');
        
        // Validate form
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const instanceId = document.getElementById('bookingInstanceId').value;
        const seats = parseInt(document.getElementById('bookingSeats').value);
        const specialRequests = document.getElementById('specialRequests').value;
        
        if (!instanceId) {
            showError('Vui lòng chọn ngày khởi hành.');
            return;
        }
        
        if (seats <= 0) {
            showError('Số lượng người phải lớn hơn 0.');
            return;
        }
        
        // VALIDATION: Validate seats against available capacity
        const selectedOption = document.querySelector(`#bookingInstanceId option[value="${instanceId}"]`);
        if (selectedOption) {
            const capacity = parseInt(selectedOption.getAttribute('data-capacity') || '0');
            const seatsBooked = parseInt(selectedOption.getAttribute('data-seats-booked') || '0');
            const seatsAvailable = capacity - seatsBooked;
            
            if (seats > seatsAvailable) {
                showError(`Chỉ còn ${seatsAvailable} chỗ trống. Vui lòng giảm số lượng người.`);
                return;
            }
        }
        
        // Get selected services
        const selectedServices = [];
        document.querySelectorAll('.booking-service-checkbox:checked').forEach(checkbox => {
            selectedServices.push({
                serviceID: checkbox.value,
                quantity: seats  // Match the number of seats/people
            });
        });
        
        // Prepare booking data
        const bookingData = {
            tourInstanceID: instanceId,
            seats: seats,
            selectedServices: selectedServices,
            specialRequests: specialRequests,
            couponCode: document.getElementById('couponCode').value.trim()
        };
        
        // Show loading state
        submitBtn.disabled = true;
        submitText.classList.add('d-none');
        submitLoading.classList.remove('d-none');
        successAlert.classList.add('d-none');
        errorAlert.classList.add('d-none');
        
        try {
            const response = await fetch('/api/booking/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bookingData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Show success message
                document.getElementById('bookingRefDisplay').textContent = data.bookingRef;
                successAlert.classList.remove('d-none');
                
                // Scroll to top of modal to show success message
                document.querySelector('#bookingModal .modal-body').scrollTop = 0;
                
                // Disable form after successful booking
                form.querySelectorAll('input, select, textarea, button').forEach(el => el.disabled = true);
                submitBtn.classList.add('d-none');
                
                // Reload page after 3 seconds to update booking status
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                showError(data.message || 'Đã xảy ra lỗi khi đặt tour.');
            }
        } catch (error) {
            console.error('Error submitting booking:', error);
            showError('Đã xảy ra lỗi khi kết nối đến server. Vui lòng thử lại sau.');
        } finally {
            // Hide loading state
            submitBtn.disabled = false;
            submitText.classList.remove('d-none');
            submitLoading.classList.add('d-none');
        }
    }

    // Show error message
    function showError(message) {
        const errorAlert = document.getElementById('bookingError');
        const errorMessage = document.getElementById('bookingErrorMessage');
        
        errorMessage.textContent = message;
        errorAlert.classList.remove('d-none');
        
        // Scroll to top of modal to show error message
        document.querySelector('#bookingModal .modal-body').scrollTop = 0;
    }
    
    // Highlight booking button when user makes selections in sidebar
    function highlightBookingButton() {
        const bookButton = document.getElementById('btnBookNow');
        const instanceSelector = document.getElementById('instanceSelector');
        const selectedServices = document.querySelectorAll('input[name="SelectedServices"]:checked');
        
        if (bookButton) {
            // Add pulse animation if instance is selected or services are checked
            if ((instanceSelector && instanceSelector.value) || selectedServices.length > 0) {
                bookButton.classList.add('btn-pulse');
                
                // Remove animation after 2 seconds
                setTimeout(() => {
                    bookButton.classList.remove('btn-pulse');
                }, 2000);
            }
        }
    }
</script>

<style>
    /* Modal animations */
    .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
    }
    
    /* Hover effects for form elements */
    .form-select:focus,
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
    }
    
    .form-check-input:checked {
        background-color: #667eea;
        border-color: #667eea;
    }
    
    /* Button animations */
    .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Alert animations */
    .alert {
        animation: slideIn 0.3s ease-out;
    }
    
    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Price summary card gradient shimmer */
    .bg-gradient {
        background-size: 200% 200%;
        animation: gradientShift 3s ease infinite;
    }
    
    @@keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100%50%; }
        100% { background-position: 0% 50%; }
    }
    
    /* Pulse animation for booking button */
    .btn-pulse {
        animation: pulse 1s ease-in-out 2;
        box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0.7);
    }
    
    @@keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0.7);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(var(--bs-primary-rgb), 0);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0);
        }
    }
    
    /* Smooth transitions for selections */
    #instanceSelector, 
    input[name="SelectedServices"] {
        transition: all 0.3s ease;
    }
    
    #instanceSelector:focus,
    input[name="SelectedServices"]:checked {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
    }

    /* Review Section Styles */
    .avatar-circle {
        font-size: 1.2rem;
        user-select: none;
    }

    .btn-text {
        background: transparent;
        border: none;
        color: #606060;
        font-weight: 500;
    }

    .btn-text:hover {
        background-color: rgba(0, 0, 0, 0.05);
        color: #0f0f0f;
    }
</style>

<script>
    // Initialize Bootstrap tooltips
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Make thumbnail images clickable
        var carouselEl = document.getElementById('tourImageCarousel');
        if (carouselEl) {
            var carousel = new bootstrap.Carousel(carouselEl);
            
            var thumbnails = document.querySelectorAll('.carousel-thumbnail');
            thumbnails.forEach(function(thumb, index) {
                thumb.addEventListener('click', function() {
                    var slideTo = parseInt(this.getAttribute('data-bs-slide-to'));
                    carousel.to(slideTo);
                    
                    // Update active thumbnail
                    thumbnails.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Update active thumbnail when carousel slides
            carouselEl.addEventListener('slid.bs.carousel', function (e) {
                var activeIndex = Array.from(e.target.querySelectorAll('.carousel-item')).indexOf(e.relatedTarget);
                thumbnails.forEach((t, i) => {
                    if (i === activeIndex) {
                        t.classList.add('active');
                    } else {
                        t.classList.remove('active');
                    }
                });
            });
        }
        // Handle hero review link click
        const heroReviewLink = document.getElementById('heroReviewLink');
        if (heroReviewLink) {
            heroReviewLink.addEventListener('click', function(e) {
                e.preventDefault();
                const reviewsTab = document.getElementById('reviews-tab');
                if (reviewsTab) {
                    new bootstrap.Tab(reviewsTab).show();
                    reviewsTab.scrollIntoView({ behavior: 'smooth' });
                    
                    // Optional: Open the form automatically if they clicked "Write first review"
                    // but maybe better to let them see the existing reviews first
                }
            });
        }

    });
</script>

<!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script src="~/js/review-websocket.js"></script>

<script>
    // Global review variables
    let currentUserId = null;
    let currentUserReview = null;
    let reviewWS = null;
    let reviewsLoaded = false;
    const REVIEWS_PER_PAGE = 20;
    let currentSort = 'newest';
    let currentPage = 1;
    let totalPages = 1;

    document.addEventListener('DOMContentLoaded', async function() {
        const tourId = '@Model.TourID';
        let reviewStatusChecked = false;
        
        // Check status when reviews tab is clicked
        const reviewsTab = document.getElementById('reviews-tab');
        if (reviewsTab) {
            reviewsTab.addEventListener('click', async function() {
                // Check review status on first click
                if (!reviewStatusChecked) {
                    reviewStatusChecked = true;
                    await checkReviewStatus(tourId);
                }
            });
        }

        // Also check if reviews tab is already active (e.g., from direct link)
        const reviewsTabPane = document.getElementById('reviews');
        if (reviewsTabPane && reviewsTabPane.classList.contains('active')) {
            reviewStatusChecked = true;
            await checkReviewStatus(tourId);
        }

        // Cancel review form
        const cancelBtn = document.getElementById('btnCancelReview');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
                resetReviewForm();
                const actions = document.getElementById('reviewActions');
                if (actions) actions.classList.add('d-none');
            });
        }

        // Submit review form
        const reviewForm = document.getElementById('reviewSubmissionForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const rating = document.querySelector('input[name="rating"]:checked');
                if (!rating) {
                    showAlert('Vui lòng chọn số sao đánh giá', 'warning');
                    return;
                }

                const comment = document.getElementById('reviewComment').value.trim();
                const editReviewId = document.getElementById('editReviewId').value;
                const btnSubmit = document.getElementById('btnSubmitReview');
                const btnText = document.getElementById('btnSubmitReviewText');
                
                // Disable button
                if (btnSubmit) btnSubmit.disabled = true;
                if (btnText) btnText.textContent = 'Đang gửi...';

                try {
                    let response;
                    if (editReviewId) {
                        // Update via REST API
                        response = await fetch(`/Review/Update/${editReviewId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ Rating: parseInt(rating.value), Comment: comment })
                        });
                    } else {
                        // Create via REST API
                        response = await fetch('/Review/Create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ TourID: tourId, Rating: parseInt(rating.value), Comment: comment })
                        });
                    }

                    const result = await response.json();
                    
                    if (result.success) {
                        // Success - update UI dynamically
                        // alert(editReviewId ? 'Cập nhật đánh giá thành công!' : 'Gửi đánh giá thành công!');
                        
                        if (editReviewId) {
                            // Update existing review
                            updateReviewInUI(result.data);
                            currentUserReview = result.data;
                        } else {
                            // Add new review
                            addReviewToUI(result.data, true);
                            currentUserReview = result.data;
                            
                            // Switch form to edit mode
                            populateReviewForm(result.data);
                            document.getElementById('reviewComment').placeholder = "Chỉnh sửa đánh giá của bạn...";
                            document.getElementById('btnSubmitReviewText').textContent = 'Cập nhật';
                        }
                        
                        updateReviewStats();
                        
                        // Show success message
                        showAlert(editReviewId ? 'Cập nhật đánh giá thành công!' : 'Gửi đánh giá thành công!', 'success');
                    } else {
                        showAlert(result.message || 'Đã xảy ra lỗi khi gửi đánh giá', 'danger');
                    }
                } catch (error) {
                    console.error('Error submitting review:', error);
                    showAlert('Đã xảy ra lỗi khi gửi đánh giá', 'danger');
                } finally {
                    if (btnSubmit) btnSubmit.disabled = false;
                    if (btnText) btnText.textContent = editReviewId ? 'Cập nhật' : 'Gửi';
                }
            });
        }
        // Load reviews
        loadReviews(tourId, currentSort, currentPage);
        
        // Set up sorting dropdown
        document.querySelectorAll('[data-sort]').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const sortValue = this.getAttribute('data-sort');
                const sortText = this.textContent.trim();
                
                // Update current sort
                currentSort = sortValue;
                currentPage = 1; // Reset to page 1
                
                // Update UI
                document.getElementById('currentSortText').textContent = sortText;
                document.querySelectorAll('[data-sort]').forEach(el => el.classList.remove('active'));
                this.classList.add('active');
                
                // Reload reviews
                loadReviews(tourId, currentSort, currentPage);
            });
        });
        
        // Set up pagination buttons
        document.getElementById('prevPageBtn')?.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadReviews(tourId, currentSort, currentPage);
            }
        });
        
        document.getElementById('nextPageBtn')?.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                loadReviews(tourId, currentSort, currentPage);
            }
        });
    });

    // Load reviews from API
    async function loadReviews(tourId, sort = 'newest', page = 1) {
        const reviewsList = document.getElementById('reviewsList');
        if (!reviewsList) return;
        
        // Show loading state if empty
        if (reviewsList.children.length === 0 || reviewsList.querySelector('#emptyReviewsMessage')) {
            reviewsList.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        }

        try {
            const skip = (page - 1) * REVIEWS_PER_PAGE;
            const response = await fetch(`/Review/GetTourReviews/${tourId}?skip=${skip}&take=${REVIEWS_PER_PAGE}&sortBy=${sort}`);
            const result = await response.json();

            // Initialize WebSocket if not already done
            if (!reviewWS) {
                initializeReviewWebSocket(tourId);
            }

            if (result.success) {
                const reviews = result.data;
                reviewsList.innerHTML = ''; // Clear loading

                if (reviews.length === 0) {
                    reviewsList.innerHTML = `
                        <div id="emptyReviewsMessage" class="text-center py-5 text-muted">
                            <i class="bi bi-chat-quote fs-1 mb-3 d-block"></i>
                            <p>Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá tour này!</p>
                        </div>
                    `;
                    // Hide pagination if no reviews
                    document.getElementById('paginationControls')?.classList.add('d-none');
                } else {
                    reviews.forEach(review => {
                        addReviewToUI(review, false); // Append
                    });
                    
                    // Update pagination controls
                    updatePaginationControls(reviews.length);
                }
                
                reviewsLoaded = true;
                
                // Update stats after loading reviews
                await updateReviewStats();
            } else {
                reviewsList.innerHTML = `<div class="alert alert-danger">Không thể tải đánh giá: ${result.message}</div>`;
            }
        } catch (error) {
            console.error('Error loading reviews:', error);
            reviewsList.innerHTML = '<div class="alert alert-danger">Đã xảy ra lỗi khi tải đánh giá</div>';
        }
    }

    // Update pagination controls based on loaded reviews
    function updatePaginationControls(reviewCount) {
        const paginationControls = document.getElementById('paginationControls');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const currentPageNum = document.getElementById('currentPageNum');
        const totalPagesNum = document.getElementById('totalPagesNum');
        
        if (!paginationControls) return;
        
        // If we got fewer reviews than the page size, we're on the last page
        if (reviewCount < REVIEWS_PER_PAGE) {
            totalPages = currentPage;
        }
        
        // Show pagination only if multiple pages exist or if we're not on page 1
        if (currentPage > 1 || reviewCount === REVIEWS_PER_PAGE) {
            paginationControls.classList.remove('d-none');
            
            // Update page numbers
            currentPageNum.textContent = currentPage;
            totalPagesNum.textContent = totalPages;
            
            // Update button states
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = reviewCount < REVIEWS_PER_PAGE; // Disable if less than full page
        } else {
            paginationControls.classList.add('d-none');
        }
    }

    // Check review status and update UI
    async function checkReviewStatus(tourId) {
        const loading = document.getElementById('reviewAuthLoading');
        const loginPrompt = document.getElementById('reviewLoginPrompt');
        const formContainer = document.getElementById('reviewFormContainer');
        
        if (!loading || !loginPrompt || !formContainer) return;

        loading.classList.remove('d-none');
        loginPrompt.classList.add('d-none');
        formContainer.classList.add('d-none');

        try {
            const authResponse = await fetch('/api/booking/check-auth');
            const authData = await authResponse.json();
            
            if (!authData.isAuthenticated) {
                loading.classList.add('d-none');
                loginPrompt.classList.remove('d-none');
                return;
            }

            // Authenticated
            currentUserId = authData.userId; // Store current user ID
            const initial = authData.userName ? authData.userName.charAt(0).toUpperCase() : 'U';
            const avatarEl = document.getElementById('currentUserInitial');
            if (avatarEl) avatarEl.textContent = initial;
            
            // Check if user has already reviewed
            const myReviewResponse = await fetch(`/Review/MyReview/${tourId}`);
            const myReviewData = await myReviewResponse.json();
            
            // Check if user can review
            const canReviewResponse = await fetch(`/Review/CanReview/${tourId}`);
            const canReviewData = await canReviewResponse.json();
            
            // Debug logging
            console.log('CanReview API Response:', canReviewData);
            console.log('MyReview API Response:', myReviewData);

            loading.classList.add('d-none');

            if (myReviewData.success && myReviewData.data) {
                // User has existing review - show form for editing
                formContainer.classList.remove('d-none');
                currentUserReview = myReviewData.data;
                populateReviewForm(myReviewData.data);
                document.getElementById('reviewComment').placeholder = "Chỉnh sửa đánh giá của bạn...";
                document.getElementById('btnSubmitReviewText').textContent = 'Cập nhật';
            } else if (!canReviewData.canReview) {
                // Cannot review (no completed booking) - show info message
                formContainer.classList.remove('d-none');
                formContainer.innerHTML = `
                    <div class="alert alert-light border d-flex align-items-center mb-0">
                        <i class="bi bi-info-circle text-primary fs-4 me-3"></i>
                        <div>
                            <strong>Bạn chưa thể đánh giá tour này.</strong><br>
                            <span class="text-muted small">${canReviewData.message || 'Bạn cần hoàn thành tour để viết đánh giá.'}</span>
                        </div>
                    </div>
                `;
            } else {
                // Can review and hasn't reviewed yet - show empty form
                formContainer.classList.remove('d-none');
                resetReviewForm();
            }

        } catch (error) {
            console.error('Error checking status:', error);
            loading.classList.add('d-none');
        }
    }

    // Initialize WebSocket connection
    async function initializeReviewWebSocket(tourId) {
        // document.getElementById('websocketStatus').classList.remove('d-none');
        
        reviewWS = new ReviewWebSocket(tourId);
        
        // Set up handlers
        reviewWS
            .onConnected(() => {
                console.log('WebSocket connected');
                // document.getElementById('websocketStatus').classList.add('d-none');
            })
            .onReceiveReview((review) => {
                console.log('New review received:', review);
                addReviewToUI(review, true);
                updateReviewStats();
            })
            .onReviewUpdated((review) => {
                console.log('Review updated:', review);
                updateReviewInUI(review);
                updateReviewStats();
            })
            .onReviewDeleted((reviewId) => {
                console.log('Review deleted:', reviewId);
                removeReviewFromUI(reviewId);
                updateReviewStats();
            })
            .onError((message) => {
                console.error('WebSocket error:', message);
                // ReviewUI.showToast(message, 'error');
            })
            .onDisconnected(() => {
                // document.getElementById('websocketStatus').innerHTML = '<i class="bi bi-wifi-off me-2"></i>Mất kết nối. Đang thử kết nối lại...';
                // document.getElementById('websocketStatus').classList.remove('d-none');
            });

        // Connect
        try {
            await reviewWS.connect();
        } catch (error) {
            console.error('Failed to connect WebSocket:', error);
        }
    }

    // Add new review to UI
    function addReviewToUI(review, prepend = true) {
        const reviewsList = document.getElementById('reviewsList');
        const emptyMessage = document.getElementById('emptyReviewsMessage');
        
        if (emptyMessage) {
            emptyMessage.remove();
        }

        // Check if review already exists (to avoid duplicates from REST + WebSocket)
        if (document.querySelector(`[data-review-id="${review.reviewID}"]`)) {
            return;
        }

        const reviewHTML = ReviewUI.createReviewHTML(review, review.userID === currentUserId);
        
        if (prepend) {
            reviewsList.insertAdjacentHTML('afterbegin', reviewHTML);
        } else {
            reviewsList.insertAdjacentHTML('beforeend', reviewHTML);
        }
    }

    // Update existing review in UI
    function updateReviewInUI(review) {
        const reviewElement = document.querySelector(`[data-review-id="${review.reviewID}"]`);
        if (reviewElement) {
            const updatedHTML = ReviewUI.createReviewHTML(review, review.userID === currentUserId);
            reviewElement.outerHTML = updatedHTML;
        }
    }

    // Remove review from UI
    function removeReviewFromUI(reviewId) {
        const reviewElement = document.querySelector(`[data-review-id="${reviewId}"]`);
        if (reviewElement) {
            reviewElement.style.transition = 'opacity 0.3s';
            reviewElement.style.opacity = '0';
            setTimeout(() => reviewElement.remove(), 300);
        }

        // Show empty message if no reviews left
        const reviewsList = document.getElementById('reviewsList');
        if (reviewsList && reviewsList.children.length === 0) {
            reviewsList.innerHTML = `
                <div id="emptyReviewsMessage" class="text-center py-5 text-muted">
                    <i class="bi bi-chat-quote fs-1 mb-3 d-block"></i>
                    <p>Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá tour này!</p>
                </div>
            `;
        }
    }

    // Update review statistics
    async function updateReviewStats() {
        try {
            const response = await fetch(`/Review/Stats/@Model.TourID`);
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('reviewCountDisplay').textContent = data.data.totalReviews;
                document.getElementById('reviewCountBadge').textContent = data.data.totalReviews;
                document.getElementById('averageRatingDisplay').textContent = data.data.averageRating.toFixed(1);
                
                // Update stars
                const starsContainer = document.getElementById('averageStarsDisplay');
                starsContainer.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    const starClass = i <= Math.round(data.data.averageRating) ? 'text-warning' : 'text-muted opacity-25';
                    starsContainer.innerHTML += `<i class="bi bi-star-fill ${starClass}"></i>`;
                }
            }
        } catch (error) {
            console.error('Error updating stats:', error);
        }
    }

    // Populate review form with existing data
    function populateReviewForm(review) {
        document.getElementById('editReviewId').value = review.reviewID;
        document.querySelector(`input[name="rating"][value="${review.rating}"]`).checked = true;
        document.getElementById('reviewComment').value = review.comment || '';
        document.getElementById('btnSubmitReviewText').textContent = 'Cập nhật đánh giá';
    }

    // Reset review form
    function resetReviewForm() {
        const form = document.getElementById('reviewSubmissionForm');
        if (form) form.reset();
        
        const editId = document.getElementById('editReviewId');
        if (editId) editId.value = '';
        
        const alert = document.getElementById('reviewFormAlert');
        if (alert) alert.classList.add('d-none');
        
        const btnText = document.getElementById('btnSubmitReviewText');
        if (btnText) btnText.textContent = 'Gửi';
    }

    // Show alert in form
    function showAlert(message, type) {
        const alert = document.getElementById('reviewFormAlert');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alert.classList.remove('d-none');
        
        setTimeout(() => alert.classList.add('d-none'), 5000);
    }

    // Edit review function (called from UI)
    function editReview(reviewId, rating, comment) {
        document.getElementById('editReviewId').value = reviewId;
        document.querySelector(`input[name="rating"][value="${rating}"]`).checked = true;
        document.getElementById('reviewComment').value = comment || '';
        // document.getElementById('reviewFormTitle').textContent = 'Chỉnh sửa đánh giá của bạn';
        document.getElementById('btnSubmitReviewText').textContent = 'Cập nhật đánh giá';
        // document.getElementById('reviewFormCard').classList.remove('d-none');
        document.getElementById('reviewSubmissionForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Delete review function (called from UI)
    async function deleteReview(reviewId) {
        if (!confirm('Bạn có chắc chắn muốn xóa đánh giá này?')) {
            return;
        }

        try {
            // Pass tourId in query string for broadcasting
            const response = await fetch(`/Review/Delete/${reviewId}?tourId=@Model.TourID`, {
                method: 'DELETE'
            });
            
            const result = await response.json();

            if (result.success) {
                // Alert handled by WebSocket or just simple toast
                // alert('Xóa đánh giá thành công!');
                // No need to reload, WebSocket will handle removal
                // But for the user who deleted, we can remove immediately
                removeReviewFromUI(reviewId);
            } else {
                alert(result.message || 'Đã xảy ra lỗi khi xóa đánh giá');
            }
        } catch (error) {
            console.error('Error deleting review:', error);
            alert('Đã xảy ra lỗi khi xóa đánh giá');
        }
    }
</script>

