@model List<TourViet.ViewModels.BookingViewModel>

@{
    ViewData["Title"] = "L·ªãch s·ª≠ ƒë·∫∑t tour";
    Layout = "_Layout";
    var isLoggedIn = Context.Session.GetString("UserId") != null;
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="bi bi-clock-history text-primary me-2"></i>L·ªãch s·ª≠ ƒë·∫∑t tour
                </h1>
                @if (isLoggedIn && Model != null)
                {
                    <span class="badge bg-primary rounded-pill px-3 py-2">
                        <i class="bi bi-list-check me-2"></i>@Model.Count tour ƒë√£ ƒë·∫∑t
                    </span>
                }
            </div>
        </div>
    </div>

    @if (!isLoggedIn)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body p-5 text-center">
                <i class="bi bi-lock-fill text-muted mb-3" style="font-size: 4rem;"></i>
                <h5 class="text-muted">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p</h5>
                <p class="text-muted mb-4">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem l·ªãch s·ª≠ ƒë·∫∑t tour c·ªßa b·∫°n.</p>
                <a asp-controller="Account" asp-action="Login" class="btn btn-primary px-4">
                    <i class="bi bi-box-arrow-in-right me-2"></i>ƒêƒÉng nh·∫≠p ngay
                </a>
            </div>
        </div>
    }
    else if (Model == null || !Model.Any())
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body p-5 text-center">
                <i class="bi bi-calendar-x text-muted mb-3" style="font-size: 4rem;"></i>
                <h5 class="text-muted">B·∫°n ch∆∞a ƒë·∫∑t tour n√†o</h5>
                <p class="text-muted mb-4">H√£y kh√°m ph√° c√°c tour h·∫•p d·∫´n c·ªßa ch√∫ng t√¥i v√† ƒë·∫∑t ngay h√¥m nay!</p>
                <a asp-controller="Home" asp-action="Index" class="btn btn-primary">
                    <i class="bi bi-search me-2"></i>Kh√°m ph√° tour
                </a>
            </div>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <!-- Search and Filter Section -->
                <div class="row mb-4">
                    <div class="col-md-6 mb-2 mb-md-0">
                        <div class="d-flex align-items-center">
                            <label for="entriesPerPage" class="me-2 mb-0 text-muted">
                                <i class="bi bi-list-ol me-1"></i>Hi·ªÉn th·ªã:
                            </label>
                            <select id="entriesPerPage" class="form-select form-select-sm shadow-sm" style="width: auto;">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="75">75</option>
                                <option value="100">100</option>
                            </select>
                            <span class="ms-2 text-muted">b·∫£n ghi</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group shadow-sm">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" id="searchInput" class="form-control border-start-0" 
                                   placeholder="T√¨m ki·∫øm theo m√£ tour, t√™n tour..." aria-label="Search">
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="bookingHistoryTable">
                        <thead class="table-light">
                            <tr>
                                <th class="px-4 border-0">M√£ ƒë·∫∑t tour</th>
                                <th class="border-0">Tour</th>
                                <th class="border-0">Th·ªùi gian</th>
                                <th class="border-0">Chi ph√≠</th>
                                <th class="border-0">Tr·∫°ng th√°i</th>
                                <th class="text-center border-0">Chi ti·∫øt</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var booking in Model)
                            {
                                <tr>
                                    <td class="px-4">
                                        <strong class="text-primary">@booking.BookingRef</strong>
                                        <small class="text-muted d-block">ƒê·∫∑t ng√†y: @booking.FormattedCreatedAt</small>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            @if (!string.IsNullOrEmpty(booking.TourImageUrl))
                                            {
                                                <img src="@booking.TourImageUrl" alt="@booking.TourName" class="rounded me-2" style="width: 50px; height: 50px; object-fit: cover;">
                                            }
                                            <div>
                                                <strong class="d-block text-truncate" style="max-width: 200px;">@booking.TourName</strong>
                                                <small class="text-muted">
                                                    <i class="bi bi-geo-alt me-1"></i>@booking.LocationName
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong class="d-block" data-order="@booking.StartDate.Ticks">@booking.FormattedStartDate</strong>
                                            <small class="text-muted">@booking.DurationDays ng√†y</small>
                                        </div>
                                    </td>
                                    <td>
                                        <strong class="text-primary">@booking.FormattedTotalAmount</strong>
                                        <small class="text-muted d-block">@booking.Seats ng∆∞·ªùi</small>
                                    </td>
                                    <td>
                                        <span class="badge @booking.StatusBadgeClass">
                                            <i class="bi @booking.StatusIcon me-1"></i>@booking.Status
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="@($"#detailsModal{booking.BookingID}")"
                                                title="Xem chi ti·∫øt">
                                            <i class="bi bi-eye me-1"></i>Xem
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<!-- Modals (Placed outside the table for valid HTML) -->
@if (Model != null)
{
    @foreach (var item in Model)
    {
        var booking = item; // Copy to local variable to create proper closure
        <div class="modal fade" id="@($"detailsModal{booking.BookingID}")" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-gradient bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-file-text me-2"></i>Chi ti·∫øt ƒë·∫∑t tour: @booking.BookingRef
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <!-- Carousel Section -->
                        @if (booking.TourImages != null && booking.TourImages.Any())
                        {
                            <div id="carouselBooking@booking.BookingID" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-indicators">
                                    @for (int i = 0; i < booking.TourImages.Count; i++)
                                    {
                                        <button type="button" data-bs-target="#carouselBooking@booking.BookingID" data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")" aria-label="Slide @(i + 1)"></button>
                                    }
                                </div>
                                <div class="carousel-inner">
                                    @for (int i = 0; i < booking.TourImages.Count; i++)
                                    {
                                        <div class="carousel-item @(i == 0 ? "active" : "")">
                                            <img src="@booking.TourImages[i]" class="d-block w-100" style="height: 300px; object-fit: cover;" alt="Tour Image @(i + 1)">
                                        </div>
                                    }
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#carouselBooking@booking.BookingID" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carouselBooking@booking.BookingID" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(booking.TourImageUrl))
                        {
                             <img src="@booking.TourImageUrl" class="d-block w-100" style="height: 300px; object-fit: cover;" alt="@booking.TourName">
                        }

                        <div class="p-4">
                            <!-- Status Banner -->
                            @{
                                var statusLower = booking.Status?.ToLower() ?? "";
                                var statusClass = statusLower switch
                                {
                                    "confirmed" => "alert-success",
                                    "cancelled" => "alert-danger",
                                    "pending" => "alert-warning",
                                    "completed" => "alert-info",
                                    "rejected" => "alert-secondary",
                                    _ => "alert-secondary"
                                };
                            }
                            <div class="alert @statusClass mb-4 d-flex align-items-center shadow-sm">
                                <i class="bi @booking.StatusIcon fs-4 me-3"></i>
                                <div>
                                    <h6 class="alert-heading fw-bold mb-1">Tr·∫°ng th√°i: @booking.Status</h6>
                                    <p class="mb-0 small">
                                        @if (statusLower == "pending") {
                                            <span>ƒê∆°n ƒë·∫∑t tour c·ªßa b·∫°n ƒëang ch·ªù x√°c nh·∫≠n. Ch√∫ng t√¥i s·∫Ω li√™n h·ªá s·ªõm nh·∫•t.</span>
                                        } else if (statusLower == "confirmed") {
                                            <span>ƒê∆°n ƒë·∫∑t tour ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n. Vui l√≤ng thanh to√°n!</span>
                                        } else if (statusLower == "cancelled") {
                                            <span>ƒê∆°n ƒë·∫∑t tour ƒë√£ b·ªã h·ªßy.</span>
                                        } else if (statusLower == "completed") {
                                            <span>Thanh to√°n th√†nh c√¥ng. Ch√∫c b·∫°n c√≥ chuy·∫øn ƒëi vui v·∫ª!</span>
                                        }
                                        else if (statusLower == "rejected") {
                                            <span>ƒê∆°n ƒë·∫∑t tour ƒë√£ b·ªã t·ª´ ch·ªëi.</span>
                                        } else {
                                            <span>Tr·∫°ng th√°i hi·ªán t·∫°i: @booking.Status</span>
                                        }
                                    </p>
                                </div>
                            </div>

                            <div class="row g-4">
                                <!-- Left Column: Tour Info -->
                                <div class="col-md-7">
                                    <div class="card border-0 bg-light h-100 shadow-sm">
                                        <div class="card-body">
                                            <h6 class="fw-bold mb-3 border-bottom pb-2 text-primary">
                                                <i class="bi bi-geo-alt me-2"></i>Th√¥ng tin chuy·∫øn ƒëi
                                            </h6>
                                            
                                            <h5 class="card-title text-dark mb-1">@booking.TourName</h5>
                                            <p class="card-text small text-muted mb-3">@booking.TourCategory</p>
                                            
                                            <div class="row g-3 small">
                                                <div class="col-6">
                                                    <span class="text-muted d-block">Kh·ªüi h√†nh:</span>
                                                    <strong class="text-dark">@booking.FormattedStartDate</strong>
                                                </div>
                                                <div class="col-6">
                                                    <span class="text-muted d-block">K·∫øt th√∫c:</span>
                                                    <strong class="text-dark">@booking.FormattedEndDate</strong>
                                                </div>
                                                <div class="col-6">
                                                    <span class="text-muted d-block">Th·ªùi gian:</span>
                                                    <strong class="text-dark">@booking.DurationDays ng√†y</strong>
                                                </div>
                                                <div class="col-6">
                                                    <span class="text-muted d-block">N∆°i kh·ªüi h√†nh:</span>
                                                    <strong class="text-dark">@booking.City</strong>
                                                </div>
                                                <div class="col-12">
                                                    <span class="text-muted d-block">H∆∞·ªõng d·∫´n vi√™n:</span>
                                                    <strong class="text-dark">@(string.IsNullOrEmpty(booking.GuideName) ? "ƒêang c·∫≠p nh·∫≠t" : booking.GuideName)</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right Column: Booking Details -->
                                <div class="col-md-5">
                                    <!-- Contact Info -->
                                    <div class="card border-0 bg-light mb-3 shadow-sm">
                                        <div class="card-body">
                                            <h6 class="fw-bold mb-3 border-bottom pb-2 text-primary">
                                                <i class="bi bi-person-lines-fill me-2"></i>Li√™n h·ªá
                                            </h6>
                                            <ul class="list-unstyled small mb-0">
                                                <li class="mb-2">
                                                    <i class="bi bi-person me-2 text-muted"></i>@booking.CustomerName
                                                </li>
                                                <li class="mb-2">
                                                    <i class="bi bi-envelope me-2 text-muted"></i>@booking.CustomerEmail
                                                </li>
                                                <li class="mb-2">
                                                    <i class="bi bi-telephone me-2 text-muted"></i>@booking.CustomerPhone
                                                </li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- Special Requests -->
                                    @if (!string.IsNullOrEmpty(booking.SpecialRequests))
                                    {
                                        <div class="card border-0 bg-light mb-3 shadow-sm">
                                            <div class="card-body">
                                                <h6 class="fw-bold mb-2 border-bottom pb-2 text-primary">
                                                    <i class="bi bi-chat-quote me-2"></i>Ghi ch√∫
                                                </h6>
                                                <p class="mb-0 small fst-italic text-dark">"@booking.SpecialRequests"</p>
                                            </div>
                                        </div>
                                    }
                                </div>
                                
                                <!-- Payment & Services (Full Width) -->
                                <div class="col-12">
                                    <div class="card border-0 bg-white shadow-sm border-start border-4 border-primary">
                                        <div class="card-body">
                                            <h6 class="fw-bold mb-3 text-primary">
                                                <i class="bi bi-receipt me-2"></i>Chi ti·∫øt thanh to√°n
                                            </h6>
                                            
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Gi√° tour c∆° b·∫£n (@booking.Seats ng∆∞·ªùi)</span>
                                                <strong>@booking.BasePriceTotal.ToString("N0") @booking.Currency</strong>
                                            </div>

                                            @if (booking.BookedServices != null && booking.BookedServices.Any())
                                            {
                                                <div class="my-3 p-3 bg-light rounded">
                                                    <h6 class="small fw-bold text-muted mb-2">D·ªãch v·ª• b·ªï sung:</h6>
                                                    @foreach (var service in booking.BookedServices)
                                                    {
                                                        <div class="d-flex justify-content-between small mb-1">
                                                            <span>
                                                                <i class="bi bi-check2-circle text-success me-1"></i>
                                                                @service.ServiceName <span class="text-muted">(x@service.Quantity)</span>
                                                            </span>
                                                            <span>@service.FormattedSubTotal</span>
                                                        </div>
                                                    }
                                                </div>
                                            }

                                            @if (booking.DiscountAmount.HasValue && booking.DiscountAmount > 0)
                                            {
                                                <hr class="my-3" />
                                                
                                                <div class="d-flex justify-content-between mb-1 small text-muted">
                                                    <span>T·ªïng tr∆∞·ªõc gi·∫£m:</span>
                                                    <span class="text-decoration-line-through">@booking.FormattedSubTotalBeforeDiscount</span>
                                                </div>
                                                
                                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-success bg-opacity-10 rounded">
                                                    <div class="d-flex align-items-center">
                                                        <i class="bi bi-tag-fill text-success me-2"></i>
                                                        <div>
                                                            <strong class="text-success">Gi·∫£m gi√°: @booking.PromotionName</strong>
                                                            @if (!string.IsNullOrEmpty(booking.CouponCode))
                                                            {
                                                                <br />
                                                                <small class="text-muted">
                                                                    M√£: <span class="badge bg-success">@booking.CouponCode</span>
                                                                </small>
                                                            }
                                                        </div>
                                                    </div>
                                                    <strong class="text-success">@booking.FormattedDiscountAmount</strong>
                                                </div>
                                            }

                                            <hr class="my-3" />
                                            
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="fw-bold fs-5 text-dark">T·ªïng c·ªông</span>
                                                <span class="fw-bold fs-4 text-primary">@booking.FormattedTotalAmount</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light d-flex justify-content-between">
                        <div>
                            @if (booking.IsPaid || booking.Status == "Completed")
                            {
                                <button type="button" class="btn btn-outline-danger me-2" onclick="generatePDF('@booking.BookingID')">
                                    <i class="bi bi-file-earmark-pdf me-2"></i>T·∫£i h√≥a ƒë∆°n PDF
                                </button>
                            }
                            else if (booking.Status == "Confirmed")
                            {
                                <button type="button" class="btn btn-success me-2" onclick="payBooking('@booking.BookingID', '@booking.FormattedTotalAmount')">
                                    <i class="bi bi-credit-card me-2"></i>Thanh to√°n ngay
                                </button>
                            }

                            @if (booking.Status == "Pending" || (booking.Status == "Confirmed" && !booking.IsPaid))
                            {
                                <button type="button" class="btn btn-danger" onclick="cancelBooking('@booking.BookingID')">
                                    <i class="bi bi-x-circle me-2"></i>H·ªßy ƒë·∫∑t tour
                                </button>
                            }
                        </div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden Invoice Template for PDF Generation -->
        @if (booking.IsPaid || booking.Status == "Completed")
        {
            <div id="invoice-@booking.BookingID" class="d-none">
                <div style="padding: 40px; font-family: 'Times New Roman', serif; color: #000; background: #fff;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px;">
                        <div>
                            <h1 style="margin: 0; font-size: 28px; font-weight: bold; color: #0d6efd;">TOUR VIET</h1>
                            <p style="margin: 5px 0 0; font-size: 14px;">Kh√°m ph√° v·∫ª ƒë·∫πp Vi·ªát Nam</p>
                        </div>
                        <div style="text-align: right;">
                            <h2 style="margin: 0; font-size: 24px; text-transform: uppercase;">H√≥a ƒê∆°n</h2>
                            <p style="margin: 5px 0 0; font-size: 14px;">M√£ ƒë·∫∑t tour: <strong>@booking.BookingRef</strong></p>
                            <p style="margin: 5px 0 0; font-size: 14px;">Ng√†y: @booking.FormattedCreatedAt</p>
                        </div>
                    </div>

                    <!-- Info Section -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        <div style="width: 48%;">
                            <h3 style="font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">Kh√°ch h√†ng</h3>
                            <p style="margin: 0 0 5px;"><strong>@booking.CustomerName</strong></p>
                            <p style="margin: 0 0 5px;">Email: @booking.CustomerEmail</p>
                            <p style="margin: 0 0 5px;">SƒêT: @booking.CustomerPhone</p>
                        </div>
                        <div style="width: 48%;">
                            <h3 style="font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">Th√¥ng tin Tour</h3>
                            <p style="margin: 0 0 5px;"><strong>@booking.TourName</strong></p>
                            <p style="margin: 0 0 5px;">Kh·ªüi h√†nh: @booking.FormattedStartDate</p>
                            <p style="margin: 0 0 5px;">Th·ªùi gian: @booking.DurationDays ng√†y</p>
                        </div>
                    </div>

                    <!-- Table -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left;">M√¥ t·∫£</th>
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: center;">S·ªë l∆∞·ª£ng</th>
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">ƒê∆°n gi√°</th>
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border: 1px solid #dee2e6; padding: 12px;">
                                    <strong>V√© Tour C∆° B·∫£n</strong>
                                    <br><small style="color: #6c757d;">@booking.TourName</small>
                                </td>
                                <td style="border: 1px solid #dee2e6; padding: 12px; text-align: center;">@booking.Seats</td>
                                <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">@booking.BasePrice.ToString("N0") @booking.Currency</td>
                                <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">@booking.BasePriceTotal.ToString("N0") @booking.Currency</td>
                            </tr>
                            @if (booking.BookedServices != null)
                            {
                                foreach (var service in booking.BookedServices)
                                {
                                    <tr>
                                        <td style="border: 1px solid #dee2e6; padding: 12px;">
                                            <strong>@service.ServiceName</strong>
                                        </td>
                                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: center;">@service.Quantity</td>
                                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">@service.PriceAtBooking.ToString("N0") @service.Currency</td>
                                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">@service.SubTotal.ToString("N0") @service.Currency</td>
                                    </tr>
                                }
                            }
                            
                            @* Promotion Discount Rows *@
                            @if (booking.DiscountAmount.HasValue && booking.DiscountAmount > 0)
                            {
                                @* Subtotal before discount *@
                                <tr>
                                    <td colspan="3" style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">T·ªïng tr∆∞·ªõc gi·∫£m</td>
                                    <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">@booking.FormattedSubTotalBeforeDiscount</td>
                                </tr>
                                
                                @* Discount row *@
                                <tr style="background-color: #fff3cd;">
                                    <td colspan="3" style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">
                                        <strong style="color: #28a745;">üéÅ Gi·∫£m gi√°: @booking.PromotionName</strong>
                                        @if (!string.IsNullOrEmpty(booking.CouponCode))
                                        {
                                            <br><small style="color: #6c757d;">M√£: @booking.CouponCode</small>
                                        }
                                    </td>
                                    <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right; color: #28a745; font-weight: bold;">@booking.FormattedDiscountAmount</td>
                                </tr>
                            }
                            
                            <tr style="background-color: #f8f9fa; font-weight: bold;">
                                <td colspan="3" style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">T·ªïng c·ªông</td>
                                <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right; color: #dc3545;">@booking.FormattedTotalAmount</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Footer -->
                    <div style="text-align: center; margin-top: 50px; color: #6c757d; font-size: 14px;">
                        <p>C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª• c·ªßa TourViet!</p>
                        <p>M·ªçi th·∫Øc m·∫Øc xin vui l√≤ng li√™n h·ªá hotline: 1900 1234</p>
                    </div>
                </div>
            </div>
        }
    }
}

<!-- Cancellation Confirmation Modal -->
<div class="modal fade" id="cancelConfirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>X√°c nh·∫≠n h·ªßy tour
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <p class="mb-0">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n ƒë·∫∑t tour n√†y kh√¥ng?</p>
                <p class="text-muted small mt-2">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
            </div>
            <div class="modal-footer border-0 bg-light justify-content-center">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Kh√¥ng, gi·ªØ l·∫°i</button>
                <button type="button" class="btn btn-danger px-4" id="confirmCancelBtn">
                    <i class="bi bi-x-circle me-2"></i>C√≥, h·ªßy ngay
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0" id="notificationHeader">
                <h5 class="modal-title text-white" id="notificationTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div id="notificationIcon" class="mb-3" style="font-size: 3rem;"></div>
                <p id="notificationMessage" class="mb-0 fw-bold"></p>
            </div>
            <div class="modal-footer border-0 bg-light justify-content-center">
                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white border-0">
                <h5 class="modal-title">
                    <i class="bi bi-credit-card-2-front-fill me-2"></i>Thanh to√°n ƒë∆°n h√†ng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" id="closePaymentModalBtn"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div id="paymentProcessing">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="mb-2">ƒêang x·ª≠ l√Ω thanh to√°n...</h5>
                    <p class="text-muted small">Vui l√≤ng kh√¥ng t·∫Øt tr√¨nh duy·ªát.</p>
                </div>
                <div id="paymentSuccess" class="d-none">
                    <div class="mb-3">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="fw-bold text-success mb-2">Thanh to√°n th√†nh c√¥ng!</h4>
                    <p class="text-muted mb-4">C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n. H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ƒë√£ s·∫µn s√†ng.</p>
                    <button type="button" class="btn btn-primary px-4 rounded-pill" onclick="location.reload()">
                        <i class="bi bi-check-lg me-2"></i>Ho√†n t·∫•t
                    </button>
                </div>
                <div id="paymentError" class="d-none">
                    <div class="mb-3">
                        <i class="bi bi-x-circle-fill text-danger" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="fw-bold text-danger mb-2">Thanh to√°n th·∫•t b·∫°i!</h4>
                    <p class="text-muted mb-4" id="paymentErrorMessage">ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh x·ª≠ l√Ω.</p>
                    <button type="button" class="btn btn-secondary px-4 rounded-pill" data-bs-dismiss="modal">
                        ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- DataTables CSS and JS from CDN -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        $(document).ready(function() {
            if($.fn.DataTable) { // Check if DataTable is initialized
                var table = $('#bookingHistoryTable').DataTable({
                    "language": {
                        "search": "T√¨m ki·∫øm:",
                        "zeroRecords": "Kh√¥ng t√¨m th·∫•y ƒë∆°n ƒë·∫∑t tour n√†o ph√π h·ª£p",
                        "paginate": {
                            "first": "ƒê·∫ßu",
                            "last": "Cu·ªëi",
                            "next": "Sau",
                            "previous": "Tr∆∞·ªõc"
                        },
                        "aria": {
                            "sortAscending": ": s·∫Øp x·∫øp tƒÉng d·∫ßn",
                            "sortDescending": ": s·∫Øp x·∫øp gi·∫£m d·∫ßn"
                        }
                    },
                    "pageLength": 25,
                    "lengthMenu": [[25, 50, 75, 100], [25, 50, 75, 100]],
                    "responsive": true,
                    "dom": '<"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    "order": [[0, 'desc']] // Sort by BookingRef (or Date)
                });
                
                // Custom search input
                $('#searchInput').on('keyup', function() {
                    table.search(this.value).draw();
                });
                
                // Custom entries per page selector
                $('#entriesPerPage').on('change', function() {
                    table.page.len(parseInt(this.value)).draw();
                });
            }
        });

        function generatePDF(bookingId) {
            // Get the element
            var element = document.getElementById('invoice-' + bookingId);
            
            // Configure html2pdf options
            var opt = {
                margin:       10,
                filename:     'HoaDon_TourViet_' + bookingId + '.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Temporarily remove d-none class to render
            element.classList.remove('d-none');
            
            // Generate
            html2pdf().set(opt).from(element).save().then(function() {
                // Add d-none back
                element.classList.add('d-none');
            });
        }

        let bookingIdToCancel = null;

        function cancelBooking(bookingId) {
            bookingIdToCancel = bookingId;
            // Hide the details modal if it's open
            const detailsModalEl = document.getElementById('detailsModal' + bookingId);
            if (detailsModalEl) {
                const detailsModal = bootstrap.Modal.getInstance(detailsModalEl);
                if (detailsModal) {
                    detailsModal.hide();
                }
            }
            
            // Show confirmation modal
            const confirmModal = new bootstrap.Modal(document.getElementById('cancelConfirmationModal'));
            confirmModal.show();
        }

        document.getElementById('confirmCancelBtn').addEventListener('click', function() {
            if (!bookingIdToCancel) return;

            // Hide confirmation modal
            const confirmModalEl = document.getElementById('cancelConfirmationModal');
            const confirmModal = bootstrap.Modal.getInstance(confirmModalEl);
            confirmModal.hide();

            fetch(`/api/booking/cancel/${bookingIdToCancel}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                showNotification(data.success, data.message);
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification(false, 'ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi.');
            });
        });

        function showNotification(isSuccess, message) {
            const modal = document.getElementById('notificationModal');
            const header = document.getElementById('notificationHeader');
            const title = document.getElementById('notificationTitle');
            const msg = document.getElementById('notificationMessage');
            const icon = document.getElementById('notificationIcon');

            if (isSuccess) {
                header.className = 'modal-header bg-success border-0';
                title.textContent = 'Th√†nh c√¥ng';
                title.className = 'modal-title text-white';
                icon.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                msg.textContent = message;
                
                // Reload page when modal is closed
                modal.addEventListener('hidden.bs.modal', function () {
                    location.reload();
                }, { once: true });
            } else {
                header.className = 'modal-header bg-danger border-0';
                title.textContent = 'Th·∫•t b·∫°i';
                title.className = 'modal-title text-white';
                icon.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>';
                msg.textContent = message;
            }

            const notifModal = new bootstrap.Modal(modal);
            notifModal.show();
        }

        function payBooking(bookingId, amount) {
            // Hide details modal
            const detailsModalEl = document.getElementById('detailsModal' + bookingId);
            if (detailsModalEl) {
                const detailsModal = bootstrap.Modal.getInstance(detailsModalEl);
                if (detailsModal) {
                    detailsModal.hide();
                }
            }

            // Show payment modal
            const paymentModalEl = document.getElementById('paymentModal');
            const paymentModal = new bootstrap.Modal(paymentModalEl);
            
            // Reset state
            document.getElementById('paymentProcessing').classList.remove('d-none');
            document.getElementById('paymentSuccess').classList.add('d-none');
            document.getElementById('paymentError').classList.add('d-none');
            document.getElementById('closePaymentModalBtn').disabled = true;
            
            paymentModal.show();

            // Simulate processing delay
            setTimeout(() => {
                fetch(`/api/booking/pay/${bookingId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('paymentProcessing').classList.add('d-none');
                    document.getElementById('closePaymentModalBtn').disabled = false;
                    
                    if (data.success) {
                        document.getElementById('paymentSuccess').classList.remove('d-none');
                    } else {
                        document.getElementById('paymentError').classList.remove('d-none');
                        document.getElementById('paymentErrorMessage').textContent = data.message || 'ƒê√£ x·∫£y ra l·ªói.';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('paymentProcessing').classList.add('d-none');
                    document.getElementById('closePaymentModalBtn').disabled = false;
                    document.getElementById('paymentError').classList.remove('d-none');
                    document.getElementById('paymentErrorMessage').textContent = 'ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi.';
                });
            }, 2000); // 2 seconds delay for simulation
        }
    </script>
}

<style>
    .table > :not(caption) > * > * {
        padding: 1rem 0.75rem;
    }
    
    .table tbody tr {
        transition: all 0.3s ease;
    }
    
    .table tbody tr:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .input-group:focus-within .input-group-text {
        border-color: #0d6efd;
    }
    
    .input-group .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
</style>
