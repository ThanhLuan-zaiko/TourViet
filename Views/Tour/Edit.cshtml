@{
    ViewData["Title"] = "Chỉnh sửa Tour";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model TourViet.Models.Tour

@{
    var locations = ViewBag.Locations as IEnumerable<TourViet.Models.Location>;
    var categories = ViewBag.Categories as IEnumerable<TourViet.Models.Category>;
    var guides = ViewBag.Guides as IEnumerable<TourViet.Models.User>;
    var countries = ViewBag.Countries as IEnumerable<TourViet.Models.Country>;
    var services = ViewBag.Services as IEnumerable<TourViet.Models.Service>;
}

<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-1 text-gray-800">
                <i class="fas fa-edit text-primary me-2"></i>Chỉnh Sửa Tour
            </h1>
            <p class="text-muted mb-0">
                <small>Cập nhật thông tin cho tour: @Model.TourName</small>
            </p>
        </div>
        <a asp-controller="Home" asp-action="ManageTours" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Quay lại
        </a>
    </div>

    <form asp-action="Edit" method="post" enctype="multipart/form-data">
        <input type="hidden" asp-for="TourID" />
        <div asp-validation-summary="All" class="text-danger mb-3"></div>
        
        <!-- Location & Map Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-info text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-map-marked-alt me-2"></i>Quốc Gia & Địa Điểm
                </h6>
            </div>
            <div class="card-body p-4">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="countryName" class="form-label fw-bold">
                            <i class="fas fa-globe text-primary me-1"></i>Quốc gia
                        </label>
                        <input type="text" id="countryName" name="NewCountryName" class="form-control" placeholder="Click vào bản đồ để chọn" readonly />
                    </div>
                    <div class="col-md-6">
                        <label for="city" class="form-label fw-bold">
                            <i class="fas fa-city text-info me-1"></i>Thành phố
                        </label>
                        <input type="text" id="city" name="NewLocationCity" class="form-control" placeholder="Tự động điền từ bản đồ" readonly />
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-map-location-dot text-danger me-1"></i>Chọn vị trí trên bản đồ
                    </label>
                    <div id="map" style="height: 400px; border-radius: 0.5rem; border: 2px solid #e3e6f0;"></div>
                    <small class="text-muted mt-1 d-block">
                        <i class="fas fa-info-circle me-1"></i>
                        Click vào bản đồ để thay đổi vị trí. Marker hiện tại hiển thị địa điểm đã chọn trước đó.
                    </small>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="NewLocationName" class="form-label fw-bold">
                            <i class="fas fa-map-pin text-success me-1"></i>Tên địa điểm
                        </label>
                        <input type="text" id="NewLocationName" name="NewLocationName" class="form-control" readonly />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="NewLocationAddress" class="form-label fw-bold">
                            <i class="fas fa-location-dot text-warning me-1"></i>Địa chỉ cụ thể
                        </label>
                        <input type="text" id="NewLocationAddress" name="NewLocationAddress" class="form-control" readonly />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="NewLocationLatitude" class="form-label fw-bold">Vĩ độ</label>
                        <input type="number" id="NewLocationLatitude" name="NewLocationLatitude" class="form-control" step="any" readonly />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="NewLocationLongitude" class="form-label fw-bold">Kinh độ</label>
                        <input type="number" id="NewLocationLongitude" name="NewLocationLongitude" class="form-control" step="any" readonly />
                    </div>
                </div>

                <div>
                    <label for="NewLocationDescription" class="form-label fw-bold">
                        <i class="fas fa-align-left text-info me-1"></i>Mô tả địa điểm
                    </label>
                    <textarea id="NewLocationDescription" name="NewLocationDescription" class="form-control" rows="2"></textarea>
                </div>
            </div>
        </div>

        <!-- Tour Info Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-primary text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-info-circle me-2"></i>Thông Tin Tour
                </h6>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="TourName" class="form-label fw-bold">
                            <i class="fas fa-tag text-primary me-1"></i>Tên Tour <span class="text-danger">*</span>
                        </label>
                        <input asp-for="TourName" class="form-control" />
                        <span asp-validation-for="TourName" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="Slug" class="form-label fw-bold">
                            <i class="fas fa-link text-info me-1"></i>Slug (URL thân thiện)
                        </label>
                        <input asp-for="Slug" class="form-control" />
                        <span asp-validation-for="Slug" class="text-danger small"></span>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="ShortDescription" class="form-label fw-bold">
                        <i class="fas fa-align-left text-success me-1"></i>Mô tả ngắn
                    </label>
                    <input asp-for="ShortDescription" class="form-control" />
                    <span asp-validation-for="ShortDescription" class="text-danger small"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Description" class="form-label fw-bold">
                        <i class="fas fa-file-alt text-warning me-1"></i>Mô tả chi tiết
                    </label>
                    <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                    <span asp-validation-for="Description" class="text-danger small"></span>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="CategoryID" class="form-label fw-bold">
                            <i class="fas fa-folder text-warning me-1"></i>Danh mục
                        </label>
                        <select asp-for="CategoryID" class="form-select" asp-items="@(categories != null ? new SelectList(categories, "CategoryID", "CategoryName") : new SelectList(new List<TourViet.Models.Category>(), "CategoryID", "CategoryName"))">
                            <option value="">-- Chọn danh mục --</option>
                        </select>
                        <span asp-validation-for="CategoryID" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="DefaultGuideID" class="form-label fw-bold">
                            <i class="fas fa-user-tie text-success me-1"></i>Hướng dẫn viên mặc định
                        </label>
                        <select asp-for="DefaultGuideID" class="form-select" asp-items="@(guides != null ? new SelectList(guides, "UserID", "FullName") : new SelectList(new List<TourViet.Models.User>(), "UserID", "FullName"))">
                            <option value="">-- Chọn hướng dẫn viên --</option>
                        </select>
                        <span asp-validation-for="DefaultGuideID" class="text-danger small"></span>
                    </div>
                </div>

                <div class="form-check p-3 bg-light rounded">
                    <input class="form-check-input" asp-for="IsPublished" />
                    <label class="form-check-label fw-bold">
                        <i class="fas fa-eye text-primary me-1"></i>Đăng tour công khai
                        <small class="d-block text-muted fw-normal">Cho phép khách hàng xem và đặt tour này</small>
                    </label>
                </div>
            </div>
        </div>

        <!-- Tour Instances Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-success text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-calendar-days me-2"></i>Lịch Khởi Hành
                </h6>
            </div>
            <div class="card-body p-4">
                <div id="tour-instances-container">
                    @if (Model.TourInstances != null && Model.TourInstances.Any())
                    {
                        int instIndex = 0;
                        foreach (var instance in Model.TourInstances.OrderBy(i => i.StartDate))
                        {
                            <div class="tour-instance-item mb-4 p-3 border rounded bg-light">
                                <input type="hidden" name="TourInstances[@instIndex].InstanceID" value="@instance.InstanceID" />
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-calendar-check text-success me-1"></i>Ngày bắt đầu</label>
                                        <input type="date" name="TourInstances[@instIndex].StartDate" class="form-control" value="@instance.StartDate.ToString("yyyy-MM-dd")" required />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-calendar-xmark text-danger me-1"></i>Ngày kết thúc</label>
                                        <input type="date" name="TourInstances[@instIndex].EndDate" class="form-control" value="@instance.EndDate.ToString("yyyy-MM-dd")" required />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-users text-info me-1"></i>Sức chứa</label>
                                        <input type="number" name="TourInstances[@instIndex].Capacity" class="form-control" min="0" value="@instance.Capacity" required />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-dollar-sign text-warning me-1"></i>Giá cơ bản</label>
                                        <input type="number" name="TourInstances[@instIndex].PriceBase" class="form-control" min="0" step="0.01" value="@instance.PriceBase" required />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-user-tie text-primary me-1"></i>Hướng dẫn viên</label>
                                        <select name="TourInstances[@instIndex].GuideID" class="form-select" asp-items="@(guides != null ? new SelectList(guides, "UserID", "FullName", instance.GuideID) : new SelectList(new List<TourViet.Models.User>(), "UserID", "FullName"))">
                                            <option value="">-- Chọn HDV --</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger remove-instance"><i class="fas fa-trash me-1"></i>Xóa</button>
                            </div>
                            instIndex++;
                        }
                    }
                </div>
                <button type="button" class="btn btn-outline-success" id="add-instance">
                    <i class="fas fa-plus me-1"></i>Thêm lịch khởi hành
                </button>
            </div>
        </div>

        <!-- Tour Prices Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-warning text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-dollar-sign me-2"></i>Bảng Giá Tour
                </h6>
            </div>
            <div class="card-body p-4">
                <div id="tour-prices-container">
                    @if (Model.TourPrices != null && Model.TourPrices.Any())
                    {
                        int priceIdx = 0;
                        foreach (var price in Model.TourPrices)
                        {
                            <div class="tour-price-item mb-3 p-3 border rounded bg-light">
                                <input type="hidden" name="TourPrices[@priceIdx].TourPriceID" value="@price.TourPriceID" />
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-tag text-info me-1"></i>Loại giá</label>
                                        <select name="TourPrices[@priceIdx].PriceType" class="form-select" required>
                                            <option value="Người lớn" selected="@(price.PriceType == "Người lớn")">Người lớn</option>
                                            <option value="Trẻ em" selected="@(price.PriceType == "Trẻ em")">Trẻ em</option>
                                            <option value="Người cao tuổi" selected="@(price.PriceType == "Người cao tuổi")">Người cao tuổi</option>
                                            <option value="Sinh viên" selected="@(price.PriceType == "Sinh viên")">Sinh viên</option>
                                            <option value="Nhóm" selected="@(price.PriceType == "Nhóm")">Nhóm</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-money-bill-wave text-success me-1"></i>Số tiền</label>
                                        <input type="number" name="TourPrices[@priceIdx].Amount" class="form-control" min="0" step="0.01" value="@price.Amount" required />
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger remove-price"><i class="fas fa-trash me-1"></i>Xóa</button>
                            </div>
                            priceIdx++;
                        }
                    }
                </div>
                <button type="button" class="btn btn-outline-warning" id="add-price">
                    <i class="fas fa-plus me-1"></i>Thêm loại giá
                </button>
            </div>
        </div>

        <!-- Itineraries Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-danger text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-route me-2"></i>Lịch Trình Chi Tiết
                </h6>
            </div>
            <div class="card-body p-4">
                <div id="itineraries-container">
                    @if (Model.Itineraries != null && Model.Itineraries.Any())
                    {
                        int itinIdx = 0;
                        foreach (var itinerary in Model.Itineraries.OrderBy(i => i.DayIndex))
                        {
                            <div class="itinerary-item mb-3 p-3 border rounded bg-light">
                                <input type="hidden" name="Itineraries[@itinIdx].ItineraryID" value="@itinerary.ItineraryID" />
                                <div class="row">
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-hashtag text-primary me-1"></i>Ngày thứ</label>
                                        <input type="number" name="Itineraries[@itinIdx].DayIndex" class="form-control" min="1" value="@itinerary.DayIndex" required />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-heading text-info me-1"></i>Tiêu đề</label>
                                        <input type="text" name="Itineraries[@itinIdx].Title" class="form-control" value="@itinerary.Title" required />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-align-left text-success me-1"></i>Mô tả</label>
                                        <textarea name="Itineraries[@itinIdx].Description" class="form-control" rows="2">@itinerary.Description</textarea>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger remove-itinerary"><i class="fas fa-trash me-1"></i>Xóa</button>
                            </div>
                            itinIdx++;
                        }
                    }
                </div>
                <button type="button" class="btn btn-outline-danger" id="add-itinerary">
                    <i class="fas fa-plus me-1"></i>Thêm ngày
                </button>
            </div>
        </div>

        <!-- Services Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-info text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-concierge-bell me-2"></i>Dịch Vụ Kèm Theo
                </h6>
            </div>
            <div class="card-body p-4">
                @if (services != null && services.Any())
                {
                    <div class="row">
                        @for (int i = 0; i < services.Count(); i++)
                        {
                            var service = services.ElementAt(i);
                            var isChecked = Model.TourServices?.Any(ts => ts.ServiceID == service.ServiceID) ?? false;
                            
                            <div class="col-md-6 mb-2">
                                <div class="form-check p-2 bg-light rounded">
                                    <input type="checkbox" name="TourServiceIds" value="@service.ServiceID" class="form-check-input" id="service_@service.ServiceID" @(isChecked ? "checked" : "") />
                                    <label class="form-check-label" for="service_@service.ServiceID">
                                        <strong>@service.ServiceName</strong>
                                        <small class="d-block text-muted">
                                            <i class="fas fa-money-bill-wave me-1"></i>
                                            @service.Price.ToString("N0") @service.Currency
                                        </small>
                                    </label>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Chưa có dịch vụ nào.
                    </div>
                }
            </div>
        </div>

        <!-- Current Images Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-success text-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-images me-2"></i>Hình Ảnh Hiện Tại
                    </h6>
                    <span id="current-image-count" class="badge bg-white text-success">
                        @(Model.TourImages?.Count ?? 0) ảnh
                    </span>
                </div>
            </div>
            <div class="card-body p-4">
                <div id="current-images-grid" class="row g-3">
                    @if (Model.TourImages != null && Model.TourImages.Any())
                    {
                        @foreach (var image in Model.TourImages.OrderBy(i => i.SortOrder))
                        {
                            <div class="col-md-3" data-image-id="@image.ImageID">
                                <div class="preview-item">
                                    <img src="@image.Url" alt="Tour Image">
                                    <div class="preview-overlay"></div>
                                    <button type="button" class="btn btn-delete-image" 
                                            data-image-id="@image.ImageID" 
                                            data-image-name="@image.FileName"
                                            title="Xóa ảnh">
                                        <span aria-hidden="true">×</span>
                                    </button>
                                    <div class="preview-info">
                                        @if (image.IsPrimary)
                                        {
                                            <span class="badge bg-primary mb-1"><i class="fas fa-star me-1"></i>Ảnh chính</span>
                                        }
                                        <small class="d-block text-truncate">@image.FileName</small>
                                        <small class="text-muted">Thứ tự: @image.SortOrder</small>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12">
                            <div class="alert alert-info text-center mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Chưa có hình ảnh nào. Upload ảnh mới bên dưới.
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Upload New Images Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-warning text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-upload me-2"></i>Upload Hình Ảnh Mới (Real-time)
                </h6>
            </div>
            <div class="card-body p-4">
                <!-- Drag and Drop Zone -->
                <div id="edit-drop-zone" class="drop-zone mb-3">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                    <p class="mb-2"><strong>Kéo và thả hình ảnh vào đây</strong></p>
                    <p class="text-muted mb-2">hoặc</p>
                    <button type="button" id="edit-select-files-btn" class="btn btn-sm btn-warning mb-2">
                        <i class="fas fa-folder-open me-1"></i>Chọn từ máy tính
                    </button>
                    <p class="text-muted small mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        Upload ngay lập tức, không cần submit form. Hỗ trợ: JPG, PNG, GIF, WebP (max 10MB/ảnh)
                    </p>
                </div>
                
                <!-- Hidden file input -->
                <input type="file" id="files" style="display: none;" multiple accept="image/*" />

                <!-- Upload Progress -->
                <div id="upload-progress" class="d-none mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="fas fa-spinner fa-spin me-2"></i>Đang upload...</span>
                        <span id="upload-status"></span>
                    </div>
                    <div class="progress">
                        <div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <a asp-controller="Home" asp-action="ManageTours" class="btn btn-lg btn-light">
                        <i class="fas fa-times me-2"></i>Hủy bỏ
                    </a>
                    <button type="submit" id="edit-tour-submit-btn" class="btn btn-lg btn-primary px-5">
                        <i class="fas fa-save me-2"></i>Cập Nhật Tour
                    </button>
                </div>
            </div>
        </div>
    </form>
    
    <!-- Delete Image Confirmation Modal -->
    <div class="modal fade" id="deleteImageModal" tabindex="-1" aria-labelledby="deleteImageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteImageModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Xác nhận xóa ảnh
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">Bạn có chắc muốn xóa ảnh <strong id="delete-image-name"></strong>?</p>
                    <p class="text-danger small mb-0">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        <strong>Cảnh báo:</strong> Hành động này sẽ xóa cả file vật lý và không thể hoàn tác!
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Hủy bỏ
                    </button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-image">
                        <i class="fas fa-trash me-1"></i>Xóa ảnh
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .bg-gradient-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .bg-gradient-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .bg-gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .bg-gradient-danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .form-control:focus,
    .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .card {
        border-radius: 0.5rem;
    }
    
    #map {
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.1);
    }
    
    /* Drop Zone Styles */
    .drop-zone {
        border: 2px dashed #f093fb;
        border-radius: 0.5rem;
        padding: 3rem 2rem;
        text-align: center;
        background-color: #fffaf0;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .drop-zone:hover,
    .drop-zone.drag-over {
        background-color: #fff3e0;
        border-color: #f5576c;
        transform: scale(1.01);
    }
    
    .drop-zone.drag-over {
        box-shadow: 0 0.5rem 1rem rgba(240, 147, 251, 0.3);
    }
    
    /* Image Preview Styles */
    .preview-item {
        position: relative;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    
    .preview-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .preview-item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
    }
    
    .preview-item .preview-overlay {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.6) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .preview-item:hover .preview-overlay {
        opacity: 1;
    }
    
    .preview-item .btn-delete-image {
        position: absolute;
        top: 8px;
        right: 8px;
        opacity: 1;
        transition: all 0.3s ease;
        z-index: 10;
        background-color: rgba(220, 53, 69, 0.95) !important;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 24px;
        font-weight: 300;
        line-height: 1;
        color: white !important;
    }
    
    .preview-item .btn-delete-image span {
        color: white;
        display: block;
        margin-top: -2px;
    }
    
    .preview-item:hover .btn-delete-image {
        background-color: rgba(220, 53, 69, 1) !important;
        transform: scale(1.15);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.5);
    }
    
    .preview-item .preview-info {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        color: white;
        font-size: 0.875rem;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .preview-item:hover .preview-info {
        opacity: 1;
    }
    
    /* Fade out animation for deleted images */
    @@keyframes fadeOut {
        from {
            opacity: 1;
            transform: scale(1);
        }
        to {
            opacity: 0;
            transform: scale(0.8);
        }
    }
    
    .deleting {
        animation: fadeOut 0.3s ease-out forwards;
    }
</style>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        (function() {
            // Initialize map FIRST
            const map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            let currentMarker = null;

            // Debounce function to limit API calls
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Pre-populate location data
            @if (Model.Location != null)
            {
                @if (Model.Location.Country != null)
                {
                    <text>document.getElementById("countryName").value = "@Html.Raw(Model.Location.Country.CountryName.Replace("\"", "\\\""))";</text>
                }
                @if (!string.IsNullOrEmpty(Model.Location.City))
                {
                    <text>document.getElementById("city").value = "@Html.Raw(Model.Location.City.Replace("\"", "\\\""))";</text>
                }
                @if (!string.IsNullOrEmpty(Model.Location.LocationName))
                {
                    <text>document.getElementById("NewLocationName").value = "@Html.Raw(Model.Location.LocationName.Replace("\"", "\\\""))";</text>
                }
                @if (!string.IsNullOrEmpty(Model.Location.Address))
                {
                    <text>document.getElementById("NewLocationAddress").value = "@Html.Raw(Model.Location.Address.Replace("\"", "\\\""))";</text>
                }
                @if (Model.Location.Latitude.HasValue)
                {
                    <text>document.getElementById("NewLocationLatitude").value = @Model.Location.Latitude.Value;</text>
                }
                @if (Model.Location.Longitude.HasValue)
                {
                    <text>document.getElementById("NewLocationLongitude").value = @Model.Location.Longitude.Value;</text>
                }
                @if (!string.IsNullOrEmpty(Model.Location.Description))
                {
                    <text>document.getElementById("NewLocationDescription").value = "@Html.Raw(Model.Location.Description.Replace("\"", "\\\"").Replace("\n", "\\n"))";</text>
                }
            }

            // Set existing location if available - NO TIMEOUT NEEDED NOW
            @if (Model.Location != null && Model.Location.Latitude.HasValue && Model.Location.Longitude.HasValue)
            {
                <text>
                const lat = @Model.Location.Latitude.Value;
                const lng = @Model.Location.Longitude.Value;
                
                // Set map view to location
                map.setView([lat, lng], 13);
                
                // Add marker
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }
                currentMarker = L.marker([lat, lng], { draggable: true }).addTo(map);
                
                // Update marker on drag
                currentMarker.on('dragend', function(e) {
                    const position = e.target.getLatLng();
                    document.getElementById("NewLocationLatitude").value = position.lat;
                    document.getElementById("NewLocationLongitude").value = position.lng;
                    debouncedReverseGeocode(position.lat, position.lng);
                });
                </text>
            }

            // Pre-select services
            @if (Model.TourServices != null && Model.TourServices.Any())
            {
                <text>
                const selectedServices = [@Html.Raw(string.Join(",", Model.TourServices.Select(ts => "'" + ts.ServiceID + "'")))];
                selectedServices.forEach(serviceId => {
                    const checkbox = document.querySelector(`input[type="checkbox"][value="${serviceId}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                </text>
            }

            // Set indices for dynamic forms
            let instanceIndex = @(Model.TourInstances != null && Model.TourInstances.Any() ? Model.TourInstances.Count : 0);
            let priceIndex = @(Model.TourPrices != null && Model.TourPrices.Any() ? Model.TourPrices.Count : 0);
            let itineraryIndex = @(Model.Itineraries != null && Model.Itineraries.Any() ? Model.Itineraries.Count : 0);

            // Add instances
            document.getElementById('add-instance').addEventListener('click', function() {
                const container = document.getElementById('tour-instances-container');
                // Count existing items for correct indexing
                const nextIndex = container.querySelectorAll('.tour-instance-item').length;
                
                const newItem = document.createElement('div');
                newItem.className = 'tour-instance-item mb-4 p-3 border rounded bg-light';
                newItem.innerHTML = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-calendar-check text-success me-1"></i>Ngày bắt đầu</label>
                            <input type="date" name="TourInstances[${nextIndex}].StartDate" class="form-control" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-calendar-xmark text-danger me-1"></i>Ngày kết thúc</label>
                            <input type="date" name="TourInstances[${nextIndex}].EndDate" class="form-control" required />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-users text-info me-1"></i>Sức chứa</label>
                            <input type="number" name="TourInstances[${nextIndex}].Capacity" class="form-control" min="0" value="20" required />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-dollar-sign text-warning me-1"></i>Giá cơ bản</label>
                            <input type="number" name="TourInstances[${nextIndex}].PriceBase" class="form-control" min="0" step="0.01" value="0" required />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-user-tie text-primary me-1"></i>Hướng dẫn viên</label>
                            <select name="TourInstances[${nextIndex}].GuideID" class="form-select">
                                <option value="">-- Chọn HDV --</option>
                                @if (guides != null)
                                {
                                    foreach (var guide in guides)
                                    {
                                        <option value="@guide.UserID">@guide.FullName</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-sm btn-danger remove-instance">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                `;
                container.appendChild(newItem);
            });

            // Add prices
            document.getElementById('add-price').addEventListener('click', function() {
                const container = document.getElementById('tour-prices-container');
                // Count existing items for correct indexing
                const nextIndex = container.querySelectorAll('.tour-price-item').length;
                
                const newItem = document.createElement('div');
                newItem.className = 'tour-price-item mb-3 p-3 border rounded bg-light';
                newItem.innerHTML = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-tag text-primary me-1"></i>Loại giá</label>
                            <select name="TourPrices[${nextIndex}].PriceType" class="form-select" required>
                                <option value="Người lớn">Người lớn</option>
                                <option value="Trẻ em">Trẻ em</option>
                                <option value="Người cao tuổi">Người cao tuổi</option>
                                <option value="Sinh viên">Sinh viên</option>
                                <option value="Nhóm">Nhóm</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-money-bill-wave text-success me-1"></i>Số tiền</label>
                            <input type="number" name="TourPrices[${nextIndex}].Amount" class="form-control" min="0" step="0.01" required />
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-sm btn-danger remove-price">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                `;
                container.appendChild(newItem);
            });

            // Add itineraries
            document.getElementById('add-itinerary').addEventListener('click', function() {
                const container = document.getElementById('itineraries-container');
                // Count existing items for correct indexing
                const nextIndex = container.querySelectorAll('.itinerary-item').length;
                
                const newItem = document.createElement('div');
                newItem.className = 'itinerary-item mb-3 p-3 border rounded bg-light';
                newItem.innerHTML = `
                    <div class="row">
                        <div class="col-md-2 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-hashtag text-primary me-1"></i>Ngày thứ</label>
                            <input type="number" name="Itineraries[${nextIndex}].DayIndex" class="form-control" min="1" required />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-heading text-info me-1"></i>Tiêu đề</label>
                            <input type="text" name="Itineraries[${nextIndex}].Title" class="form-control" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-align-left text-success me-1"></i>Mô tả</label>
                            <textarea name="Itineraries[${nextIndex}].Description" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-sm btn-danger remove-itinerary">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                `;
                container.appendChild(newItem);
            });

            // Remove items
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-instance') || e.target.parentElement.classList.contains('remove-instance')) {
                    e.target.closest('.tour-instance-item').remove();
                }
                else if (e.target.classList.contains('remove-price') || e.target.parentElement.classList.contains('remove-price')) {
                    e.target.closest('.tour-price-item').remove();
                }
                else if (e.target.classList.contains('remove-itinerary') || e.target.parentElement.classList.contains('remove-itinerary')) {
                    e.target.closest('.itinerary-item').remove();
                }
            });

            function reverseGeocode(lat, lng) {
                // Show loading state
                const nameField = document.getElementById("NewLocationName");
                const addressField = document.getElementById("NewLocationAddress");
                const cityField = document.getElementById("city");
                const countryField = document.getElementById("countryName");
                
                nameField.value = "Đang tải...";
                addressField.value = "Đang tải...";
                cityField.value = "Đang tải...";
                countryField.value = "Đang tải...";
                
                fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'TourViet-App/1.0'
                    }
                })
                    .then(res => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .then(data => {
                        console.log('Reverse geocoding response:', data);
                        
                        if (data && data.address) {
                            const address = data.address;
                            
                            // Set location name - try various fields
                            let locationName = address.tourism || 
                                             address.amenity || 
                                             address.historic ||
                                             address.shop ||
                                             address.building ||
                                             address.road ||
                                             address.neighbourhood ||
                                             address.suburb ||
                                             address.village ||
                                             address.town ||
                                             address.city ||
                                             data.display_name?.split(',')[0]?.trim() ||
                                             'Địa điểm không tên';
                            nameField.value = locationName;
                            
                            // Set full address
                            addressField.value = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                            
                            // Set city - try multiple address components
                            let city = address.city || 
                                      address.town || 
                                      address.village || 
                                      address.municipality || 
                                      address.county ||
                                      address.state ||
                                      '';
                            cityField.value = city;
                            
                            // Set country
                            if (address.country) {
                                countryField.value = address.country;
                            } else {
                                countryField.value = 'Không xác định';
                            }
                        } else {
                            // No address data - set coordinate-based values
                            nameField.value = `Vị trí ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                            addressField.value = `Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                            cityField.value = '';
                            countryField.value = 'Không xác định';
                            console.warn('No address data returned from geocoding');
                        }
                    })
                    .catch(error => {
                        console.error('Reverse geocoding error:', error);
                        
                        // Fallback values on error
                        nameField.value = `Vị trí ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                        addressField.value = `Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        cityField.value = '';
                        countryField.value = 'Không xác định';
                        
                        // Show user-friendly error (non-blocking)
                        if (typeof showAlert === 'function') {
                            showAlert('warning', 'Không thể tự động điền địa chỉ. Vui lòng nhập thủ công.');
                        }
                    });
            }

            // Create debounced version of reverseGeocode
            // 1000ms delay to be safe with Nominatim limits
            const debouncedReverseGeocode = debounce(reverseGeocode, 1000);

            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }
                
                currentMarker = L.marker([lat, lng], {draggable: true}).addTo(map)
                    .bindPopup(`Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}`)
                    .openPopup();
                
                document.getElementById("NewLocationLatitude").value = lat;
                document.getElementById("NewLocationLongitude").value = lng;
                
                debouncedReverseGeocode(lat, lng);
                
                currentMarker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    
                    document.getElementById("NewLocationLatitude").value = position.lat;
                    document.getElementById("NewLocationLongitude").value = position.lng;
                    
                    debouncedReverseGeocode(position.lat, position.lng);
                    
                    marker.bindPopup(`Tọa độ: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`).openPopup();
                });
            });

            // ========== REAL-TIME IMAGE MANAGEMENT ==========
            
            const tourId = '@Model.TourID';
            const dropZone = document.getElementById('edit-drop-zone');
            const fileInput = document.getElementById('files');
            const uploadProgress = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-progress-bar');
            const uploadStatus = document.getElementById('upload-status');
            const currentImagesGrid = document.getElementById('current-images-grid');
            const imageCountSpan = document.getElementById('current-image-count');

            // Get CSRF token
            function getAntiForgeryToken() {
                return document.querySelector('input[name="__RequestVerificationToken"]').value;
            }

            // Button to trigger file selection
            const editSelectFilesBtn = document.getElementById('edit-select-files-btn');
            editSelectFilesBtn.addEventListener('click', function() {
                fileInput.click();
            });

            // File validation
            function isValidImageFile(file) {
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                const maxSize = 10 * 1024 * 1024; // 10MB
                
                if (!validTypes.includes(file.type)) {
                    alert(`File "${file.name}" không phải là hình ảnh hợp lệ.`);
                    return false;
                }
                
                if (file.size > maxSize) {
                    alert(`File "${file.name}" quá lớn. Kích thước tối đa là 10MB.`);
                    return false;
                }
                
                return true;
            }

            // Upload images via AJAX
            async function uploadImages(files) {
                const validFiles = Array.from(files).filter(isValidImageFile);
                
                if (validFiles.length === 0) return;
                
                const formData = new FormData();
                formData.append('tourId', tourId);
                formData.append('__RequestVerificationToken', getAntiForgeryToken());
                
                validFiles.forEach(file => {
                    formData.append('files', file);
                });
                
                // Show progress
                uploadProgress.classList.remove('d-none');
                progressBar.style.width = '0%';
                uploadStatus.textContent = `Đang upload ${validFiles.length} ảnh...`;
                
                try {
                    const response = await fetch('/TourImage/Upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        progressBar.style.width = '100%';
                        uploadStatus.textContent = result.message;
                        
                        // Add new images to UI
                        result.images.forEach(image => {
                            addImageToGrid(image);
                        });
                        
                        // Update image count
                        updateImageCount();
                        
                        // Hide progress after delay
                        setTimeout(() => {
                            uploadProgress.classList.add('d-none');
                            progressBar.style.width = '0%';
                        }, 2000);
                        
                        // Show success alert
                        showAlert('success', result.message);
                    } else {
                        uploadProgress.classList.add('d-none');
                        showAlert('danger', result.message || 'Có lỗi xảy ra khi upload ảnh.');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    uploadProgress.classList.add('d-none');
                    showAlert('danger', 'Có lỗi xảy ra khi upload ảnh: ' + error.message);
                }
            }

            // Add image to grid
            function addImageToGrid(image) {
                // Remove "no images" message if exists
                const noImagesAlert = currentImagesGrid.querySelector('.alert-info');
                if (noImagesAlert) {
                    noImagesAlert.closest('.col-12').remove();
                }
                
                const col = document.createElement('div');
                col.className = 'col-md-3';
                col.setAttribute('data-image-id', image.imageId);
                
                col.innerHTML = `
                    <div class="preview-item">
                        <img src="${image.url}" alt="Tour Image">
                        <div class="preview-overlay"></div>
                        <button type="button" class="btn btn-delete-image" 
                                data-image-id="${image.imageId}" 
                                data-image-name="${image.fileName}"
                                title="Xóa ảnh">
                            <span aria-hidden="true">×</span>
                        </button>
                        <div class="preview-info">
                            <small class="d-block text-truncate">${image.fileName}</small>
                            <small class="text-muted">Thứ tự: ${image.sortOrder}</small>
                        </div>
                    </div>
                `;
                
                currentImagesGrid.appendChild(col);
            }

            // Delete image via AJAX
            let pendingDeleteImageId = null;
            let pendingDeleteImageName = null;
            
            async function deleteImage(imageId, imageName) {
                // Store for confirmation
                pendingDeleteImageId = imageId;
                pendingDeleteImageName = imageName;
                
                // Update modal content
                document.getElementById('delete-image-name').textContent = imageName;
                
                // Show modal
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteImageModal'));
                deleteModal.show();
            }
            
            // Confirm delete in modal
            document.getElementById('confirm-delete-image').addEventListener('click', async function() {
                if (!pendingDeleteImageId) return;
                
                const imageId = pendingDeleteImageId;
                const imageCol = document.querySelector(`[data-image-id="${imageId}"]`);
                if (!imageCol) return;
                
                // Add deleting animation
                imageCol.querySelector('.preview-item').classList.add('deleting');
                
                // Hide modal
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteImageModal'));
                deleteModal.hide();
                
                try {
                    const formData = new FormData();
                    formData.append('imageId', imageId);
                    formData.append('__RequestVerificationToken', getAntiForgeryToken());
                    
                    const response = await fetch('/TourImage/Delete', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Wait for animation to complete
                        setTimeout(() => {
                            imageCol.remove();
                            updateImageCount();
                            
                            // Show "no images" message if grid is empty
                            if (currentImagesGrid.children.length === 0) {
                                currentImagesGrid.innerHTML = `
                                    <div class="col-12">
                                        <div class="alert alert-info text-center mb-0">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Chưa có hình ảnh nào. Upload ảnh mới bên dưới.
                                        </div>
                                    </div>
                                `;
                            }
                        }, 300);
                        
                        showAlert('success', result.message);
                    } else {
                        imageCol.querySelector('.preview-item').classList.remove('deleting');
                        showAlert('danger', result.message || 'Không thể xóa ảnh.');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    imageCol.querySelector('.preview-item').classList.remove('deleting');
                    showAlert('danger', 'Có lỗi xảy ra khi xóa ảnh: ' + error.message);
                }
                
                // Clear pending
                pendingDeleteImageId = null;
                pendingDeleteImageName = null;
            });

            // Update image count
            function updateImageCount() {
                const count = currentImagesGrid.querySelectorAll('[data-image-id]').length;
                imageCountSpan.textContent = count + ' ảnh';
            }

            // Show alert message
            function showAlert(type, message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insert at top of page
                const container = document.querySelector('.container-fluid');
                container.insertBefore(alertDiv, container.firstChild);
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }

            // Event: File input change
            fileInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    const filesArray = Array.from(e.target.files);
                    uploadImages(filesArray);
                    
                    // Clear value after processing to allow re-selecting
                    setTimeout(() => {
                        e.target.value = '';
                    }, 50);
                }
            });

            // Event: Delete button click
            document.addEventListener('click', function(e) {
                const deleteBtn = e.target.closest('.btn-delete-image');
                if (deleteBtn) {
                    const imageId = deleteBtn.getAttribute('data-image-id');
                    const imageName = deleteBtn.getAttribute('data-image-name');
                    deleteImage(imageId, imageName);
                }
            });

            // Drag and drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, function() {
                    dropZone.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, function() {
                    dropZone.classList.remove('drag-over');
                }, false);
            });

            dropZone.addEventListener('drop', function(e) {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadImages(Array.from(files));
                }
            }, false);

            // Click on drop zone to trigger file input (but not on button)
            dropZone.addEventListener('click', function(e) {
                if (!e.target.closest('#edit-select-files-btn')) {
                    fileInput.click();
                }
            });

            // Function to reindex array fields to ensure consecutive indices
            function reindexArrayFields() {
                // Reindex TourInstances
                const instanceContainers = document.querySelectorAll('#tour-instances-container .tour-instance-item');
                instanceContainers.forEach((container, newIndex) => {
                    const inputs = container.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        const name = input.getAttribute('name');
                        if (name && name.startsWith('TourInstances[')) {
                            const newName = name.replace(/TourInstances\[\d+\]/, `TourInstances[${newIndex}]`);
                            input.setAttribute('name', newName);
                        }
                    });
                });

                // Reindex TourPrices
                const priceContainers = document.querySelectorAll('#tour-prices-container .tour-price-item');
                priceContainers.forEach((container, newIndex) => {
                    const inputs = container.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        const name = input.getAttribute('name');
                        if (name && name.startsWith('TourPrices[')) {
                            const newName = name.replace(/TourPrices\[\d+\]/, `TourPrices[${newIndex}]`);
                            input.setAttribute('name', newName);
                        }
                    });
                });

                // Reindex Itineraries
                const itineraryContainers = document.querySelectorAll('#itineraries-container .itinerary-item');
                itineraryContainers.forEach((container, newIndex) => {
                    const inputs = container.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        const name = input.getAttribute('name');
                        if (name && name.startsWith('Itineraries[')) {
                            const newName = name.replace(/Itineraries\[\d+\]/, `Itineraries[${newIndex}]`);
                            input.setAttribute('name', newName);
                        }
                    });
                });
            }

            // Attach reindexing to FORM SUBMIT to ensure it runs before validation/submit
            const editForm = document.querySelector('form');
            
            if (editForm) {
                editForm.addEventListener('submit', function() {
                    reindexArrayFields();
                });
            }
        })(); // End IIFE
    </script>
}