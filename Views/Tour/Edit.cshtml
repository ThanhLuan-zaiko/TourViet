@{
    ViewData["Title"] = "Chỉnh sửa Tour";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model TourViet.Models.Tour

@{
    var locations = ViewBag.Locations as IEnumerable<TourViet.Models.Location>;
    var categories = ViewBag.Categories as IEnumerable<TourViet.Models.Category>;
    var guides = ViewBag.Guides as IEnumerable<TourViet.Models.User>;
    var countries = ViewBag.Countries as IEnumerable<TourViet.Models.Country>;
    var services = ViewBag.Services as IEnumerable<TourViet.Models.Service>;
}

<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-1 text-gray-800">
                <i class="fas fa-edit text-primary me-2"></i>Chỉnh Sửa Tour
            </h1>
            <p class="text-muted mb-0">
                <small>Cập nhật thông tin cho tour: @Model.TourName</small>
            </p>
        </div>
        <a asp-controller="Home" asp-action="ManageTours" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Quay lại
        </a>
    </div>

    <form asp-action="Edit" method="post" enctype="multipart/form-data">
        <input type="hidden" asp-for="TourID" />
        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
        
        <!-- Location & Map Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-info text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-map-marked-alt me-2"></i>Quốc Gia & Địa Điểm
                </h6>
            </div>
            <div class="card-body p-4">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="countryName" class="form-label fw-bold">
                            <i class="fas fa-globe text-primary me-1"></i>Quốc gia
                        </label>
                        <input type="text" id="countryName" name="NewCountryName" class="form-control" placeholder="Click vào bản đồ để chọn" readonly />
                    </div>
                    <div class="col-md-6">
                        <label for="city" class="form-label fw-bold">
                            <i class="fas fa-city text-info me-1"></i>Thành phố
                        </label>
                        <input type="text" id="city" name="NewLocationCity" class="form-control" placeholder="Tự động điền từ bản đồ" readonly />
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-map-location-dot text-danger me-1"></i>Chọn vị trí trên bản đồ
                    </label>
                    <div id="map" style="height: 400px; border-radius: 0.5rem; border: 2px solid #e3e6f0;"></div>
                    <small class="text-muted mt-1 d-block">
                        <i class="fas fa-info-circle me-1"></i>
                        Click vào bản đồ để thay đổi vị trí. Marker hiện tại hiển thị địa điểm đã chọn trước đó.
                    </small>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="NewLocationName" class="form-label fw-bold">
                            <i class="fas fa-map-pin text-success me-1"></i>Tên địa điểm
                        </label>
                        <input type="text" id="NewLocationName" name="NewLocationName" class="form-control" readonly />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="NewLocationAddress" class="form-label fw-bold">
                            <i class="fas fa-location-dot text-warning me-1"></i>Địa chỉ cụ thể
                        </label>
                        <input type="text" id="NewLocationAddress" name="NewLocationAddress" class="form-control" readonly />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="NewLocationLatitude" class="form-label fw-bold">Vĩ độ</label>
                        <input type="number" id="NewLocationLatitude" name="NewLocationLatitude" class="form-control" step="any" readonly />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="NewLocationLongitude" class="form-label fw-bold">Kinh độ</label>
                        <input type="number" id="NewLocationLongitude" name="NewLocationLongitude" class="form-control" step="any" readonly />
                    </div>
                </div>

                <div>
                    <label for="NewLocationDescription" class="form-label fw-bold">
                        <i class="fas fa-align-left text-info me-1"></i>Mô tả địa điểm
                    </label>
                    <textarea id="NewLocationDescription" name="NewLocationDescription" class="form-control" rows="2"></textarea>
                </div>
            </div>
        </div>

        <!-- Tour Info Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-primary text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-info-circle me-2"></i>Thông Tin Tour
                </h6>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="TourName" class="form-label fw-bold">
                            <i class="fas fa-tag text-primary me-1"></i>Tên Tour <span class="text-danger">*</span>
                        </label>
                        <input asp-for="TourName" class="form-control" />
                        <span asp-validation-for="TourName" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="Slug" class="form-label fw-bold">
                            <i class="fas fa-link text-info me-1"></i>Slug (URL thân thiện)
                        </label>
                        <input asp-for="Slug" class="form-control" />
                        <span asp-validation-for="Slug" class="text-danger small"></span>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="ShortDescription" class="form-label fw-bold">
                        <i class="fas fa-align-left text-success me-1"></i>Mô tả ngắn
                    </label>
                    <input asp-for="ShortDescription" class="form-control" />
                    <span asp-validation-for="ShortDescription" class="text-danger small"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Description" class="form-label fw-bold">
                        <i class="fas fa-file-alt text-warning me-1"></i>Mô tả chi tiết
                    </label>
                    <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                    <span asp-validation-for="Description" class="text-danger small"></span>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="CategoryID" class="form-label fw-bold">
                            <i class="fas fa-folder text-warning me-1"></i>Danh mục
                        </label>
                        <select asp-for="CategoryID" class="form-select" asp-items="@(categories != null ? new SelectList(categories, "CategoryID", "CategoryName") : new SelectList(new List<TourViet.Models.Category>(), "CategoryID", "CategoryName"))">
                            <option value="">-- Chọn danh mục --</option>
                        </select>
                        <span asp-validation-for="CategoryID" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="DefaultGuideID" class="form-label fw-bold">
                            <i class="fas fa-user-tie text-success me-1"></i>Hướng dẫn viên mặc định
                        </label>
                        <select asp-for="DefaultGuideID" class="form-select" asp-items="@(guides != null ? new SelectList(guides, "UserID", "FullName") : new SelectList(new List<TourViet.Models.User>(), "UserID", "FullName"))">
                            <option value="">-- Chọn hướng dẫn viên --</option>
                        </select>
                        <span asp-validation-for="DefaultGuideID" class="text-danger small"></span>
                    </div>
                </div>

                <div class="form-check p-3 bg-light rounded">
                    <input class="form-check-input" asp-for="IsPublished" />
                    <label class="form-check-label fw-bold">
                        <i class="fas fa-eye text-primary me-1"></i>Đăng tour công khai
                        <small class="d-block text-muted fw-normal">Cho phép khách hàng xem và đặt tour này</small>
                    </label>
                </div>
            </div>
        </div>

        <!-- Tour Instances Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-success text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-calendar-days me-2"></i>Lịch Khởi Hành
                </h6>
            </div>
            <div class="card-body p-4">
                <div id="tour-instances-container">
                    @if (Model.TourInstances != null && Model.TourInstances.Any())
                    {
                        int instIndex = 0;
                        foreach (var instance in Model.TourInstances.OrderBy(i => i.StartDate))
                        {
                            <div class="tour-instance-item mb-4 p-3 border rounded bg-light">
                                <input type="hidden" name="TourInstances[@instIndex].InstanceID" value="@instance.InstanceID" />
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-calendar-check text-success me-1"></i>Ngày bắt đầu</label>
                                        <input type="date" name="TourInstances[@instIndex].StartDate" class="form-control" value="@instance.StartDate.ToString("yyyy-MM-dd")" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-calendar-xmark text-danger me-1"></i>Ngày kết thúc</label>
                                        <input type="date" name="TourInstances[@instIndex].EndDate" class="form-control" value="@instance.EndDate.ToString("yyyy-MM-dd")" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-users text-info me-1"></i>Sức chứa</label>
                                        <input type="number" name="TourInstances[@instIndex].Capacity" class="form-control" min="0" value="@instance.Capacity" />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-dollar-sign text-warning me-1"></i>Giá cơ bản</label>
                                        <input type="number" name="TourInstances[@instIndex].PriceBase" class="form-control" min="0" step="0.01" value="@instance.PriceBase" />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-user-tie text-primary me-1"></i>Hướng dẫn viên</label>
                                        <select name="TourInstances[@instIndex].GuideID" class="form-select" asp-items="@(guides != null ? new SelectList(guides, "UserID", "FullName", instance.GuideID) : new SelectList(new List<TourViet.Models.User>(), "UserID", "FullName"))">
                                            <option value="">-- Chọn HDV --</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger remove-instance"><i class="fas fa-trash me-1"></i>Xóa</button>
                            </div>
                            instIndex++;
                        }
                    }
                </div>
                <button type="button" class="btn btn-outline-success" id="add-instance">
                    <i class="fas fa-plus me-1"></i>Thêm lịch khởi hành
                </button>
            </div>
        </div>

        <!-- Tour Prices Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-warning text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-dollar-sign me-2"></i>Bảng Giá Tour
                </h6>
            </div>
            <div class="card-body p-4">
                <div id="tour-prices-container">
                    @if (Model.TourPrices != null && Model.TourPrices.Any())
                    {
                        int priceIdx = 0;
                        foreach (var price in Model.TourPrices)
                        {
                            <div class="tour-price-item mb-3 p-3 border rounded bg-light">
                                <input type="hidden" name="TourPrices[@priceIdx].TourPriceID" value="@price.TourPriceID" />
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-tag text-info me-1"></i>Loại giá</label>
                                        <input type="text" name="TourPrices[@priceIdx].PriceType" class="form-control" value="@price.PriceType" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-money-bill-wave text-success me-1"></i>Số tiền</label>
                                        <input type="number" name="TourPrices[@priceIdx].Amount" class="form-control" min="0" step="0.01" value="@price.Amount" />
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger remove-price"><i class="fas fa-trash me-1"></i>Xóa</button>
                            </div>
                            priceIdx++;
                        }
                    }
                </div>
                <button type="button" class="btn btn-outline-warning" id="add-price">
                    <i class="fas fa-plus me-1"></i>Thêm loại giá
                </button>
            </div>
        </div>

        <!-- Itineraries Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-danger text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-route me-2"></i>Lịch Trình Chi Tiết
                </h6>
            </div>
            <div class="card-body p-4">
                <div id="itineraries-container">
                    @if (Model.Itineraries != null && Model.Itineraries.Any())
                    {
                        int itinIdx = 0;
                        foreach (var itinerary in Model.Itineraries.OrderBy(i => i.DayIndex))
                        {
                            <div class="itinerary-item mb-3 p-3 border rounded bg-light">
                                <input type="hidden" name="Itineraries[@itinIdx].ItineraryID" value="@itinerary.ItineraryID" />
                                <div class="row">
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-hashtag text-primary me-1"></i>Ngày thứ</label>
                                        <input type="number" name="Itineraries[@itinIdx].DayIndex" class="form-control" min="1" value="@itinerary.DayIndex" />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-heading text-info me-1"></i>Tiêu đề</label>
                                        <input type="text" name="Itineraries[@itinIdx].Title" class="form-control" value="@itinerary.Title" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold"><i class="fas fa-align-left text-success me-1"></i>Mô tả</label>
                                        <textarea name="Itineraries[@itinIdx].Description" class="form-control" rows="2">@itinerary.Description</textarea>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger remove-itinerary"><i class="fas fa-trash me-1"></i>Xóa</button>
                            </div>
                            itinIdx++;
                        }
                    }
                </div>
                <button type="button" class="btn btn-outline-danger" id="add-itinerary">
                    <i class="fas fa-plus me-1"></i>Thêm ngày
                </button>
            </div>
        </div>

        <!-- Services Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-info text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-concierge-bell me-2"></i>Dịch Vụ Kèm Theo
                </h6>
            </div>
            <div class="card-body p-4">
                @if (services != null && services.Any())
                {
                    <div class="row">
                        @for (int i = 0; i < services.Count(); i++)
                        {
                            var service = services.ElementAt(i);
                            var isChecked = Model.TourServices?.Any(ts => ts.ServiceID == service.ServiceID) ?? false;
                            
                            <div class="col-md-6 mb-2">
                                <div class="form-check p-2 bg-light rounded">
                                    <input type="checkbox" name="TourServiceIds" value="@service.ServiceID" class="form-check-input" id="service_@service.ServiceID" @(isChecked ? "checked" : "") />
                                    <label class="form-check-label" for="service_@service.ServiceID">
                                        <strong>@service.ServiceName</strong>
                                        <small class="d-block text-muted">
                                            <i class="fas fa-money-bill-wave me-1"></i>
                                            @service.Price.ToString("N0") @service.Currency
                                        </small>
                                    </label>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Chưa có dịch vụ nào.
                    </div>
                }
            </div>
        </div>

        <!-- Current Images Card -->
        @if (Model.TourImages != null && Model.TourImages.Any())
        {
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-gradient-success text-white py-3">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-images me-2"></i>Hình Ảnh Hiện Tại
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        @foreach (var image in Model.TourImages.OrderBy(i => i.SortOrder))
                        {
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100">
                                    <img src="@image.Url" class="card-img-top" alt="Tour Image" style="height: 180px; object-fit: cover; border-radius: 0.5rem 0.5rem 0 0;">
                                    <div class="card-body p-2 text-center">
                                        @if (image.IsPrimary)
                                        {
                                            <span class="badge bg-primary"><i class="fas fa-star me-1"></i>Ảnh chính</span>
                                        }
                                        <small class="text-muted d-block mt-1">Thứ tự: @image.SortOrder</small>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Các ảnh hiện tại sẽ được giữ lại. Upload ảnh mới bên dưới để bổ sung.
                    </div>
                </div>
            </div>
        }

        <!-- Upload New Images Card -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-warning text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-upload me-2"></i>Thêm Hình Ảnh Mới
                </h6>
            </div>
            <div class="card-body p-4">
                <label for="files" class="form-label fw-bold">
                    <i class="fas fa-folder-open text-primary me-1"></i>Chọn hình ảnh
                </label>
                <input type="file" name="TourImageFiles" id="files" class="form-control" multiple accept="image/*" />
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    Chọn nhiều hình ảnh cùng lúc. Hình ảnh sẽ được chuyển đổi sang WebP.
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <a asp-controller="Home" asp-action="ManageTours" class="btn btn-lg btn-light">
                        <i class="fas fa-times me-2"></i>Hủy bỏ
                    </a>
                    <button type="submit" class="btn btn-lg btn-primary px-5">
                        <i class="fas fa-save me-2"></i>Cập Nhật Tour
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .bg-gradient-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .bg-gradient-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .bg-gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .bg-gradient-danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .form-control:focus,
    .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .card {
        border-radius: 0.5rem;
    }
    
    #map {
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.1);
    }
</style>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Pre-populate location data
            @if (Model.Location != null)
            {
                @if (Model.Location.Country != null)
                {
                    <text>document.getElementById("countryName").value = "@Html.Raw(Model.Location.Country.CountryName.Replace("\"", "\\\""))";</text>
                }
                @if (!string.IsNullOrEmpty(Model.Location.City))
                {
                    <text>document.getElementById("city").value = "@Html.Raw(Model.Location.City.Replace("\"", "\\\""))";</text>
                }
                @if (!string.IsNullOrEmpty(Model.Location.LocationName))
                {
                    <text>document.getElementById("NewLocationName").value = "@Html.Raw(Model.Location.LocationName.Replace("\"", "\\\""))";</text>
                }
                @if (!string.IsNullOrEmpty(Model.Location.Address))
                {
                    <text>document.getElementById("NewLocationAddress").value = "@Html.Raw(Model.Location.Address.Replace("\"", "\\\""))";</text>
                }
                @if (Model.Location.Latitude.HasValue)
                {
                    <text>document.getElementById("NewLocationLatitude").value = @Model.Location.Latitude.Value;</text>
                }
                @if (Model.Location.Longitude.HasValue)
                {
                    <text>document.getElementById("NewLocationLongitude").value = @Model.Location.Longitude.Value;</text>
                }
                @if (!string.IsNullOrEmpty(Model.Location.Description))
                {
                    <text>document.getElementById("NewLocationDescription").value = "@Html.Raw(Model.Location.Description.Replace("\"", "\\\"").Replace("\n", "\\n"))";</text>
                }
            }

            // Pre-select services
            @if (Model.TourServices != null && Model.TourServices.Any())
            {
                <text>
                const selectedServices = [@Html.Raw(string.Join(",", Model.TourServices.Select(ts => "'" + ts.ServiceID + "'")))];
                selectedServices.forEach(serviceId => {
                    const checkbox = document.querySelector(`input[type="checkbox"][value="${serviceId}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                </text>
            }

            // Set indices for dynamic forms
            let instanceIndex = @(Model.TourInstances != null && Model.TourInstances.Any() ? Model.TourInstances.Count : 0);
            let priceIndex = @(Model.TourPrices != null && Model.TourPrices.Any() ? Model.TourPrices.Count : 0);
            let itineraryIndex = @(Model.Itineraries != null && Model.Itineraries.Any() ? Model.Itineraries.Count : 0);

            // Add instances
            document.getElementById('add-instance').addEventListener('click', function() {
                const container = document.getElementById('tour-instances-container');
                const newItem = document.createElement('div');
                newItem.className = 'tour-instance-item mb-4 p-3 border rounded bg-light';
                newItem.innerHTML = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-calendar-check text-success me-1"></i>Ngày bắt đầu</label>
                            <input type="date" name="TourInstances[\${instanceIndex}].StartDate" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-calendar-xmark text-danger me-1"></i>Ngày kết thúc</label>
                            <input type="date" name="TourInstances[\${instanceIndex}].EndDate" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-users text-info me-1"></i>Sức chứa</label>
                            <input type="number" name="TourInstances[\${instanceIndex}].Capacity" class="form-control" min="0" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-dollar-sign text-warning me-1"></i>Giá cơ bản</label>
                            <input type="number" name="TourInstances[\${instanceIndex}].PriceBase" class="form-control" min="0" step="0.01" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-user-tie text-primary me-1"></i>Hướng dẫn viên</label>
                            <select name="TourInstances[\${instanceIndex}].GuideID" class="form-select">
                                <option value="">-- Chọn HDV --</option>
                                @if (guides != null)
                                {
                                    foreach (var guide in guides)
                                    {
                                        <option value="@guide.UserID">@guide.FullName</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-instance"><i class="fas fa-trash me-1"></i>Xóa</button>
                `;
                container.appendChild(newItem);
                instanceIndex++;
            });

            // Add prices
            document.getElementById('add-price').addEventListener('click', function() {
                const container = document.getElementById('tour-prices-container');
                const newItem = document.createElement('div');
                newItem.className = 'tour-price-item mb-3 p-3 border rounded bg-light';
                newItem.innerHTML = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-tag text-info me-1"></i>Loại giá</label>
                            <input type="text" name="TourPrices[\${priceIndex}].PriceType" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-money-bill-wave text-success me-1"></i>Số tiền</label>
                            <input type="number" name="TourPrices[\${priceIndex}].Amount" class="form-control" min="0" step="0.01" />
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-price"><i class="fas fa-trash me-1"></i>Xóa</button>
                `;
                container.appendChild(newItem);
                priceIndex++;
            });

            // Add itineraries
            document.getElementById('add-itinerary').addEventListener('click', function() {
                const container = document.getElementById('itineraries-container');
                const newItem = document.createElement('div');
                newItem.className = 'itinerary-item mb-3 p-3 border rounded bg-light';
                newItem.innerHTML = `
                    <div class="row">
                        <div class="col-md-2 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-hashtag text-primary me-1"></i>Ngày thứ</label>
                            <input type="number" name="Itineraries[\${itineraryIndex}].DayIndex" class="form-control" min="1" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-heading text-info me-1"></i>Tiêu đề</label>
                            <input type="text" name="Itineraries[\${itineraryIndex}].Title" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-align-left text-success me-1"></i>Mô tả</label>
                            <textarea name="Itineraries[\${itineraryIndex}].Description" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-itinerary"><i class="fas fa-trash me-1"></i>Xóa</button>
                `;
                container.appendChild(newItem);
                itineraryIndex++;
            });

            // Remove items
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-instance') || e.target.parentElement.classList.contains('remove-instance')) {
                    e.target.closest('.tour-instance-item').remove();
                }
                else if (e.target.classList.contains('remove-price') || e.target.parentElement.classList.contains('remove-price')) {
                    e.target.closest('.tour-price-item').remove();
                }
                else if (e.target.classList.contains('remove-itinerary') || e.target.parentElement.classList.contains('remove-itinerary')) {
                    e.target.closest('.itinerary-item').remove();
                }
            });

            // Initialize map
            const map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            let currentMarker = null;

            function reverseGeocode(lat, lng) {
                // Show loading state
                const nameField = document.getElementById("NewLocationName");
                const addressField = document.getElementById("NewLocationAddress");
                const cityField = document.getElementById("city");
                const countryField = document.getElementById("countryName");
                
                nameField.value = "Đang tải...";
                addressField.value = "Đang tải...";
                cityField.value = "Đang tải...";
                countryField.value = "Đang tải...";
                
                // Add delay to respect Nominatim usage policy (max 1 request per second)
                setTimeout(() => {
                    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`, {
                        headers: {
                            'User-Agent': 'TourViet-App/1.0'
                        }
                    })
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            }
                            return res.json();
                        })
                        .then(data => {
                            console.log('Reverse geocoding response:', data);
                            
                            if (data && data.address) {
                                const address = data.address;
                                
                                // Set location name - try various fields
                                let locationName = address.tourism || 
                                                 address.amenity || 
                                                 address.historic ||
                                                 address.shop ||
                                                 address.building ||
                                                 address.road ||
                                                 address.neighbourhood ||
                                                 address.suburb ||
                                                 address.village ||
                                                 address.town ||
                                                 address.city ||
                                                 data.display_name?.split(',')[0]?.trim() ||
                                                 'Địa điểm không tên';
                                nameField.value = locationName;
                                
                                // Set full address
                                addressField.value = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                                
                                // Set city - try multiple address components
                                let city = address.city || 
                                          address.town || 
                                          address.village || 
                                          address.municipality || 
                                          address.county ||
                                          address.state ||
                                          '';
                                cityField.value = city;
                                
                                // Set country
                                if (address.country) {
                                    countryField.value = address.country;
                                } else {
                                    countryField.value = 'Không xác định';
                                }
                                
                                console.log('Location fields updated:', {
                                    name: locationName,
                                    address: data.display_name,
                                    city: city,
                                    country: address.country
                                });
                            } else {
                                // No address data - set coordinate-based values
                                nameField.value = `Vị trí ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                                addressField.value = `Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                                cityField.value = '';
                                countryField.value = 'Không xác định';
                                console.warn('No address data returned from geocoding');
                            }
                        })
                        .catch(error => {
                            console.error('Reverse geocoding error:', error);
                            
                            // Fallback values on error
                            nameField.value = `Vị trí ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                            addressField.value = `Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                            cityField.value = '';
                            countryField.value = 'Không xác định';
                            
                            // Show user-friendly error
                            alert('Không thể tự động điền địa chỉ. Vui lòng nhập thủ công hoặc thử lại.');
                        });
                }, 1000); // 1 second delay to respect API rate limits
            }

            // Load existing marker if coordinates exist
            const initialLat = document.getElementById("NewLocationLatitude").value;
            const initialLng = document.getElementById("NewLocationLongitude").value;
            if (initialLat && initialLng) {
                const lat = parseFloat(initialLat);
                const lng = parseFloat(initialLng);
                
                currentMarker = L.marker([lat, lng], {draggable: true}).addTo(map)
                    .bindPopup(`Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}`)
                    .openPopup();
                
                map.setView([lat, lng], 13);
                
                currentMarker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    
                    document.getElementById("NewLocationLatitude").value = position.lat;
                    document.getElementById("NewLocationLongitude").value = position.lng;
                    
                    reverseGeocode(position.lat, position.lng);
                    
                    marker.bindPopup(`Tọa độ: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`).openPopup();
                });
            }

            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }
                
                currentMarker = L.marker([lat, lng], {draggable: true}).addTo(map)
                    .bindPopup(`Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}`)
                    .openPopup();
                
                document.getElementById("NewLocationLatitude").value = lat;
                document.getElementById("NewLocationLongitude").value = lng;
                
                reverseGeocode(lat, lng);
                
                currentMarker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    
                    document.getElementById("NewLocationLatitude").value = position.lat;
                    document.getElementById("NewLocationLongitude").value = position.lng;
                    
                    reverseGeocode(position.lat, position.lng);
                    
                    marker.bindPopup(`Tọa độ: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`).openPopup();
                });
            });
        });
    </script>
}